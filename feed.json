{
  "version": "https://jsonfeed.org/version/1.1",
  "title": "code",
  "home_page_url": "https://x-vic.gitee.io/code/code/",
  "feed_url": "https://x-vic.gitee.io/code/code/feed.json",
  "description": "code",
  "author": {
    "name": "Vic"
  },
  "items": [
    {
      "title": "首页",
      "url": "https://x-vic.gitee.io/code/code/",
      "id": "https://x-vic.gitee.io/code/code/",
      "content_html": "<p><a href=\"./views/vue-next/reactive.html\">Vue 源码学习</a> </p>\n",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "Blob",
      "url": "https://x-vic.gitee.io/code/code/views/JS/",
      "id": "https://x-vic.gitee.io/code/code/views/JS/",
      "content_html": "<h2 id=\"blob-是什么\"> Blob 是什么</h2>\n<blockquote>\n<p>Blob（Binary Large Object）表示二进制类型的大对象。在数据库管理系统中，将二进制数据存储为一个单一个体的集合。Blob 通常是影像、声音或多媒体文件。</p>\n</blockquote>\n<p>Blob 实例包含两个属性：size 和 type。size 表示数据大小，type 是 MIME 类型。Blob 表示的不一定是 JavaScript 原生格式的数据。比如 File 接口基于 Blob，继承了 Blob 的功能，并将其扩展使其支持用户系统上的文件。</p>\n<h2 id=\"blob-api\"> Blob Api</h2>\n<h3 id=\"构造函数\"> 构造函数</h3>\n<div><pre><code><span>const</span> blob <span>=</span> <span>new</span> <span>Blob</span><span>(</span>blobParts<span>,</span> options<span>)</span>\n</code></pre>\n<div><span>1</span><br></div></div><ul>\n<li>blobParts：由 ArrayBuffer，ArrayBufferView，Blob，DOMString等对象构成的数组。</li>\n<li>options：一个可选对象，包含两个属性：\n<ul>\n<li>type---默认值为''，代表 MIME 类型</li>\n<li>endings---默认值为'transparent'，用于指定包含行结束符 \\n 的字符串如何被写入。它是以下两个值中的一个：&quot;native&quot;，代表行结束符会被更改为适合宿主操作系统文件系统的换行符，或者 &quot;transparent&quot;，代表会保持 blob 中保存的结束符不变。</li>\n</ul>\n</li>\n</ul>\n<p>例一：从字符串创建 Blob</p>\n<div><pre><code><span>// </span>\n<span>let</span> myBlobParts <span>=</span> <span>[</span><span>'&lt;html>&lt;h2>Hello Semlinker&lt;/h2>&lt;/html>'</span><span>]</span><span>;</span> <span>// an array consisting of a single DOMString</span>\n<span>let</span> myBlob <span>=</span> <span>new</span> <span>Blob</span><span>(</span>myBlobParts<span>,</span> <span>{</span>type <span>:</span> <span>'text/html'</span><span>,</span> endings<span>:</span> <span>\"transparent\"</span><span>}</span><span>)</span><span>;</span> <span>// the blob</span>\n\nconsole<span>.</span><span>log</span><span>(</span>myBlob<span>.</span>size <span>+</span> <span>\" bytes size\"</span><span>)</span><span>;</span>\n<span>// Output: 37 bytes size</span>\nconsole<span>.</span><span>log</span><span>(</span>myBlob<span>.</span>type <span>+</span> <span>\" is the type\"</span><span>)</span><span>;</span>\n<span>// Output: text/html is the type</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div><p>例二：从类型化数组和字符串创建 Blob</p>\n<div><pre><code><span>let</span> hello <span>=</span> <span>new</span> <span>Uint8Array</span><span>(</span><span>[</span><span>72</span><span>,</span> <span>101</span><span>,</span> <span>108</span><span>,</span> <span>108</span><span>,</span> <span>111</span><span>]</span><span>)</span><span>;</span> <span>// 二进制格式的 \"hello\"</span>\n<span>let</span> blob <span>=</span> <span>new</span> <span>Blob</span><span>(</span><span>[</span>hello<span>,</span> <span>' '</span><span>,</span> <span>'semlinker'</span><span>]</span><span>,</span> <span>{</span>type<span>:</span> <span>'text/plain'</span><span>}</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br></div></div><h3 id=\"方法\"> 方法</h3>\n<ul>\n<li><code>slice([start[, end[, contentType]]])</code> 返回一个新的 Blob 对象，包含了源 Blob 对象中指定范围内的数据</li>\n<li><code>stream()</code> 返回一个能读取 blob 内容的 <code>ReadableStream</code></li>\n<li><code>text()</code> 返回一个 Promise 对象且包含 blob 所有内容的 UTF-8 格式的 <code>USVString</code></li>\n<li><code>arrayBuffer()</code> 返回一个 Promise 对象且包含 blob 所有内容的二进制格式的 <code>ArrayBuffer</code></li>\n</ul>\n<h2 id=\"blob-的使用场景\"> Blob 的使用场景</h2>\n<h3 id=\"分片上传\"> 分片上传</h3>\n<p>File 对象是特殊类型的 Blob，且可以用在任意的 Blob 类型的上下文中。所以针对大文件传输的场景，我们可以使用 slice 方法对大文件进行切割，然后分片进行上传，具体示例如下：</p>\n<div><pre><code><span>const</span> file <span>=</span> <span>new</span> <span>File</span><span>(</span><span>[</span><span>\"a\"</span><span>.</span><span>repeat</span><span>(</span><span>1000000</span><span>)</span><span>]</span><span>,</span> <span>\"test.txt\"</span><span>)</span><span>;</span>\n\n<span>const</span> chunkSize <span>=</span> <span>40000</span><span>;</span>\n<span>const</span> url <span>=</span> <span>\"https://httpbin.org/post\"</span><span>;</span>\n\n<span>async</span> <span>function</span> <span>chunkedUpload</span><span>(</span><span>)</span> <span>{</span>\n  <span>for</span> <span>(</span><span>let</span> start <span>=</span> <span>0</span><span>;</span> start <span>&lt;</span> file<span>.</span>size<span>;</span> start <span>+=</span> chunkSize<span>)</span> <span>{</span>\n    <span>const</span> chunk <span>=</span> file<span>.</span><span>slice</span><span>(</span>start<span>,</span> start <span>+</span> chunkSize <span>+</span> <span>1</span><span>)</span><span>;</span>\n    <span>const</span> fd <span>=</span> <span>new</span> <span>FormData</span><span>(</span><span>)</span><span>;</span>\n    fd<span>.</span><span>append</span><span>(</span><span>\"data\"</span><span>,</span> chunk<span>)</span><span>;</span>\n\n    <span>await</span> <span>fetch</span><span>(</span>url<span>,</span> <span>{</span> method<span>:</span> <span>\"post\"</span><span>,</span> body<span>:</span> fd <span>}</span><span>)</span><span>.</span><span>then</span><span>(</span><span>(</span><span>res</span><span>)</span> <span>=></span>\n      res<span>.</span><span>text</span><span>(</span><span>)</span>\n    <span>)</span><span>;</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><h3 id=\"从互联网下载数据\"> 从互联网下载数据</h3>\n<p>我们可以使用以下方法从互联网上下载数据并将数据存储到 Blob 对象中，比如：</p>\n<div><pre><code><span>const</span> <span>downloadBlob</span> <span>=</span> <span>(</span><span>url<span>,</span> callback</span><span>)</span> <span>=></span> <span>{</span>\n  <span>const</span> xhr <span>=</span> <span>new</span> <span>XMLHttpRequest</span><span>(</span><span>)</span>\n  xhr<span>.</span><span>open</span><span>(</span><span>'GET'</span><span>,</span> url<span>)</span>\n  xhr<span>.</span>responseType <span>=</span> <span>'blob'</span>\n  xhr<span>.</span><span>onload</span> <span>=</span> <span>(</span><span>)</span> <span>=></span> <span>{</span>\n    <span>callback</span><span>(</span>xhr<span>.</span>response<span>)</span>\n  <span>}</span>\n  xhr<span>.</span><span>send</span><span>(</span><span>null</span><span>)</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br></div></div><p>除了使用 <code>XMLHttpRequest</code> API 之外，我们也可以使用 fetch API 来实现以流的方式获取二进制数据。这里我们来看一下如何使用 <code>fetch</code> API 获取线上图片并本地显示，具体实现如下：</p>\n<div><pre><code><span>const</span> myImage <span>=</span> document<span>.</span><span>querySelector</span><span>(</span><span>'img'</span><span>)</span>\n<span>const</span> myRequest <span>=</span> <span>new</span> <span>Request</span><span>(</span><span>'flowers.jpg'</span><span>)</span>\n\n<span>fetch</span><span>(</span>myRequest<span>)</span>\n  <span>.</span><span>then</span><span>(</span><span>function</span><span>(</span><span>response</span><span>)</span> <span>{</span>\n    <span>return</span> response<span>.</span><span>blob</span><span>(</span><span>)</span>\n  <span>}</span><span>)</span>\n <span>.</span><span>then</span><span>(</span><span>function</span><span>(</span><span>myBlob</span><span>)</span> <span>{</span>\n   <span>let</span> objectURL <span>=</span> <span>URL</span><span>.</span><span>createObjectURL</span><span>(</span>myBlob<span>)</span>\n   myImage<span>.</span>src <span>=</span> objectURL\n<span>}</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><p>当 fetch 请求成功的时候，我们调用 response 对象的 <code>blob()</code> 方法，从 response 对象中读取一个 Blob 对象，然后使用 <code>createObjectURL()</code> 方法创建一个 objectURL，然后把它赋值给 <code>img</code> 元素的 <code>src</code> 属性从而显示这张图片。</p>\n<h3 id=\"blob-用作-url\"> Blob 用作 URL</h3>\n<p>Blob 文件下载示例：</p>\n<div><pre><code><span>const</span> <span>download</span> <span>=</span> <span>(</span><span>fileName<span>,</span> blob</span><span>)</span> <span>=></span> <span>{</span>\n  <span>const</span> link <span>=</span> document<span>.</span><span>createElement</span><span>(</span><span>\"a\"</span><span>)</span><span>;</span>\n  <span>// 将 Blob 对象转换成 url</span>\n  link<span>.</span>href <span>=</span> <span>URL</span><span>.</span><span>createObjectURL</span><span>(</span>blob<span>)</span><span>;</span>\n  link<span>.</span>download <span>=</span> fileName<span>;</span>\n  link<span>.</span><span>click</span><span>(</span><span>)</span><span>;</span>\n  link<span>.</span><span>remove</span><span>(</span><span>)</span><span>;</span>\n  <span>// 释放 Blob 对象</span>\n  <span>URL</span><span>.</span><span>revokeObjectURL</span><span>(</span>link<span>.</span>href<span>)</span><span>;</span>\n<span>}</span><span>;</span>\n\n<span>const</span> downloadBtn <span>=</span> document<span>.</span><span>querySelector</span><span>(</span><span>\"#downloadBtn\"</span><span>)</span><span>;</span>\ndownloadBtn<span>.</span><span>addEventListener</span><span>(</span><span>\"click\"</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=></span> <span>{</span>\n  <span>const</span> fileName <span>=</span> <span>\"blob.txt\"</span><span>;</span>\n  <span>const</span> myBlob <span>=</span> <span>new</span> <span>Blob</span><span>(</span><span>[</span><span>'详解Blob'</span><span>]</span><span>,</span> <span>{</span> type<span>:</span> <span>\"text/plain\"</span> <span>}</span><span>)</span><span>;</span>\n  <span>download</span><span>(</span>fileName<span>,</span> myBlob<span>)</span><span>;</span>\n<span>}</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br></div></div><h3 id=\"blob-转换为-base64\"> Blob 转换为 Base64</h3>\n<p><code>URL.createObjectURL</code> 的一个替代方法是，将 <code>Blob</code> 转换为 base64 编码的字符串。<code>Base64</code> 是一种基于 64 个可打印字符来表示二进制数据的表示方法。<br>\n利用 FileReader API，我们也可以方便的实现图片本地预览功能，具体代码如下：</p>\n<div><pre><code><span><span><span>&lt;</span>input</span> <span>type</span><span><span>=</span><span>\"</span>file<span>\"</span></span> <span>accept</span><span><span>=</span><span>\"</span>image/*<span>\"</span></span> <span>onchange</span><span><span>=</span><span>\"</span>loadFile(event)<span>\"</span></span><span>></span></span>\n<span><span><span>&lt;</span>img</span> <span>id</span><span><span>=</span><span>\"</span>output<span>\"</span></span><span>/></span></span>\n\n<span><span><span>&lt;</span>script</span><span>></span></span><span><span>\n  <span>const</span> <span>loadFile</span> <span>=</span> <span>function</span><span>(</span><span>event</span><span>)</span> <span>{</span>\n    <span>const</span> reader <span>=</span> <span>new</span> <span>FileReader</span><span>(</span><span>)</span><span>;</span>\n    reader<span>.</span><span>onload</span> <span>=</span> <span>function</span><span>(</span><span>)</span><span>{</span>\n      <span>const</span> output <span>=</span> document<span>.</span><span>querySelector</span><span>(</span><span>'output'</span><span>)</span><span>;</span>\n      output<span>.</span>src <span>=</span> reader<span>.</span>result<span>;</span>\n    <span>}</span><span>;</span>\n    <span>// Blob 转 Base64</span>\n    reader<span>.</span><span>readAsDataURL</span><span>(</span>event<span>.</span>target<span>.</span>files<span>[</span><span>0</span><span>]</span><span>)</span><span>;</span>\n  <span>}</span><span>;</span>\n</span></span><span><span><span>&lt;/</span>script</span><span>></span></span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br></div></div><p>在完成本地图片预览之后，我们可以直接把图片对应的 Data URLs 数据提交到服务器。针对这种情形，服务端需要做一些相关处理，才能正常保存上传的图片，这里以 Express 为例，具体处理代码如下：</p>\n<div><pre><code><span>const</span> app <span>=</span> <span>require</span><span>(</span><span>'express'</span><span>)</span><span>(</span><span>)</span><span>;</span>\n\napp<span>.</span><span>post</span><span>(</span><span>'/upload'</span><span>,</span> <span>function</span><span>(</span><span>req<span>,</span> res</span><span>)</span><span>{</span>\n    <span>let</span> imgData <span>=</span> req<span>.</span>body<span>.</span>imgData<span>;</span> <span>// 获取POST请求中的base64图片数据</span>\n    <span>let</span> base64Data <span>=</span> imgData<span>.</span><span>replace</span><span>(</span><span><span>/</span><span>^data:image\\/\\w+;base64,</span><span>/</span></span><span>,</span> <span>\"\"</span><span>)</span><span>;</span>\n    <span>let</span> dataBuffer <span>=</span> Buffer<span>.</span><span>from</span><span>(</span>base64Data<span>,</span> <span>'base64'</span><span>)</span><span>;</span>\n    fs<span>.</span><span>writeFile</span><span>(</span><span>\"image.png\"</span><span>,</span> dataBuffer<span>,</span> <span>function</span><span>(</span><span>err</span><span>)</span> <span>{</span>\n      <span>if</span><span>(</span>err<span>)</span><span>{</span>\n        res<span>.</span><span>send</span><span>(</span>err<span>)</span><span>;</span>\n      <span>}</span><span>else</span><span>{</span>\n        res<span>.</span><span>send</span><span>(</span><span>\"图片上传成功！\"</span><span>)</span><span>;</span>\n      <span>}</span>\n    <span>}</span><span>)</span><span>;</span>\n<span>}</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br></div></div><p>对于 FileReader 对象来说，除了支持把 Blob/File 对象转换为 Data URL 之外，它还提供了 <code>readAsArrayBuffer()</code> 和 <code>readAsText()</code> 方法，用于把 Blob/File 对象转换为其它的数据格式。这里我们来看个 <code>readAsArrayBuffer()</code> 的使用示例：</p>\n<div><pre><code><span>// 从 blob 获取 arrayBuffer</span>\n<span>let</span> fileReader <span>=</span> <span>new</span> <span>FileReader</span><span>(</span><span>)</span>\n\nfileReader<span>.</span><span>onload</span> <span>=</span> <span>function</span><span>(</span><span>event</span><span>)</span> <span>{</span>\n  <span>let</span> arrayBuffer <span>=</span> fileReader<span>.</span>result\n<span>}</span>\nfileReader<span>.</span><span>readAsArrayBuffer</span><span>(</span>blob<span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><h3 id=\"图片压缩\"> 图片压缩</h3>\n<p>在一些场合中，我们希望在上传本地图片时，先对图片进行一定的压缩，然后再提交到服务器，从而减少传输的数据量。在前端要实现图片压缩，我们可以利用 Canvas 对象提供的 <code>toDataURL()</code> 方法，该方法接收 <code>type</code> 和 <code>encoderOptions</code> 两个可选参数。</p>\n<p>其中 <code>type</code> 表示图片格式，默认为 <code>image/png</code>。而 <code>encoderOptions</code> 用于表示图片的质量，在指定图片格式为 <code>image/jpeg</code> 或 <code>image/webp</code> 的情况下，可以从 0 到 1 的区间内选择图片的质量。如果超出取值范围，将会使用默认值 <code>0.92</code>，其他参数会被忽略。</p>\n<p>下面我们来看一下具体如何实现图片压缩：</p>\n<div><pre><code><span>// compress.js</span>\n<span>const</span> <span>MAX_WIDTH</span> <span>=</span> <span>800</span><span>;</span> <span>// 图片最大宽度</span>\n\n<span>function</span> <span>compress</span><span>(</span><span>base64<span>,</span> quality<span>,</span> mimeType</span><span>)</span> <span>{</span>\n  <span>let</span> canvas <span>=</span> document<span>.</span><span>createElement</span><span>(</span><span>\"canvas\"</span><span>)</span><span>;</span>\n  <span>let</span> img <span>=</span> document<span>.</span><span>createElement</span><span>(</span><span>\"img\"</span><span>)</span><span>;</span>\n  img<span>.</span>crossOrigin <span>=</span> <span>\"anonymous\"</span><span>;</span>\n  <span>return</span> <span>new</span> <span>Promise</span><span>(</span><span>(</span><span>resolve<span>,</span> reject</span><span>)</span> <span>=></span> <span>{</span>\n    img<span>.</span>src <span>=</span> base64<span>;</span>\n    img<span>.</span><span>onload</span> <span>=</span> <span>(</span><span>)</span> <span>=></span> <span>{</span>\n      <span>let</span> targetWidth<span>,</span> targetHeight<span>;</span>\n      <span>if</span> <span>(</span>img<span>.</span>width <span>></span> <span>MAX_WIDTH</span><span>)</span> <span>{</span>\n        targetWidth <span>=</span> <span>MAX_WIDTH</span><span>;</span>\n        targetHeight <span>=</span> <span>(</span>img<span>.</span>height <span>*</span> <span>MAX_WIDTH</span><span>)</span> <span>/</span> img<span>.</span>width<span>;</span>\n      <span>}</span> <span>else</span> <span>{</span>\n        targetWidth <span>=</span> img<span>.</span>width<span>;</span>\n        targetHeight <span>=</span> img<span>.</span>height<span>;</span>\n      <span>}</span>\n      canvas<span>.</span>width <span>=</span> targetWidth<span>;</span>\n      canvas<span>.</span>height <span>=</span> targetHeight<span>;</span>\n      <span>let</span> ctx <span>=</span> canvas<span>.</span><span>getContext</span><span>(</span><span>\"2d\"</span><span>)</span><span>;</span>\n      ctx<span>.</span><span>clearRect</span><span>(</span><span>0</span><span>,</span> <span>0</span><span>,</span> targetWidth<span>,</span> targetHeight<span>)</span><span>;</span> <span>// 清除画布</span>\n      ctx<span>.</span><span>drawImage</span><span>(</span>img<span>,</span> <span>0</span><span>,</span> <span>0</span><span>,</span> canvas<span>.</span>width<span>,</span> canvas<span>.</span>height<span>)</span><span>;</span>\n      <span>let</span> imageData <span>=</span> canvas<span>.</span><span>toDataURL</span><span>(</span>mimeType<span>,</span> quality <span>/</span> <span>100</span><span>)</span><span>;</span>\n      <span>resolve</span><span>(</span>imageData<span>)</span><span>;</span>\n    <span>}</span><span>;</span>\n  <span>}</span><span>)</span><span>;</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br></div></div><p>对于返回的 Data URL 格式的图片数据，为了进一步减少传输的数据量，我们可以把它转换为 Blob 对象：</p>\n<div><pre><code><span>function</span> <span>dataUrlToBlob</span><span>(</span><span>base64<span>,</span> mimeType</span><span>)</span> <span>{</span>\n  <span>let</span> bytes <span>=</span> window<span>.</span><span>atob</span><span>(</span>base64<span>.</span><span>split</span><span>(</span><span>\",\"</span><span>)</span><span>[</span><span>1</span><span>]</span><span>)</span><span>;</span>\n  <span>let</span> ab <span>=</span> <span>new</span> <span>ArrayBuffer</span><span>(</span>bytes<span>.</span>length<span>)</span><span>;</span>\n  <span>let</span> ia <span>=</span> <span>new</span> <span>Uint8Array</span><span>(</span>ab<span>)</span><span>;</span>\n  <span>for</span> <span>(</span><span>let</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> bytes<span>.</span>length<span>;</span> i<span>++</span><span>)</span> <span>{</span>\n    ia<span>[</span>i<span>]</span> <span>=</span> bytes<span>.</span><span>charCodeAt</span><span>(</span>i<span>)</span><span>;</span>\n  <span>}</span>\n  <span>return</span> <span>new</span> <span>Blob</span><span>(</span><span>[</span>ab<span>]</span><span>,</span> <span>{</span> type<span>:</span> mimeType <span>}</span><span>)</span><span>;</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br></div></div><p>在转换完成后，我们就可以压缩后的图片对应的 Blob 对象封装在 FormData 对象中，然后再通过 AJAX 提交到服务器上：</p>\n<div><pre><code><span>function</span> <span>uploadFile</span><span>(</span><span>url<span>,</span> blob</span><span>)</span> <span>{</span>\n  <span>let</span> formData <span>=</span> <span>new</span> <span>FormData</span><span>(</span><span>)</span><span>;</span>\n  <span>let</span> request <span>=</span> <span>new</span> <span>XMLHttpRequest</span><span>(</span><span>)</span><span>;</span>\n  formData<span>.</span><span>append</span><span>(</span><span>\"image\"</span><span>,</span> blob<span>)</span><span>;</span>\n  request<span>.</span><span>open</span><span>(</span><span>\"POST\"</span><span>,</span> url<span>,</span> <span>true</span><span>)</span><span>;</span>\n  request<span>.</span><span>send</span><span>(</span>formData<span>)</span><span>;</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><p>其实 Canvas 对象除了提供 toDataURL() 方法之外，它还提供了一个 toBlob() 方法，该方法的语法如下：</p>\n<div><p>Tips</p>\n<p><code>canvas.toBlob(callback, mimeType, qualityArgument)</code></p>\n</div>\n<p>和 <code>toDataURL()</code> 方法相比，<code>toBlob()</code> 方法是异步的，因此多了个 <code>callback</code> 参数，这个 <code>callback</code> 回调方法默认的第一个参数就是转换好的 <code>blob</code> 文件信息。<br>\n介绍完上述的内容，我们来看一下本地图片压缩完整的示例：</p>\n<div><pre><code><span><span>&lt;!</span><span>DOCTYPE</span> <span>html</span><span>></span></span>\n<span><span><span>&lt;</span>html</span><span>></span></span>\n  <span><span><span>&lt;</span>head</span><span>></span></span>\n    <span><span><span>&lt;</span>meta</span> <span>charset</span><span><span>=</span><span>\"</span>UTF-8<span>\"</span></span> <span>/></span></span>\n    <span><span><span>&lt;</span>meta</span> <span>name</span><span><span>=</span><span>\"</span>viewport<span>\"</span></span> <span>content</span><span><span>=</span><span>\"</span>width=device-width, initial-scale=1.0<span>\"</span></span> <span>/></span></span>\n    <span><span><span>&lt;</span>title</span><span>></span></span>本地图片压缩<span><span><span>&lt;/</span>title</span><span>></span></span>\n  <span><span><span>&lt;/</span>head</span><span>></span></span>\n  <span><span><span>&lt;</span>body</span><span>></span></span>\n    <span><span><span>&lt;</span>input</span> <span>type</span><span><span>=</span><span>\"</span>file<span>\"</span></span> <span>accept</span><span><span>=</span><span>\"</span>image/*<span>\"</span></span> <span>onchange</span><span><span>=</span><span>\"</span>loadFile(event)<span>\"</span></span> <span>/></span></span>\n    <span><span><span>&lt;</span>script</span> <span>src</span><span><span>=</span><span>\"</span>./compress.js<span>\"</span></span><span>></span></span><span></span><span><span><span>&lt;/</span>script</span><span>></span></span>\n    <span><span><span>&lt;</span>script</span><span>></span></span><span><span>\n      <span>const</span> <span>loadFile</span> <span>=</span> <span>function</span> <span>(</span><span>event</span><span>)</span> <span>{</span>\n        <span>const</span> reader <span>=</span> <span>new</span> <span>FileReader</span><span>(</span><span>)</span><span>;</span>\n        reader<span>.</span><span>onload</span> <span>=</span> <span>async</span> <span>function</span> <span>(</span><span>)</span> <span>{</span>\n          <span>let</span> compressedDataURL <span>=</span> <span>await</span> <span>compress</span><span>(</span>\n            reader<span>.</span>result<span>,</span>\n            <span>90</span><span>,</span>\n            <span>\"image/jpeg\"</span>\n          <span>)</span><span>;</span>\n          <span>let</span> compressedImageBlob <span>=</span> <span>dataUrlToBlob</span><span>(</span>compressedDataURL<span>)</span><span>;</span>\n          <span>uploadFile</span><span>(</span><span>\"https://httpbin.org/post\"</span><span>,</span> compressedImageBlob<span>)</span><span>;</span>\n        <span>}</span><span>;</span>\n        reader<span>.</span><span>readAsDataURL</span><span>(</span>event<span>.</span>target<span>.</span>files<span>[</span><span>0</span><span>]</span><span>)</span><span>;</span>\n      <span>}</span><span>;</span>\n    </span></span><span><span><span>&lt;/</span>script</span><span>></span></span>\n  <span><span><span>&lt;/</span>body</span><span>></span></span>\n<span><span><span>&lt;/</span>html</span><span>></span></span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br></div></div><h3 id=\"生成-pdf-文档\"> 生成 PDF 文档</h3>\n<p>在浏览器端，利用一些现成的开源库，比如 jsPDF，我们也可以方便地生成 PDF 文档。</p>\n<div><pre><code><span><span>&lt;!</span><span>DOCTYPE</span> <span>html</span><span>></span></span>\n<span><span><span>&lt;</span>html</span><span>></span></span>\n  <span><span><span>&lt;</span>head</span><span>></span></span>\n    <span><span><span>&lt;</span>meta</span> <span>charset</span><span><span>=</span><span>\"</span>UTF-8<span>\"</span></span> <span>/></span></span>\n    <span><span><span>&lt;</span>meta</span> <span>name</span><span><span>=</span><span>\"</span>viewport<span>\"</span></span> <span>content</span><span><span>=</span><span>\"</span>width=device-width, initial-scale=1.0<span>\"</span></span> <span>/></span></span>\n    <span><span><span>&lt;</span>title</span><span>></span></span>客户端生成 PDF 示例<span><span><span>&lt;/</span>title</span><span>></span></span>\n  <span><span><span>&lt;/</span>head</span><span>></span></span>\n  <span><span><span>&lt;</span>body</span><span>></span></span>\n    <span><span><span>&lt;</span>h3</span><span>></span></span>客户端生成 PDF 示例<span><span><span>&lt;/</span>h3</span><span>></span></span>\n    <span><span><span>&lt;</span>script</span> <span>src</span><span><span>=</span><span>\"</span>https://unpkg.com/jspdf@latest/dist/jspdf.min.js<span>\"</span></span><span>></span></span><span></span><span><span><span>&lt;/</span>script</span><span>></span></span>\n    <span><span><span>&lt;</span>script</span><span>></span></span><span><span>\n      <span>(</span><span>function</span> <span>generatePdf</span><span>(</span><span>)</span> <span>{</span>\n        <span>const</span> doc <span>=</span> <span>new</span> <span>jsPDF</span><span>(</span><span>)</span><span>;</span>\n        doc<span>.</span><span>text</span><span>(</span><span>\"Hello semlinker!\"</span><span>,</span> <span>66</span><span>,</span> <span>88</span><span>)</span><span>;</span>\n        <span>const</span> blob <span>=</span> <span>new</span> <span>Blob</span><span>(</span><span>[</span>doc<span>.</span><span>output</span><span>(</span><span>)</span><span>]</span><span>,</span> <span>{</span> type<span>:</span> <span>\"application/pdf\"</span> <span>}</span><span>)</span><span>;</span>\n        blob<span>.</span><span>text</span><span>(</span><span>)</span><span>.</span><span>then</span><span>(</span><span>(</span><span>blobAsText</span><span>)</span> <span>=></span> <span>{</span>\n          console<span>.</span><span>log</span><span>(</span>blobAsText<span>)</span><span>;</span>\n        <span>}</span><span>)</span><span>;</span>\n      <span>}</span><span>)</span><span>(</span><span>)</span><span>;</span>\n    </span></span><span><span><span>&lt;/</span>script</span><span>></span></span>\n  <span><span><span>&lt;/</span>body</span><span>></span></span>\n<span><span><span>&lt;/</span>html</span><span>></span></span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br></div></div><p>其实 jsPDF 除了支持纯文本之外，它也可以生成带图片的 PDF 文档，比如：</p>\n<div><pre><code><span>let</span> imgData <span>=</span> <span>'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/...'</span>\n<span>let</span> doc <span>=</span> <span>new</span> <span>jsPDF</span><span>(</span><span>)</span><span>;</span>\n\ndoc<span>.</span><span>setFontSize</span><span>(</span><span>40</span><span>)</span>\ndoc<span>.</span><span>text</span><span>(</span><span>35</span><span>,</span> <span>25</span><span>,</span> <span>'Paranyan loves jsPDF'</span><span>)</span>\ndoc<span>.</span><span>addImage</span><span>(</span>imgData<span>,</span> <span>'JPEG'</span><span>,</span> <span>15</span><span>,</span> <span>40</span><span>,</span> <span>180</span><span>,</span> <span>160</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "web security",
      "url": "https://x-vic.gitee.io/code/code/views/JS/security/",
      "id": "https://x-vic.gitee.io/code/code/views/JS/security/",
      "content_html": "<h2 id=\"xss\"> xss</h2>\n<p>跨站脚本攻击,英文全称是Cross Site Script，本来缩写是CSS,但是为了和层叠样式表(Cascading Style Sheet, CSS)有所区别,所以在安全领域叫做&quot;XSS&quot;。</p>\n<p><strong>XSS攻击,通常是指黑客通过&quot;HTML注入&quot;篡改了网页，插入了恶意的脚本，从而在用户浏览网页时，控制用户浏览器的一种攻击</strong>。在一开始，这种攻击的演示案例是跨域的，所以叫做&quot;跨站脚本&quot;。但是发展到今天。是否跨域已经不再重要。</p>\n<h3 id=\"反射型-xss-非持久\"> 反射型 XSS （非持久）</h3>\n<p>反射型 XSS 只是简单地把用户输入的数据&quot;反射&quot;给浏览器。也就是说，黑客往往需要诱使用户&quot;点击&quot;一个恶意链接，才能攻击成功。反射型 XSS 也叫做&quot;非持久&quot;。</p>\n<h3 id=\"存储型-xss\"> 存储型 XSS</h3>\n<p>存储型 XSS 会把用户输入的数据&quot;存储&quot;在服务器端。这种XSS具有很强的稳定性。比较常见的一个场景就是，黑客写下一篇包含恶意JavaScript代码的博客文章，文章发表后，所有访问该博客的用户，都会在它们的浏览器中执行这段恶意的JavaScript代码。黑客把恶意的脚本保存到服务端。所以这种XSS攻击就叫做&quot;存储型 XSS&quot;。</p>\n<h3 id=\"dom-based-xss\"> DOM based XSS</h3>\n<p>实际上，这种类型的XSS并非按照&quot;数据是否保存在服务器端&quot;来划分。DOM Based XSS从效果上来说也是反射型XSS。单独划分出来，是因为 DOM Based XSS 的形成原因比较特别。通过<strong>修改页面的DOM节点形成的 XSS</strong>，称之为 DOM Based XSS。</p>\n<h3 id=\"如何防御\"> 如何防御</h3>\n<ol>\n<li>对输入内容的特定字符进行编码，例如：&quot;&lt;&gt;&quot;等</li>\n<li>对重要的 cookie 设置 httpOnly</li>\n<li>将不可信的值输出 URL参数之前，进行 URLEncode 操作，而对于从 URL参数中获取值一定要进行格式检测。</li>\n</ol>\n<p>举个攻击的例子：</p>\n<div><pre><code>// $input 会将 url 中的 param 参数读取出来作为 div 的内容。\n// http://www.a.com/test.php?param=<span><span><span>&lt;</span>script</span><span>></span></span><span><span><span>alert</span><span>(</span><span><span>/</span><span>xss</span><span>/</span></span><span>)</span></span></span><span><span><span>&lt;/</span>script</span><span>></span></span> 用户这般输入就造成 XSS 攻击了\n<span><span>&lt;?php</span> \n  <span>$input</span> <span>=</span> <span>$_GET</span><span>[</span><span>\"param\"</span><span>]</span><span>;</span>\n  <span>echo</span> <span>\"&lt;div>\"</span><span>.</span><span>$input</span><span>.</span><span>\"&lt;/div>\"</span><span>;</span>\n<span>?></span></span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><h2 id=\"csrf\"> csrf</h2>\n<p>CSRF 英文全称是 Cross-site request forgery，又称为“跨站请求伪造”。<br>\n顾名思义，CSRF 攻击就是黑客引诱用户打开黑客的网站，利用用户的登陆状态发起跨站请求。</p>\n<h3 id=\"攻击过程\"> 攻击过程</h3>\n<ol>\n<li>用户登陆 A 网站（此时浏览器已经存有 A 网站用户信息的 cookie）</li>\n<li>再不关闭 A 网站的情况下，新开标签页访问黑客网站</li>\n<li>黑客网站发送向 A 网站的请求（该请求会自动带上用户信息，而服务器无法知道这是个恶意请求）</li>\n</ol>\n<h3 id=\"如何防御-2\"> 如何防御</h3>\n<ol>\n<li>对每个请求都设置一个 token,尤其是 post, delete 等危险 method</li>\n<li>检查 reffer，检测链接访问来源</li>\n<li>使用 X-iframe-options 头部控制别的网站用 iframe 嵌入你的内容</li>\n</ol>\n<h2 id=\"https\"> https</h2>\n<p>https 对内容加/解密使用对称加密算法。<br>\n对称加密的密码使用非对称加密进行加密传输（公钥加密，私钥解密）。<br>\n这样既保证了安全性，又兼顾了编/解码内容的效率。</p>\n<p>对称加密密钥的传输：</p>\n<ol>\n<li>Client 发送 random1+对称加密套件列表+非对称加密套件列表</li>\n<li>Server 收到信息， 选择 对称加密套件+非对称加密套件 并和 random2+证书(公钥在证书中) 一起返回</li>\n<li>Client 验证证书有效性，并用 random1+random2 生成 pre-master 通过服务器公钥加密+浏览器确认 发送给 Server</li>\n<li>Server 收到 pre-master，根据约定的加密算法对 random1+random2+pre-master（解密）生成 master-secret，然后发送服务器确认</li>\n<li>Client 收到生成同样的 master-secert，对称<strong>加密秘钥</strong>传输完毕</li>\n</ol>\n<p>HTTPS 在 TCP 和 HTTP 中间加入了 SSL/TLS 安全层。</p>\n<p>对发起 HTTP 请求的数据进行加密操作\n对接收到 HTTP 的内容进行解密操作。</p>\n",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "TS 奇怪的符号",
      "url": "https://x-vic.gitee.io/code/code/views/JS/ts/",
      "id": "https://x-vic.gitee.io/code/code/views/JS/ts/",
      "content_html": "<h2 id=\"非空断言\"> !非空断言</h2>\n<p>从含有 <code>undefined</code> <code>null</code> 的类型合集中去除 <code>undefined</code> <code>null</code>。</p>\n<div><pre><code><span>function</span> <span>myFunc</span><span>(</span>maybeString<span>:</span> <span>string</span> <span>|</span> <span>undefined</span> <span>|</span> <span>null</span><span>)</span> <span>{</span>\n  <span>const</span> onlyString<span>:</span> <span>string</span> <span>=</span> maybeString<span>;</span> <span>// Error</span>\n  <span>const</span> ignoreUndefinedAndNull<span>:</span> <span>string</span> <span>=</span> maybeString<span>!</span><span>;</span> <span>// Ok</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><h2 id=\"\"> ?.</h2>\n<p>尝试着取属性。<br>\n<code>?.</code> 只会验证对象是否为 <code>null</code> 或 <code>undefined，对于</code> <code>0</code> 或空字符串来说，并不会出现 “短路”。</p>\n<div><pre><code>a<span>?.</span>b\na<span>?.</span><span>[</span><span>'b'</span><span>]</span>\nobj<span>.</span>customMethod<span>?.</span><span>(</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br></div></div><h2 id=\"空值合并运算符\"> ?? 空值合并运算符</h2>\n<p>与逻辑或 <code>||</code> 运算符不同，当左侧操作数为 <code>null</code> 或 <code>undefined</code> 时，其返回右侧的操作数，否则返回左侧的操作数。</p>\n<div><pre><code><span>// 与可选链结合使用</span>\n<span>let</span> customerCity <span>=</span> customer<span>?.</span>city <span>??</span> <span>\"Unknown city\"</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br></div></div><h2 id=\"可选属性\"> ?: 可选属性</h2>\n<h3 id=\"工具类型\"> 工具类型</h3>\n<h4 id=\"partial-t-将-t-中的所有属性都变成可选的\"> <code>Partial&lt;T&gt;</code> 将 T 中的所有属性都变成可选的</h4>\n<div><pre><code><span>// Partial 的实现</span>\n<span>type</span> <span>Partial<span>&lt;</span><span>T</span><span>></span></span> <span>=</span> <span>{</span>\n  <span>[</span><span>P</span> <span>in</span> <span>keyof</span> <span>T</span><span>]</span><span>?</span><span>:</span> <span>T</span><span>[</span><span>P</span><span>]</span><span>;</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><h4 id=\"required-t-将-t-中的所有属性都变成必须的\"> <code>Required&lt;T&gt;</code> 将 T 中的所有属性都变成必须的</h4>\n<div><pre><code><span>// Required 的实现</span>\n<span>// 通过 -? 移除了可选属性中的 ?，使得属性从可选变为必选的。</span>\n<span>type</span> <span>Required<span>&lt;</span><span>T</span><span>></span></span> <span>=</span> <span>{</span>\n  <span>[</span><span>P</span> <span>in</span> <span>keyof</span> <span>T</span><span>]</span><span>-</span><span>?</span><span>:</span> <span>T</span><span>[</span><span>P</span><span>]</span><span>;</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></div></div><h4 id=\"readonly-t-将某个类型所有属性变为只读属性\"> <code>Readonly&lt;T&gt;</code> 将某个类型所有属性变为只读属性</h4>\n<div><pre><code><span>// 实现</span>\n<span>type</span> <span>Readonly<span>&lt;</span><span>T</span><span>></span></span> <span>=</span> <span>{</span>\n  <span>readonly</span> <span>[</span><span>P</span> <span>in</span> <span>keyof</span> <span>T</span><span>]</span><span>:</span> <span>T</span><span>[</span><span>P</span><span>]</span><span>;</span>\n<span>}</span>\n<span>// 如果将上面的 readonly 改成 -readonly， 就是移除子属性的 readonly 标识。</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></div></div><h4 id=\"record-k-extends-keyof-any-t-将-k-中所有的属性的值转化为-t-类型\"> <code>Record&lt;K extends keyof any, T&gt;</code> 将 K 中所有的属性的值转化为 T 类型</h4>\n<div><pre><code><span>// 实现</span>\n<span>type</span> <span>Record<span>&lt;</span><span>K</span> <span>extends</span> <span>keyof</span> <span>any</span><span>,</span> <span>T</span><span>></span></span> <span>=</span> <span>{</span>\n  <span>[</span><span>P</span> <span>in</span> <span>K</span><span>]</span><span>:</span> <span>T</span><span>;</span>\n<span>}</span>\n\n<span>// 示例</span>\n<span>interface</span> <span>PageInfo</span> <span>{</span>\n  title<span>:</span> <span>string</span>\n<span>}</span>\n\n<span>type</span> <span>Page</span> <span>=</span> <span>\"home\"</span> <span>|</span> <span>\"about\"</span> <span>|</span> <span>\"contact\"</span>\n\n<span>const</span> x<span>:</span> Record<span>&lt;</span>Page<span>,</span> PageInfo<span>></span> <span>=</span> <span>{</span>\n  about<span>:</span> <span>{</span> title<span>:</span> <span>\"about\"</span> <span>}</span><span>,</span>\n  contact<span>:</span> <span>{</span> title<span>:</span> <span>\"contact\"</span> <span>}</span><span>,</span>\n  home<span>:</span> <span>{</span> title<span>:</span> <span>\"home\"</span> <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br></div></div><h4 id=\"pick-t-k-extends-keyof-t-将-t-类型中包含-k-的一部分属性摘出来\"> <code>Pick&lt;T, K extends keyof T&gt;</code> 将 T 类型中包含 K 的一部分属性摘出来</h4>\n<div><pre><code><span>// 实现</span>\n<span>type</span> <span>Pick<span>&lt;</span><span>T</span><span>,</span> <span>K</span> <span>extends</span> <span>keyof</span> <span>T</span><span>></span></span> <span>=</span> <span>{</span>\n  <span>[</span><span>P</span> <span>in</span> <span>K</span><span>]</span><span>:</span> <span>T</span><span>[</span><span>P</span><span>]</span><span>;</span>\n<span>}</span>\n\n<span>// 示例</span>\n<span>interface</span> <span>Todo</span> <span>{</span>\n  title<span>:</span> <span>string</span>\n  description<span>:</span> <span>string</span>\n  completed<span>:</span> <span>boolean</span>\n<span>}</span>\n\n<span>type</span> <span>TodoPreview</span> <span>=</span> Pick<span>&lt;</span>Todo<span>,</span> <span>\"title\"</span> <span>|</span> <span>\"completed\"</span><span>></span>\n\n<span>const</span> todo<span>:</span> TodoPreview <span>=</span> <span>{</span>\n  title<span>:</span> <span>\"Clean room\"</span><span>,</span>\n  completed<span>:</span> <span>false</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br></div></div><h4 id=\"exclude-t-u-将-t-中包含-u-部分的属性剔除\"> <code>Exclude&lt;T, U&gt;</code> 将 T 中包含 U 部分的属性剔除</h4>\n<div><pre><code><span>// 实现</span>\n<span>type</span> <span>Exclude<span>&lt;</span><span>T</span><span>,</span> <span>U</span><span>></span></span> <span>=</span> <span>T</span> <span>extends</span> <span><span>U</span></span> <span>?</span> <span>never</span> <span>:</span> <span>T</span>\n\n<span>// 示例</span>\n<span>type</span> <span><span>T1</span></span> <span>=</span> Exclude<span>&lt;</span><span>\"a\"</span> <span>|</span> <span>\"b\"</span> <span>|</span> <span>\"c\"</span><span>,</span> <span>\"a\"</span> <span>|</span> <span>\"b\"</span><span>></span><span>;</span> <span>// \"c\"</span>\n<span>type</span> <span><span>T2</span></span> <span>=</span> Exclude<span>&lt;</span><span>string</span> <span>|</span> <span>number</span> <span>|</span> <span>(</span><span>(</span><span>)</span> <span>=></span> <span>void</span><span>)</span><span>,</span> <span>Function</span><span>></span><span>;</span> <span>// string | number</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><h4 id=\"extract-t-u-取-t-与-u-的交集\"> <code>Extract&lt;T, U&gt;</code> 取 T 与 U 的交集</h4>\n<div><pre><code><span>type</span> <span>Extract<span>&lt;</span><span>T</span><span>,</span> <span>U</span><span>></span></span> <span>=</span> <span>T</span> <span>extends</span> <span><span>U</span></span> <span>?</span> <span>T</span> <span>:</span> <span>never</span>\n\n<span>// 示例</span>\n<span>type</span> <span><span>T0</span></span> <span>=</span> Extract<span>&lt;</span><span>\"a\"</span> <span>|</span> <span>\"b\"</span> <span>|</span> <span>\"c\"</span><span>,</span> <span>\"a\"</span> <span>|</span> <span>\"f\"</span><span>></span><span>;</span> <span>// \"a\"</span>\n<span>type</span> <span><span>T1</span></span> <span>=</span> Extract<span>&lt;</span><span>string</span> <span>|</span> <span>number</span> <span>|</span> <span>(</span><span>(</span><span>)</span> <span>=></span> <span>void</span><span>)</span><span>,</span> <span>Function</span><span>></span><span>;</span> <span>// () =>void</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></div></div><h4 id=\"omit-t-k-extends-keyof-any-剔除-t-中健为-k-的属性\"> <code>Omit&lt;T, K extends keyof any&gt;</code> 剔除 T 中健为 K 的属性</h4>\n<div><pre><code><span>// 实现</span>\n<span>type</span> <span>Omit<span>&lt;</span><span>T</span><span>,</span> <span>K</span> <span>extends</span> <span>keyof</span> <span>any</span><span>></span></span> <span>=</span> Pick<span>&lt;</span><span>T</span><span>,</span> Exclude<span>&lt;</span><span>keyof</span> <span>T</span><span>,</span> <span>K</span><span>>></span>\n\n<span>// 示例</span>\n<span>interface</span> <span>Todo</span> <span>{</span>\n  title<span>:</span> <span>string</span>\n  description<span>:</span> <span>string</span>\n  completed<span>:</span> <span>boolean</span>\n<span>}</span>\n\n<span>type</span> <span>TodoPreview</span> <span>=</span> Omit<span>&lt;</span>Todo<span>,</span> <span>\"description\"</span><span>></span>\n\n<span>const</span> todo<span>:</span> TodoPreview <span>=</span> <span>{</span>\n  title<span>:</span> <span>\"Clean room\"</span><span>,</span>\n  completed<span>:</span> <span>false</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><h4 id=\"nonnullable-过滤类型中的-null-及-undefined-类型\"> <code>NonNullable</code> 过滤类型中的 <code>null</code> 及 <code>undefined</code> 类型</h4>\n<div><pre><code><span>// 实现</span>\n<span>type</span> <span>NonNullable<span>&lt;</span><span>T</span><span>></span></span> <span>=</span> <span>T</span> extendsnull <span>|</span> <span>undefined</span> <span>?</span> <span>never</span> <span>:</span> <span>T</span>\n\n<span>// 示例</span>\n<span>type</span> <span><span>T0</span></span> <span>=</span> NonNullable<span>&lt;</span><span>string</span> <span>|</span> <span>number</span> <span>|</span> <span>undefined</span><span>></span><span>;</span> <span>// string | number</span>\n<span>type</span> <span><span>T1</span></span> <span>=</span> NonNullable<span>&lt;</span><span>string</span><span>[</span><span>]</span> <span>|</span> <span>null</span> <span>|</span> <span>undefined</span><span>></span><span>;</span> <span>// string[]</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><h4 id=\"returntype-t-获取函数-t-的返回类型\"> <code>ReturnType&lt;T&gt;</code> 获取函数 T 的返回类型</h4>\n<div><pre><code><span>// 实现</span>\n<span>type</span> <span>ReturnType<span>&lt;</span><span>T</span> <span>extends</span> <span>(</span><span>...</span>args<span>:</span> <span>any</span><span>)</span> <span>=></span></span> <span>any</span><span>></span> <span>=</span> <span>T</span> <span>extends</span> <span>(</span><span>...</span>args<span>:</span> <span>any</span><span>)</span> <span>=></span> infer <span>R</span> <span>?</span> <span>R</span> <span>:</span> <span>any</span>\n\n<span>// 示例</span>\n<span>type</span> <span><span>T0</span></span> <span>=</span> ReturnType<span>&lt;</span><span>(</span><span>)</span> <span>=></span><span>string</span><span>></span><span>;</span> <span>// string</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></div></div><h4 id=\"instancetype-获取构造函数类型的实例类型\"> <code>InstanceType</code> 获取构造函数类型的实例类型</h4>\n<div><pre><code><span>// 实现</span>\n<span>type</span> <span>InstanceType<span>&lt;</span><span>T</span> <span>extendsnew</span> <span>(</span><span>...</span>args<span>:</span> <span>any</span><span>)</span> <span>=></span></span> <span>any</span><span>></span> <span>=</span> <span>T</span> <span>extendsnew</span> <span>(</span><span>...</span>args<span>:</span> <span>any</span><span>)</span> <span>=></span> infer <span>R</span> <span>?</span> <span>R</span> <span>:</span> <span>any</span>\n\n<span>// 示例</span>\n<span>class</span> <span><span>C</span></span> <span>{</span>\n  x <span>=</span> <span>0</span><span>;</span>\n  y <span>=</span> <span>0</span><span>;</span>\n<span>}</span>\n\n<span>type</span> <span><span>T0</span></span> <span>=</span> InstanceType<span>&lt;</span><span>typeof</span> <span>C</span><span>></span> <span>// C</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br></div></div><h4 id=\"thistype-t-用于指定上下文对象的类型\"> <code>ThisType&lt;T&gt;</code> 用于指定上下文对象的类型</h4>\n<div><pre><code><span>// 实现</span>\n<span>interface</span> <span>ThisType<span>&lt;</span><span>T</span><span>></span></span> <span>{</span> <span>}</span>\n\n<span>// 示例</span>\n<span>// 注意：使用 ThisType&lt;T> 时，必须确保 --noImplicitThis 标志设置为 true。</span>\n<span>interface</span> <span>Person</span> <span>{</span>\n  name<span>:</span> <span>string</span>\n  age<span>:</span> <span>number</span>\n<span>}</span>\n\n<span>const</span> obj<span>:</span> ThisType<span>&lt;</span>Person<span>></span> <span>=</span> <span>{</span>\n  <span>dosth</span><span>(</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span>name <span>// string</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br></div></div><h4 id=\"parameters-t-获得函数的参数类型组成的元组类型\"> <code>Parameters&lt;T&gt;</code> 获得函数的参数类型组成的元组类型</h4>\n<div><pre><code><span>// 实现</span>\n<span>type</span> <span>Parameters<span>&lt;</span><span>T</span> <span>extends</span> <span>(</span><span>...</span>args<span>:</span> <span>any</span><span>)</span> <span>=></span></span> <span>any</span><span>></span> <span>=</span> <span>T</span> <span>extends</span> <span>(</span><span>...</span>args<span>:</span> infer <span>P</span><span>)</span> <span>=></span> <span>any</span>\n  <span>?</span> <span>P</span> <span>:</span> <span>never</span>\n\n<span>// 示例</span>\n<span>type</span> <span><span>A</span></span> <span>=</span> Parameters<span>&lt;</span><span>(</span><span>)</span> <span>=></span><span>void</span><span>></span><span>;</span> <span>// []</span>\n<span>type</span> <span><span>B</span></span> <span>=</span> Parameters<span>&lt;</span>typeofArray<span>.</span>isArray<span>></span><span>;</span> <span>// [any]</span>\n<span>type</span> <span><span>C</span></span> <span>=</span> Parameters<span>&lt;</span>typeofparseInt<span>></span><span>;</span> <span>// [string, (number | undefined)?]</span>\n<span>type</span> <span><span>D</span></span> <span>=</span> Parameters<span>&lt;</span>typeofMath<span>.</span>max<span>></span><span>;</span> <span>// number[]</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br></div></div><h4 id=\"constructorparameters-t-提取构造函数类型的所有参数类型\"> <code>ConstructorParameters&lt;T&gt;</code> 提取构造函数类型的所有参数类型</h4>\n<div><pre><code><span>// 实现</span>\n<span>type</span> <span>ConstructorParameters<span>&lt;</span><span>T</span> <span>extendsnew</span> <span>(</span><span>...</span>args<span>:</span> <span>any</span><span>)</span> <span>=></span></span> <span>any</span><span>></span> <span>=</span> <span>T</span> <span>extendsnew</span> <span>(</span><span>...</span>args<span>:</span> infer <span>P</span><span>)</span> <span>=></span> <span>any</span> <span>?</span> <span>P</span> <span>:</span> <span>never</span>\n\n<span>// 示例</span>\n<span>type</span> <span><span>A</span></span> <span>=</span> ConstructorParameters<span>&lt;</span>ErrorConstructor<span>></span><span>;</span> <span>// [(string | undefined)?]</span>\n<span>type</span> <span><span>B</span></span> <span>=</span> ConstructorParameters<span>&lt;</span>FunctionConstructor<span>></span><span>;</span> <span>// string[]</span>\n<span>type</span> <span><span>C</span></span> <span>=</span> ConstructorParameters<span>&lt;</span>RegExpConstructor<span>></span><span>;</span> <span>// [string, (string | undefined)?]</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><h4 id=\"typeof-用来获取一个变量声明或对象的类型。\"> <code>typeof</code> 用来获取一个变量声明或对象的类型。</h4>\n<div><pre><code><span>interface</span> <span>Person</span> <span>{</span>\n  name<span>:</span> <span>string</span>\n  age<span>:</span> <span>number</span>\n<span>}</span>\n\n<span>const</span> sem<span>:</span> Person <span>=</span> <span>{</span> name<span>:</span> <span>'semlinker'</span><span>,</span> age<span>:</span> <span>30</span> <span>}</span><span>;</span>\n<span>type</span> <span>Sem</span><span>=</span> <span>typeof</span> sem<span>;</span> <span>// -> Person</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><h4 id=\"keyof-用来获取一个对象中的所有-key-值\"> <code>keyof</code> 用来获取一个对象中的所有 key 值</h4>\n<div><pre><code><span>interface</span> <span>Person</span> <span>{</span>\n    name<span>:</span> <span>string</span><span>;</span>\n    age<span>:</span> <span>number</span><span>;</span>\n<span>}</span>\n\n<span>type</span> <span><span>K1</span></span> <span>=</span> <span>keyof</span> Person<span>;</span> <span>// \"name\" | \"age\"</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><h4 id=\"in-用来遍历枚举类型\"> <code>in</code> 用来遍历枚举类型</h4>\n<div><pre><code><span>type</span> <span>Keys</span> <span>=</span> <span>\"a\"</span> <span>|</span> <span>\"b\"</span> <span>|</span> <span>\"c\"</span>\n\n<span>type</span> <span>Obj</span> <span>=</span>  <span>{</span>\n  <span>[</span>p <span>in</span> Keys<span>]</span><span>:</span> <span>any</span>\n<span>}</span> <span>// -> { a: any, b: any, c: any }</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></div></div><h4 id=\"infer-在条件类型语句中-可以用-infer-声明一个类型变量并且对它进行使用\"> <code>infer</code> 在条件类型语句中，可以用 infer 声明一个类型变量并且对它进行使用</h4>\n<div><pre><code><span>// 提取 T 函数的返回值类型</span>\n<span>type</span> <span>ReturnType<span>&lt;</span><span>T</span><span>></span></span> <span>=</span> <span>T</span> <span>extends</span> <span>(</span><span>...</span>args<span>:</span> <span>any</span><span>[</span><span>]</span><span>)</span> <span>=></span> infer <span>R</span> \n  <span>?</span> <span>R</span> \n  <span>:</span> <span>any</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><h2 id=\"运算符\"> &amp; 运算符</h2>\n<p>将多个类型合并为一个类型</p>\n<div><pre><code><span>type</span> <span>PartialPointX</span> <span>=</span> <span>{</span> x<span>:</span> <span>number</span> <span>}</span>\n<span>type</span> <span>Point</span> <span>=</span> PartialPointX <span>&amp;</span> <span>{</span> y<span>:</span> <span>number</span> <span>}</span>\n\n<span>let</span> point<span>:</span> Point <span>=</span> <span>{</span>\n  x<span>:</span> <span>1</span><span>,</span>\n  y<span>:</span> <span>1</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><h2 id=\"分隔符\"> | 分隔符</h2>\n<p>表示取值可以为多种类型中的一种</p>\n<div><pre><code><span>const</span> <span>sayHello</span> <span>=</span> <span>(</span>name<span>:</span> <span>string</span> <span>|</span> <span>undefined</span><span>)</span> <span>=></span> <span>{</span> <span>/* ... */</span> <span>}</span>\n</code></pre>\n<div><span>1</span><br></div></div><h3 id=\"类型保护\"> 类型保护</h3>\n<p>联合类型是将类型的可能性拓宽了，但是很多时候我们也需要将这种可能性收窄，这就要用到类型保护了。</p>\n<h4 id=\"in\"> in</h4>\n<div><pre><code><span>interface</span> <span>Admin</span> <span>{</span>\n  name<span>:</span> <span>string</span>\n  privileges<span>:</span> <span>string</span><span>[</span><span>]</span>\n<span>}</span>\n\n<span>interface</span> <span>Employee</span> <span>{</span>\n  name<span>:</span> <span>string</span>\n  startDate<span>:</span> Date\n<span>}</span>\n\n<span>type</span> <span>UnknownEmployee</span> <span>=</span> Employee <span>|</span> Admin\n\n<span>function</span> <span>printEmployeeInformation</span><span>(</span>emp<span>:</span> UnknownEmployee<span>)</span> <span>{</span>\n  <span>if</span> <span>(</span><span>\"privileges\"</span> <span>in</span> emp<span>)</span> <span>{</span>\n    <span>console</span><span>.</span><span>log</span><span>(</span><span>\"Privileges: \"</span> <span>+</span> emp<span>.</span>privileges<span>)</span>\n  <span>}</span>\n  <span>if</span> <span>(</span><span>\"startDate\"</span> <span>in</span> emp<span>)</span> <span>{</span>\n    <span>console</span><span>.</span><span>log</span><span>(</span><span>\"Start Date: \"</span> <span>+</span> emp<span>.</span>startDate<span>)</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br></div></div><h4 id=\"typeof\"> typeof</h4>\n<div><pre><code><span>function</span> <span>padLeft</span><span>(</span>value<span>:</span> <span>string</span><span>,</span> padding<span>:</span> <span>string</span> <span>|</span> <span>number</span><span>)</span> <span>{</span>\n  <span>if</span> <span>(</span><span>typeof</span> padding <span>===</span> <span>\"number\"</span><span>)</span> <span>{</span>\n      <span>return</span> <span>Array</span><span>(</span>padding <span>+</span> <span>1</span><span>)</span><span>.</span><span>join</span><span>(</span><span>\" \"</span><span>)</span> <span>+</span> value<span>;</span>\n  <span>}</span>\n  <span>if</span> <span>(</span><span>typeof</span> padding <span>===</span> <span>\"string\"</span><span>)</span> <span>{</span>\n      <span>return</span> padding <span>+</span> value<span>;</span>\n  <span>}</span>\n  <span>throw</span> <span>new</span> <span>Error</span><span>(</span><span><span>`</span><span>Expected string or number, got '</span><span><span>${</span>padding<span>}</span></span><span>'.</span><span>`</span></span><span>)</span><span>;</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br></div></div><h4 id=\"instanceof\"> instanceof</h4>\n<div><pre><code><span>interface</span> <span>Padder</span> <span>{</span>\n  <span>getPaddingString</span><span>(</span><span>)</span><span>:</span> <span>string</span><span>;</span>\n<span>}</span>\n\n<span>class</span> <span>SpaceRepeatingPadder</span> <span>implements</span> <span>Padder</span> <span>{</span><span>}</span>\n\n<span>class</span> <span>StringPadder</span> <span>implements</span> <span>Padder</span> <span>{</span><span>}</span>\n\n<span>let</span> padder<span>:</span> Padder <span>=</span> <span>new</span> <span>SpaceRepeatingPadder</span><span>(</span><span>)</span><span>;</span>\n\n<span>if</span> <span>(</span>padder <span>instanceof</span> <span>SpaceRepeatingPadder</span><span>)</span> <span>{</span>\n  <span>// padder的类型收窄为 'SpaceRepeatingPadder'</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "文件上传",
      "url": "https://x-vic.gitee.io/code/code/views/JS/upload/",
      "id": "https://x-vic.gitee.io/code/code/views/JS/upload/",
      "content_html": "<h2 id=\"请求端\"> 请求端</h2>\n<p>上传文件我们一般使用 <code>multipart/form-data</code>。这个规范首先需要请求类型（也就是 multipart/form-data）；然后就是一个 boundary（分隔符，文件分片上传的时候，需要用到）；然后就是声明内容的描述是 form-data 类型（字段名/文件名）。</p>\n<h3 id=\"发送-formdata-请求的几种方式\"> 发送 formData 请求的几种方式</h3>\n<div><pre><code><span>const</span> file <span>=</span> document<span>.</span><span>getElementById</span><span>(</span><span>'file'</span><span>)</span><span>.</span>files<span>[</span><span>0</span><span>]</span>\n<span>const</span> form <span>=</span> <span>new</span> <span>FormData</span><span>(</span><span>)</span><span>;</span>\nform<span>.</span><span>append</span><span>(</span><span>'file'</span><span>,</span> file<span>)</span><span>;</span>\n<span>// 方式一：使用 axios</span>\naxios<span>.</span><span>post</span><span>(</span><span>'http://localhost:3333/files'</span><span>,</span> form<span>)</span>\n<span>// 方式二：使用 fecth</span>\n<span>fetch</span><span>(</span><span>'http://localhost:3333/files'</span><span>,</span> <span>{</span>\n  method<span>:</span> <span>'POST'</span><span>,</span>\n  body<span>:</span> form\n<span>}</span><span>)</span>\n<span>// 方式三：使用 xhr</span>\n<span>const</span> xhr <span>=</span> <span>new</span> <span>XMLHttpRequest</span><span>(</span><span>)</span>\nxhr<span>.</span><span>open</span><span>(</span><span>'POST'</span><span>,</span> <span>'http://localhost:3333/files'</span><span>,</span> <span>true</span><span>)</span>\nxhr<span>.</span><span>onload</span> <span>=</span> <span>(</span><span>)</span> <span>=></span> <span>{</span>\n  console<span>.</span><span>log</span><span>(</span>xhr<span>.</span>responseText<span>)</span>\n<span>}</span>\nxhr<span>.</span><span>send</span><span>(</span>form<span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br></div></div><div><p>主要还是要关注如何构造formData请求</p>\n<ul>\n<li>Request Headers\n<ul>\n<li>Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryjlY2Kd7OA1gqxdb7</li>\n</ul>\n</li>\n<li>Form Data\n<ul>\n<li>file: (binary)</li>\n</ul>\n</li>\n</ul>\n</div>\n<h3 id=\"blob\"> Blob</h3>\n<p>使用 Blob 构造 formData 对象。</p>\n<div><pre><code><span>const</span> json <span>=</span> <span>{</span> hello<span>:</span> <span>\"world\"</span> <span>}</span>\n<span>const</span> blob <span>=</span> <span>new</span> <span>Blob</span><span>(</span><span>[</span><span>JSON</span><span>.</span><span>stringify</span><span>(</span>json<span>,</span> <span>null</span><span>,</span> <span>2</span><span>)</span><span>]</span><span>,</span> <span>{</span> type<span>:</span> <span>'application/json'</span> <span>}</span><span>)</span>\n    \n<span>const</span> form <span>=</span> <span>new</span> <span>FormData</span><span>(</span><span>)</span>\nform<span>.</span><span>append</span><span>(</span><span>'file'</span><span>,</span> blob<span>,</span> <span>'1.json'</span><span>)</span>\naxios<span>.</span><span>post</span><span>(</span><span>'http://localhost:3333/files'</span><span>,</span> form<span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><p>使用 File 对 Blob 再一次进行包装（File 兼容性可能会差一些）</p>\n<div><pre><code><span>const</span> json <span>=</span> <span>{</span> hello<span>:</span> <span>\"world\"</span> <span>}</span>\n<span>const</span> blob <span>=</span> <span>new</span> <span>Blob</span><span>(</span><span>[</span><span>JSON</span><span>.</span><span>stringify</span><span>(</span>json<span>,</span> <span>null</span><span>,</span> <span>2</span><span>)</span><span>]</span><span>,</span> <span>{</span> type<span>:</span> <span>'application/json'</span> <span>}</span><span>)</span>\n    \n<span>const</span> file <span>=</span> <span>new</span> <span>File</span><span>(</span><span>[</span>blob<span>]</span><span>,</span> <span>'1.json'</span><span>)</span>\nform<span>.</span><span>append</span><span>(</span><span>'file'</span><span>,</span> file<span>)</span>\naxios<span>.</span><span>post</span><span>(</span><span>'http://localhost:3333/files'</span><span>,</span> form<span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><h3 id=\"arraybuffer\"> ArrayBuffer</h3>\n<p><code>ArrayBuffer</code> 对象用来表示通用的、固定长度的原始二进制数据缓冲区。虽然它用的比较少，但是他是最贴近文件流的方式了。在浏览器中，他每个字节以十进制的方式存在。</p>\n<div><pre><code><span>const</span> bufferArrary <span>=</span> <span>[</span><span>137</span><span>,</span><span>80</span><span>,</span><span>78</span><span>,</span><span>71</span><span>,</span><span>13</span><span>,</span><span>10</span><span>,</span><span>26</span><span>,</span><span>10</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>13</span><span>,</span><span>73</span><span>,</span><span>72</span><span>,</span><span>68</span><span>,</span><span>82</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>1</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>1</span><span>,</span><span>1</span><span>,</span><span>3</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>37</span><span>,</span><span>219</span><span>,</span><span>86</span><span>,</span><span>202</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>6</span><span>,</span><span>80</span><span>,</span><span>76</span><span>,</span><span>84</span><span>,</span><span>69</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>255</span><span>,</span><span>128</span><span>,</span><span>128</span><span>,</span><span>128</span><span>,</span><span>76</span><span>,</span><span>108</span><span>,</span><span>191</span><span>,</span><span>213</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>9</span><span>,</span><span>112</span><span>,</span><span>72</span><span>,</span><span>89</span><span>,</span><span>115</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>14</span><span>,</span><span>196</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>14</span><span>,</span><span>196</span><span>,</span><span>1</span><span>,</span><span>149</span><span>,</span><span>43</span><span>,</span><span>14</span><span>,</span><span>27</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>10</span><span>,</span><span>73</span><span>,</span><span>68</span><span>,</span><span>65</span><span>,</span><span>84</span><span>,</span><span>8</span><span>,</span><span>153</span><span>,</span><span>99</span><span>,</span><span>96</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>2</span><span>,</span><span>0</span><span>,</span><span>1</span><span>,</span><span>244</span><span>,</span><span>113</span><span>,</span><span>100</span><span>,</span><span>166</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>0</span><span>,</span><span>73</span><span>,</span><span>69</span><span>,</span><span>78</span><span>,</span><span>68</span><span>,</span><span>174</span><span>,</span><span>66</span><span>,</span><span>96</span><span>,</span><span>130</span><span>]</span>\n<span>const</span> array <span>=</span> Uint8Array<span>.</span><span>from</span><span>(</span>bufferArrary<span>)</span>\n<span>const</span> blob <span>=</span> <span>new</span> <span>Blob</span><span>(</span><span>[</span>array<span>]</span><span>,</span> <span>{</span>type<span>:</span> <span>'image/png'</span><span>}</span><span>)</span>\n<span>const</span> form <span>=</span> <span>new</span> <span>FormData</span><span>(</span><span>)</span>\nform<span>.</span><span>append</span><span>(</span><span>'file'</span><span>,</span> blob<span>,</span> <span>'1.png'</span><span>)</span>\naxios<span>.</span><span>post</span><span>(</span><span>'http://localhost:3333/files'</span><span>,</span> form<span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><h3 id=\"base64\"> Base64</h3>\n<div><pre><code><span>const</span> base64 <span>=</span> <span>'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAABlBMVEUAAP+AgIBMbL/VAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAACklEQVQImWNgAAAAAgAB9HFkpgAAAABJRU5ErkJggg=='</span>\n<span>const</span> byteCharacters <span>=</span> <span>atob</span><span>(</span>base64<span>)</span>\n<span>const</span> byteNumbers <span>=</span> <span>new</span> <span>Array</span><span>(</span>byteCharacters<span>.</span>length<span>)</span>\n<span>// 将字节转换成数组</span>\n<span>for</span> <span>(</span><span>let</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> byteCharacters<span>.</span>length<span>;</span> i<span>++</span><span>)</span> <span>{</span>\n\tbyteNumbers<span>[</span>i<span>]</span> <span>=</span> byteCharacters<span>.</span><span>charCodeAt</span><span>(</span>i<span>)</span>\n<span>}</span>\n<span>// 将字节数组转换成为 Uint8Array 类型</span>\n<span>const</span> array <span>=</span> Uint8Array<span>.</span><span>from</span><span>(</span>byteNumbers<span>)</span>\n<span>// 将 Uint8Array 转换成 Blob 类型</span>\n<span>const</span> blob <span>=</span> <span>new</span> <span>Blob</span><span>(</span><span>[</span>array<span>]</span><span>,</span> <span>{</span>type<span>:</span> <span>'image/png'</span><span>}</span><span>)</span>\n<span>const</span> form <span>=</span> <span>new</span> <span>FormData</span><span>(</span><span>)</span>\nform<span>.</span><span>append</span><span>(</span><span>'file'</span><span>,</span> blob<span>,</span> <span>'1.png'</span><span>)</span>\naxios<span>.</span><span>post</span><span>(</span><span>'http://localhost:3333/files'</span><span>,</span> form<span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br></div></div><h3 id=\"服务端发送-formdata-请求\"> 服务端发送 formData 请求</h3>\n<p>首先来看看 <code>multipart/form-data</code> 规范：</p>\n<div><pre><code>Content-type: multipart/form-data, boundary=AaB03x\n\n--AaB03x\ncontent-disposition: form-data; name=&quot;field1&quot;\nJoe Blow\n--AaB03x\ncontent-disposition: form-data; name=&quot;pics&quot;; filename=&quot;file1.txt&quot;\nContent-Type: text/plain\n\n... contents of file1.txt ...\n--AaB03x--\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><p>原生 node 来构造 <code>multipart/form-data</code> 请求</p>\n<div><pre><code><span>const</span> path <span>=</span> <span>require</span><span>(</span><span>'path'</span><span>)</span><span>;</span>\n<span>const</span> fs <span>=</span> <span>require</span><span>(</span><span>'fs'</span><span>)</span><span>;</span>\n<span>const</span> http <span>=</span> <span>require</span><span>(</span><span>'http'</span><span>)</span><span>;</span>\n<span>// 定义一个分隔符，要确保唯一性</span>\n<span>const</span> boundaryKey <span>=</span> <span>'-------------------------461591080941622511336662'</span><span>;</span>\n<span>const</span> request <span>=</span> http<span>.</span><span>request</span><span>(</span><span>{</span>\n    method<span>:</span> <span>'post'</span><span>,</span>\n    host<span>:</span> <span>'localhost'</span><span>,</span>\n    port<span>:</span> <span>'3333'</span><span>,</span>\n    path<span>:</span> <span>'/files'</span><span>,</span>\n    headers<span>:</span> <span>{</span>\n        <span>'Content-Type'</span><span>:</span> <span>'multipart/form-data; boundary='</span> <span>+</span> boundaryKey<span>,</span> <span>// 在请求头上加上分隔符</span>\n        <span>'Connection'</span><span>:</span> <span>'keep-alive'</span>\n    <span>}</span>\n<span>}</span><span>)</span><span>;</span>\n<span>// 写入内容头部</span>\nrequest<span>.</span><span>write</span><span>(</span>\n    <span><span>`</span><span>--</span><span><span>${</span>boundaryKey<span>}</span></span><span>\\r\\nContent-Disposition: form-data; name=\"file\"; filename=\"1.png\"\\r\\nContent-Type: image/jpeg\\r\\n\\r\\n</span><span>`</span></span>\n<span>)</span><span>;</span>\n<span>// 写入内容</span>\n<span>const</span> fileStream <span>=</span> fs<span>.</span><span>createReadStream</span><span>(</span>path<span>.</span><span>join</span><span>(</span>__dirname<span>,</span> <span>'../1.png'</span><span>)</span><span>)</span><span>;</span>\nfileStream<span>.</span><span>pipe</span><span>(</span>request<span>,</span> <span>{</span> end<span>:</span> <span>false</span> <span>}</span><span>)</span><span>;</span>\nfileStream<span>.</span><span>on</span><span>(</span><span>'end'</span><span>,</span> <span>function</span> <span>(</span><span>)</span> <span>{</span>\n    <span>// 写入尾部</span>\n    request<span>.</span><span>end</span><span>(</span><span>'\\r\\n--'</span> <span>+</span> boundaryKey <span>+</span> <span>'--'</span> <span>+</span> <span>'\\r\\n'</span><span>)</span><span>;</span>\n<span>}</span><span>)</span><span>;</span>\nrequest<span>.</span><span>on</span><span>(</span><span>'response'</span><span>,</span> <span>function</span><span>(</span><span>res</span><span>)</span> <span>{</span>\n    console<span>.</span><span>log</span><span>(</span>res<span>.</span>statusCode<span>)</span><span>;</span>\n<span>}</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br></div></div><h2 id=\"接收端\"> 接收端</h2>\n<div><pre><code><span>const</span> fs <span>=</span> <span>require</span><span>(</span><span>'fs'</span><span>)</span>\n<span>const</span> http <span>=</span> <span>require</span><span>(</span><span>'http'</span><span>)</span>\n<span>const</span> querystring <span>=</span> <span>require</span><span>(</span><span>'querystring'</span><span>)</span>\n<span>const</span> server <span>=</span> http<span>.</span><span>createServer</span><span>(</span><span>(</span><span>req<span>,</span> res</span><span>)</span> <span>=></span> <span>{</span>\n  <span>if</span> <span>(</span>req<span>.</span>url <span>===</span> <span>\"/files\"</span> <span>&amp;&amp;</span> req<span>.</span>method<span>.</span><span>toLowerCase</span><span>(</span><span>)</span> <span>===</span> <span>\"post\"</span><span>)</span> <span>{</span>\n    <span>parseFile</span><span>(</span>req<span>,</span> res<span>)</span>\n  <span>}</span>\n<span>}</span><span>)</span>\n<span>function</span> <span>parseFile</span><span>(</span><span>req<span>,</span> res</span><span>)</span> <span>{</span>\n  req<span>.</span><span>setEncoding</span><span>(</span><span>\"binary\"</span><span>)</span>\n  <span>let</span> body <span>=</span> <span>\"\"</span>\n  <span>let</span> fileName <span>=</span> <span>\"\"</span>\n  <span>// 边界字符</span>\n  <span>let</span> boundary <span>=</span> req<span>.</span>headers<span>[</span><span>'content-type'</span><span>]</span>\n    <span>.</span><span>split</span><span>(</span><span>'; '</span><span>)</span><span>[</span><span>1</span><span>]</span>\n    <span>.</span><span>replace</span><span>(</span><span>\"boundary=\"</span><span>,</span> <span>\"\"</span><span>)</span>\n  \n  req<span>.</span><span>on</span><span>(</span><span>\"data\"</span><span>,</span> <span>function</span><span>(</span><span>chunk</span><span>)</span> <span>{</span>\n    body <span>+=</span> chunk\n  <span>}</span><span>)</span>\n  req<span>.</span><span>on</span><span>(</span><span>\"end\"</span><span>,</span> <span>function</span><span>(</span><span>)</span> <span>{</span>\n    <span>// 按照分解符切分</span>\n    <span>const</span> list <span>=</span> body<span>.</span><span>split</span><span>(</span>boundary<span>)</span>\n    <span>let</span> contentType <span>=</span> <span>''</span>\n    <span>let</span> fileName <span>=</span> <span>''</span>\n    <span>for</span> <span>(</span><span>let</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> list<span>.</span>length<span>;</span> i<span>++</span><span>)</span> <span>{</span>\n      <span>if</span> <span>(</span>list<span>[</span>i<span>]</span><span>.</span><span>includes</span><span>(</span><span>'Content-Disposition'</span><span>)</span><span>)</span> <span>{</span>\n        <span>const</span> data <span>=</span> list<span>[</span>i<span>]</span><span>.</span><span>split</span><span>(</span><span>'\\r\\n'</span><span>)</span>\n        <span>for</span> <span>(</span><span>let</span> j <span>=</span> <span>0</span><span>;</span> j <span>&lt;</span> data<span>.</span>length<span>;</span> j<span>++</span><span>)</span> <span>{</span>\n          <span>// 从头部拆分出名字和类型</span>\n          <span>if</span> <span>(</span>data<span>[</span>j<span>]</span><span>.</span><span>includes</span><span>(</span><span>'Content-Disposition'</span><span>)</span><span>)</span> <span>{</span>\n            <span>const</span> info <span>=</span> data<span>[</span>j<span>]</span><span>.</span><span>split</span><span>(</span><span>':'</span><span>)</span><span>[</span><span>1</span><span>]</span><span>.</span><span>split</span><span>(</span><span>';'</span><span>)</span>\n            fileName <span>=</span> info<span>[</span>info<span>.</span>length <span>-</span> <span>1</span><span>]</span><span>.</span><span>split</span><span>(</span><span>'='</span><span>)</span><span>[</span><span>1</span><span>]</span><span>.</span><span>replace</span><span>(</span><span><span>/</span><span>\"</span><span>/</span><span>g</span></span><span>,</span> <span>''</span><span>)</span>\n            console<span>.</span><span>log</span><span>(</span>fileName<span>)</span>\n          <span>}</span>\n          <span>if</span> <span>(</span>data<span>[</span>j<span>]</span><span>.</span><span>includes</span><span>(</span><span>'Content-Type'</span><span>)</span><span>)</span> <span>{</span>\n            contentType <span>=</span> data<span>[</span>j<span>]</span><span>;</span>\n            console<span>.</span><span>log</span><span>(</span>data<span>[</span>j<span>]</span><span>.</span><span>split</span><span>(</span><span>':'</span><span>)</span><span>[</span><span>1</span><span>]</span><span>)</span>\n          <span>}</span>\n        <span>}</span>\n      <span>}</span>\n    <span>}</span>\n    <span>// 去除前面的请求头</span>\n    <span>const</span> start <span>=</span> body<span>.</span><span>toString</span><span>(</span><span>)</span><span>.</span><span>indexOf</span><span>(</span>contentType<span>)</span> <span>+</span> contentType<span>.</span>length <span>+</span> <span>4</span> <span>// 有多\\r\\n\\r\\n</span>\n    <span>const</span> startBinary <span>=</span> body<span>.</span><span>toString</span><span>(</span><span>)</span><span>.</span><span>substring</span><span>(</span>start<span>)</span>\n    <span>const</span> end <span>=</span> startBinary<span>.</span><span>indexOf</span><span>(</span><span>\"--\"</span> <span>+</span> boundary <span>+</span> <span>\"--\"</span><span>)</span> <span>-</span> <span>2</span> <span>// 前面有多\\r\\n</span>\n     <span>// 去除后面的分隔符</span>\n    <span>const</span> binary <span>=</span> startBinary<span>.</span><span>substring</span><span>(</span><span>0</span><span>,</span> end<span>)</span>\n    <span>const</span> bufferData <span>=</span> Buffer<span>.</span><span>from</span><span>(</span>binary<span>,</span> <span>\"binary\"</span><span>)</span>\n    fs<span>.</span><span>writeFile</span><span>(</span>fileName<span>,</span> bufferData<span>,</span> <span>function</span><span>(</span><span>err</span><span>)</span> <span>{</span>\n      res<span>.</span><span>end</span><span>(</span><span>\"sucess\"</span><span>)</span>\n    <span>}</span><span>)</span>\n  <span>}</span><span>)</span>\n<span>}</span>\n\nserver<span>.</span><span>listen</span><span>(</span><span>3333</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "webpack",
      "url": "https://x-vic.gitee.io/code/code/views/JS/webpack/",
      "id": "https://x-vic.gitee.io/code/code/views/JS/webpack/",
      "content_html": "<p>本文部分摘录<a href=\"https://segmentfault.com/a/1190000023016347\" target=\"_blank\" rel=\"noopener noreferrer\">webpack 系列</a></p>\n<h2 id=\"loader\"> loader</h2>\n<p>loader 文件处理器是一个 CommonJs 风格的函数，该函数接收一个 String/Buffer 类型的入参，并返回一个 String/Buffer 类型的返回值。</p>\n<h3 id=\"同步-loader\"> 同步 loader</h3>\n<div><pre><code><span>// content：文件内容；map：sourcemap；meta：一些源信息</span>\nmodule<span>.</span><span>exports</span> <span>=</span> <span>function</span><span>(</span><span>content<span>,</span> map<span>,</span> meta</span><span>)</span> <span>{</span>\n  <span>// 一些同步操作</span>\n  outputContent <span>=</span> <span>syncFn</span><span>(</span>content<span>)</span>\n  <span>return</span> outputContent\n<span>}</span>\n\n<span>// 如果返回结果只有一个，也可以直接使用 return 返回结果。但是，如果有些情况下还需要返回其他内容，如 sourceMap 或是 AST 语法树，这个时候可以借助 webpack 提供的 api this.callback</span>\nmodule<span>.</span><span>exports</span> <span>=</span> <span>function</span><span>(</span><span>content<span>,</span> map<span>,</span> meta</span><span>)</span> <span>{</span>\n  <span>this</span><span>.</span><span>callback</span><span>(</span>\n    err<span>:</span> Error <span>|</span> <span>null</span><span>,</span>\n    content<span>:</span> string <span>|</span> Buffer<span>,</span>\n    sourceMap<span>?</span><span>:</span> SourceMap<span>,</span>\n    meta<span>?</span><span>:</span> any\n  <span>)</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><h3 id=\"异步-loader\"> 异步 loader</h3>\n<p>异步 loader，使用 <code>this.async</code> 来获取 <code>callback</code> 函数。</p>\n<div><pre><code>module<span>.</span><span>exports</span> <span>=</span> <span>function</span><span>(</span><span>source</span><span>)</span> <span>{</span>\n  <span>var</span> callback <span>=</span> <span>this</span><span>.</span><span>async</span><span>(</span><span>)</span>\n  <span>// 做异步的事</span>\n  <span>asyncFn</span><span>(</span>content<span>,</span> <span>function</span><span>(</span><span>err<span>,</span> result</span><span>)</span> <span>{</span>\n    <span>if</span> <span>(</span>err<span>)</span> <span>return</span> <span>callback</span><span>(</span>err<span>)</span>\n    <span>callback</span><span>(</span><span>null</span><span>,</span> result<span>)</span>\n  <span>}</span><span>)</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div><h3 id=\"一个简单的-md-loader-示例\"> 一个简单的 md-loader 示例</h3>\n<div><pre><code><span>const</span> marked <span>=</span> <span>require</span><span>(</span><span>'marked'</span><span>)</span>\n\n<span>const</span> loaderUtils <span>=</span> <span>require</span><span>(</span><span>'loader-utils'</span><span>)</span>\nmodule<span>.</span><span>exports</span> <span>=</span> <span>function</span><span>(</span><span>content</span><span>)</span> <span>{</span>\n  <span>// 有缓存的情况下，合理利用缓存</span>\n  <span>this</span><span>.</span>cacheable <span>&amp;&amp;</span> <span>this</span><span>.</span><span>cacheable</span><span>(</span><span>)</span>\n  <span>const</span> options <span>=</span> loaderUtils<span>.</span><span>getOptions</span><span>(</span><span>this</span><span>)</span>\n  <span>try</span> <span>{</span>\n    marked<span>.</span><span>setOptions</span><span>(</span>options<span>)</span>\n    <span>return</span> <span>marked</span><span>(</span>content<span>)</span>\n  <span>}</span> <span>catch</span> <span>(</span>err<span>)</span> <span>{</span>\n    <span>this</span><span>.</span><span>emitError</span><span>(</span>err<span>)</span>\n    <span>return</span> <span>null</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br></div></div><h2 id=\"插件\"> 插件</h2>\n<p>通过插件我们可以扩展webpack，在合适的时机通过Webpack提供的 API 改变输出结果，使webpack可以执行更广泛的任务，拥有更强的构建能力。</p>\n<h3 id=\"插件结构\"> 插件结构</h3>\n<ol>\n<li>读取配置的过程中会先执行 new HelloPlugin(options) 初始化一个 HelloPlugin 获得其实例</li>\n<li>初始化 compiler 对象后调用 HelloPlugin.apply(compiler) 给插件实例传入 compiler 对象</li>\n<li>插件实例在获取到 compiler 对象后，就可以通过 compiler.plugin(事件名称, 回调函数) 监听到 Webpack 广播出来的事件</li>\n</ol>\n<div><pre><code><span>class</span> <span>HelloPlugin</span> <span>{</span>\n  <span>// 配置处理</span>\n  <span>constructor</span><span>(</span><span>options</span><span>)</span> <span>{</span><span>}</span>\n  <span>// Webpack 会调用这个方法给插件实例传入 compiler 对象</span>\n  <span>apply</span><span>(</span><span>compiler</span><span>)</span> <span>{</span>\n    <span>// 在emit阶段插入钩子函数，用于特定时机处理额外的逻辑；</span>\n    compiler<span>.</span>hooks<span>.</span>emit<span>.</span><span>tap</span><span>(</span><span>'HelloPlugin'</span><span>,</span> <span>(</span><span>compilation</span><span>)</span> <span>=></span> <span>{</span>\n      <span>// 在功能流程完成后可以调用 webpack 提供的回调函数；</span>\n    <span>}</span><span>)</span>\n    <span>// 监听 webpack 发射出来的 emit 事件</span>\n    compiler<span>.</span><span>plugin</span><span>(</span><span>'emit'</span><span>,</span> <span>function</span> <span>(</span><span>compilation<span>,</span> callback</span><span>)</span> <span>{</span>\n      <span>// 支持处理逻辑</span>\n      <span>// 处理完毕后执行 callback 以通知 Webpack</span>\n      <span>// 如果不执行 callback，运行流程将会一直卡在这不往下执行</span>\n      <span>callback</span><span>(</span><span>)</span>\n    <span>}</span><span>)</span>\n  <span>}</span>\n<span>}</span>\n\nmodule<span>.</span>exports <span>=</span> HelloPlugin\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br></div></div><h3 id=\"构建流程\"> 构建流程</h3>\n<ol>\n<li>\n<p>校验配置文件 ：读取命令行传入或者 webpack.config.js 文件，初始化本次构建的配置参数</p>\n</li>\n<li>\n<p>生成 <code>Compiler</code> 对象：执行配置文件中的插件实例化语句 new MyWebpackPlugin()，为 webpack 事件流挂上自定义 hooks</p>\n</li>\n<li>\n<p>进入 entryOption 阶段：webpack 开始读取配置的 Entries，递归遍历所有的入口文件</p>\n</li>\n<li>\n<p>run/watch：如果运行在 watch 模式则执行 watch 方法，否则执行 run 方法</p>\n</li>\n<li>\n<p>compilation：创建 Compilation 对象回调 compilation 相关钩子，依次进入每一个入口文件(entry)，使用 loader 对文件进行编译。通过 compilation 我可以可以读取到 module 的 resource（资源路径）、loaders（使用的 loader）等信息。再将编译好的文件内容使用 acorn 解析生成 AST 静态语法树。然后递归、重复的执行这个过程，\n所有模块和和依赖分析完成后，执行 compilation 的 seal 方法对每个 chunk 进行整理、优化、封装    <strong>webpack_require</strong> 来模拟模块化操作</p>\n</li>\n<li>\n<p>emit：所有文件的编译及转化都已经完成，包含了最终输出的资源，我们可以在传入事件回调的 compilation.assets 上拿到所需数据，其中包括即将输出的资源、代码块 Chunk 等等信息。</p>\n</li>\n</ol>\n<h3 id=\"compiler-与-compilation\"> compiler 与 compilation</h3>\n<p>compiler 对象包含了当前运行 webpack 的配置，包括 entry、output、loaders 等配置，这个对象在启动 webpack 时被实例化，而且是全局唯一的。plugin 可以通过该对象获取到 webpack 的配置信息进行处理。</p>\n<p>compilation 的职责就是构建模块和 chunk，并利用插件优化构建过程。它和 compiler 用法相同，钩子类型不同，也可以在某些钩子上访问 tapAsync 和 tapPromise。</p>\n<h2 id=\"简单实现打包器\"> 简单实现打包器</h2>\n<p>先来看看 webpack 的整体运行流程：</p>\n<ol>\n<li>读取参数</li>\n<li>实例化 Compiler</li>\n<li>entryOption 阶段，读取入口文件</li>\n<li>Loader 编译对应文件，解析成 AST</li>\n<li>找到对应依赖，递归编译处理，生成 chunk</li>\n<li>输出到 dist</li>\n</ol>\n<p>下边的简单实现流程为：</p>\n<ol>\n<li>解析 entry，得到 dependencies、code</li>\n<li>解析 entry 的过程中遇到依赖，则回到第一步，直到得到所有文件的路径、依赖、代码信息</li>\n<li>根据上面得到的所有文件信息，生成 bundle</li>\n<li>调用自定义的 require 函数，传入文件路径</li>\n<li>eval code 注入 require 函数</li>\n</ol>\n<div><pre><code><span>const</span> fs <span>=</span> <span>require</span><span>(</span><span>'fs'</span><span>)</span>\n<span>const</span> path <span>=</span> <span>require</span><span>(</span><span>'path'</span><span>)</span>\n<span>const</span> parser <span>=</span> <span>require</span><span>(</span><span>'@babel/parser'</span><span>)</span> <span>//解析成ast</span>\n<span>const</span> traverse <span>=</span> <span>require</span><span>(</span><span>'@babel/traverse'</span><span>)</span><span>.</span>default <span>//遍历ast</span>\n<span>const</span> <span>{</span> transformFromAst <span>}</span> <span>=</span> <span>require</span><span>(</span><span>'@babel/core'</span><span>)</span> <span>//ES6转换ES5</span>\nmodule<span>.</span>exports <span>=</span> <span>class</span> <span>Webpack</span> <span>{</span>\n  <span>constructor</span><span>(</span><span>options</span><span>)</span> <span>{</span>\n    <span>const</span> <span>{</span> entry<span>,</span> output <span>}</span> <span>=</span> options\n    <span>this</span><span>.</span>entry <span>=</span> entry\n    <span>this</span><span>.</span>output <span>=</span> output\n    <span>this</span><span>.</span>modulesArr <span>=</span> <span>[</span><span>]</span>\n  <span>}</span>\n  <span>// 生成一个大对象，键为文件路径，每个键包含该文件的依赖和代码字符</span>\n  <span>run</span><span>(</span><span>)</span> <span>{</span>\n    <span>const</span> info <span>=</span> <span>this</span><span>.</span><span>build</span><span>(</span><span>this</span><span>.</span>entry<span>)</span>\n    <span>this</span><span>.</span>modulesArr<span>.</span><span>push</span><span>(</span>info<span>)</span>\n    <span>for</span> <span>(</span><span>let</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>this</span><span>.</span>modulesArr<span>.</span>length<span>;</span> i<span>++</span><span>)</span> <span>{</span>\n      <span>// 判断有依赖对象,递归解析所有依赖项</span>\n      <span>const</span> item <span>=</span> <span>this</span><span>.</span>modulesArr<span>[</span>i<span>]</span>\n      <span>const</span> <span>{</span> dependencies <span>}</span> <span>=</span> item\n      <span>if</span> <span>(</span>dependencies<span>)</span> <span>{</span>\n        <span>for</span> <span>(</span><span>let</span> j <span>in</span> dependencies<span>)</span> <span>{</span>\n          <span>this</span><span>.</span>modulesArr<span>.</span><span>push</span><span>(</span><span>this</span><span>.</span><span>build</span><span>(</span>dependencies<span>[</span>j<span>]</span><span>)</span><span>)</span>\n        <span>}</span>\n      <span>}</span>\n    <span>}</span>\n    <span>//数组结构转换</span>\n    <span>const</span> obj <span>=</span> <span>{</span><span>}</span>\n    <span>this</span><span>.</span>modulesArr<span>.</span><span>forEach</span><span>(</span><span>(</span><span>item</span><span>)</span> <span>=></span> <span>{</span>\n      obj<span>[</span>item<span>.</span>entryFile<span>]</span> <span>=</span> <span>{</span>\n        dependencies<span>:</span> item<span>.</span>dependencies<span>,</span>\n        code<span>:</span> item<span>.</span>code<span>,</span>\n      <span>}</span>\n    <span>}</span><span>)</span>\n    <span>this</span><span>.</span><span>emitFile</span><span>(</span>obj<span>)</span>\n  <span>}</span>\n  <span>build</span><span>(</span><span>entryFile</span><span>)</span> <span>{</span>\n    <span>const</span> conts <span>=</span> fs<span>.</span><span>readFileSync</span><span>(</span>entryFile<span>,</span> <span>'utf-8'</span><span>)</span>\n    <span>const</span> ast <span>=</span> parser<span>.</span><span>parse</span><span>(</span>conts<span>,</span> <span>{</span>\n      sourceType<span>:</span> <span>'module'</span><span>,</span>\n    <span>}</span><span>)</span>\n    <span>//  console.log(ast)</span>\n    <span>// 遍历所有的 import 模块,存入dependecies</span>\n    <span>const</span> dependencies <span>=</span> <span>{</span><span>}</span>\n    <span>traverse</span><span>(</span>ast<span>,</span> <span>{</span>\n      <span>//  类型为 ImportDeclaration 的 AST 节点，</span>\n      <span>// 其实就是我们的 import xxx from xxxx</span>\n      <span>ImportDeclaration</span><span>(</span><span><span>{</span> node <span>}</span></span><span>)</span> <span>{</span>\n        <span>const</span> newPath <span>=</span>\n          <span>'./'</span> <span>+</span> path<span>.</span><span>join</span><span>(</span>path<span>.</span><span>dirname</span><span>(</span>entryFile<span>)</span><span>,</span> node<span>.</span>source<span>.</span>value<span>)</span>\n        dependencies<span>[</span>node<span>.</span>source<span>.</span>value<span>]</span> <span>=</span> newPath\n        <span>// console.log(dependencies)</span>\n      <span>}</span><span>,</span>\n    <span>}</span><span>)</span>\n    <span>// 将转化后 ast 的代码重新转化成代码</span>\n    <span>// 并通过配置 @babel/preset-env 预置插件编译成 es5</span>\n    <span>const</span> <span>{</span> code <span>}</span> <span>=</span> <span>transformFromAst</span><span>(</span>ast<span>,</span> <span>null</span><span>,</span> <span>{</span>\n      presets<span>:</span> <span>[</span><span>'@babel/preset-env'</span><span>]</span><span>,</span>\n    <span>}</span><span>)</span>\n    <span>return</span> <span>{</span>\n      entryFile<span>,</span>\n      dependencies<span>,</span>\n      code<span>,</span>\n    <span>}</span>\n  <span>}</span>\n  <span>emitFile</span><span>(</span><span>allInfo</span><span>)</span> <span>{</span>\n    <span>//生成bundle.js</span>\n    <span>const</span> filePath <span>=</span> path<span>.</span><span>join</span><span>(</span><span>this</span><span>.</span>output<span>.</span>path<span>,</span> <span>this</span><span>.</span>output<span>.</span>filename<span>)</span>\n    <span>const</span> allInfoString <span>=</span> <span>JSON</span><span>.</span><span>stringify</span><span>(</span>allInfo<span>)</span>\n    <span>const</span> bundle <span>=</span> <span><span>`</span><span>(function(modules){\n      // moduleId 为传入的 filename ，即模块的唯一标识符\n      function require(moduleId){\n        function localRequire(relativePath){\n          return require(modules[moduleId].dependencies[relativePath]) \n        }\n        var exports = {};\n        (function(require,exports,code){\n          eval(code)\n        })(localRequire,exports,modules[moduleId].code)\n        return exports;\n      }\n      require('</span><span><span>${</span><span>this</span><span>.</span>entry<span>}</span></span><span>')\n    })(</span><span><span>${</span>allInfoString<span>}</span></span><span>)</span><span>`</span></span>\n    fs<span>.</span><span>writeFileSync</span><span>(</span>filePath<span>,</span> bundle<span>,</span> <span>'utf-8'</span><span>)</span>\n  <span>}</span>\n<span>}</span>\n\n<span>// 使用如下：</span>\n<span>// new Webapck(options).run()</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br><span>82</span><br><span>83</span><br><span>84</span><br><span>85</span><br><span>86</span><br><span>87</span><br><span>88</span><br><span>89</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "数据结构与算法",
      "url": "https://x-vic.gitee.io/code/code/views/algorithm/",
      "id": "https://x-vic.gitee.io/code/code/views/algorithm/",
      "content_html": "",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "链表",
      "url": "https://x-vic.gitee.io/code/code/views/algorithm/linked-list/",
      "id": "https://x-vic.gitee.io/code/code/views/algorithm/linked-list/",
      "content_html": "<h2 id=\"链表访问\"> 链表访问</h2>\n<ol>\n<li><a href=\"https://leetcode-cn.com/problems/linked-list-cycle/\" target=\"_blank\" rel=\"noopener noreferrer\">#141 判断链表是否有环</a></li>\n</ol>\n<div><pre><code><span>var</span> <span>hasCycle</span> <span>=</span> <span>function</span><span>(</span><span>head</span><span>)</span> <span>{</span>\n    <span>// 判断是否为空节点节点</span>\n    <span>if</span> <span>(</span>head <span>==</span> <span>null</span><span>)</span> <span>return</span> <span>false</span>\n    <span>let</span> slowNode <span>=</span> head\n    <span>let</span> fastNode <span>=</span> head<span>.</span>next\n    <span>// 快慢节点进行追击，重合的时候证明有环</span>\n    <span>while</span><span>(</span>fastNode <span>!=</span> <span>null</span> <span>&amp;&amp;</span> fastNode<span>.</span>next <span>!=</span> <span>null</span> <span>&amp;&amp;</span> slowNode <span>!==</span> fastNode<span>)</span> <span>{</span>\n        slowNode <span>=</span> slowNode<span>.</span>next\n        fastNode <span>=</span> fastNode<span>.</span>next<span>.</span>next\n    <span>}</span>\n    <span>return</span> slowNode <span>===</span> fastNode\n<span>}</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br></div></div><ol start=\"2\">\n<li><a href=\"https://leetcode-cn.com/problems/linked-list-cycle-ii/\" target=\"_blank\" rel=\"noopener noreferrer\">#142 判断环状链表的环在何处</a></li>\n</ol>\n<div><pre><code><span>var</span> <span>detectCycle</span> <span>=</span> <span>function</span><span>(</span><span>head</span><span>)</span> <span>{</span>\n    <span>// 空节点</span>\n    <span>if</span> <span>(</span>head <span>==</span> <span>null</span><span>)</span> <span>return</span> <span>null</span>\n    \n    <span>let</span> slowNode <span>=</span> fastNode <span>=</span> head\n    <span>while</span><span>(</span>fastNode <span>!=</span> <span>null</span> <span>&amp;&amp;</span> fastNode<span>.</span>next <span>!=</span> <span>null</span><span>)</span> <span>{</span>\n        slowNode <span>=</span> slowNode<span>.</span>next\n        fastNode <span>=</span> fastNode<span>.</span>next<span>.</span>next\n        <span>// 在此处相遇，跳出循环</span>\n        <span>if</span> <span>(</span>fastNode <span>===</span> slowNode<span>)</span> <span>{</span>\n            <span>break</span>\n        <span>}</span>\n    <span>}</span>\n    <span>// 没有环</span>\n    <span>if</span> <span>(</span>fastNode <span>==</span> <span>null</span> <span>||</span> fastNode<span>.</span>next <span>==</span> <span>null</span><span>)</span> <span>return</span> <span>null</span>\n\n    slowNode <span>=</span> head\n    <span>while</span><span>(</span>slowNode <span>!==</span> fastNode<span>)</span> <span>{</span>\n        slowNode <span>=</span> slowNode<span>.</span>next\n        fastNode <span>=</span> fastNode<span>.</span>next\n    <span>}</span>\n    <span>return</span> slowNode\n<span>}</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br></div></div><ol start=\"3\">\n<li><a href=\"https://leetcode-cn.com/problems/happy-number/\" target=\"_blank\" rel=\"noopener noreferrer\">#202 快乐树</a></li>\n</ol>\n<div><pre><code><span>// 使用判断链表是否有环的思维来判断是否为快乐树</span>\n<span>var</span> <span>isHappy</span> <span>=</span> <span>function</span><span>(</span><span>n</span><span>)</span> <span>{</span>\n    <span>if</span> <span>(</span>n <span>===</span> <span>1</span><span>)</span> <span>return</span> <span>true</span>\n    <span>let</span> slowNode <span>=</span> fastNode <span>=</span> n\n    <span>while</span><span>(</span>fastNode <span>!==</span> <span>1</span> <span>&amp;&amp;</span> <span>getNext</span><span>(</span>fastNode<span>)</span> <span>!==</span> <span>1</span><span>)</span> <span>{</span>\n        slowNode <span>=</span> <span>getNext</span><span>(</span>slowNode<span>)</span>\n        fastNode <span>=</span> <span>getNext</span><span>(</span><span>getNext</span><span>(</span>fastNode<span>)</span><span>)</span>\n        <span>if</span> <span>(</span>slowNode <span>===</span> fastNode<span>)</span> <span>break</span>\n    <span>}</span>\n    <span>// 如果 fastNode 到底或 getNext(fastNode) 到底，则说明这个链表没有环</span>\n    <span>return</span> fastNode <span>===</span> <span>1</span> <span>||</span> <span>getNext</span><span>(</span>fastNode<span>)</span> <span>===</span> <span>1</span>\n<span>}</span><span>;</span>\n\n<span>function</span> <span>getNext</span><span>(</span><span>num</span><span>)</span> <span>{</span>\n    <span>return</span> <span>(</span>num <span>+</span> <span>''</span><span>)</span><span>.</span><span>split</span><span>(</span><span>''</span><span>)</span><span>.</span><span>reduce</span><span>(</span><span>(</span><span>prev<span>,</span> curr</span><span>)</span> <span>=></span> prev <span>+</span> curr <span>*</span> curr<span>,</span> <span>0</span><span>)</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><h2 id=\"链表的反转\"> 链表的反转</h2>\n<ol>\n<li><a href=\"https://leetcode-cn.com/problems/reverse-linked-list/\" target=\"_blank\" rel=\"noopener noreferrer\">#206 反转链表</a></li>\n</ol>\n<div><pre><code><span>// 遍历解法</span>\n<span>var</span> <span>reverseList</span> <span>=</span> <span>function</span><span>(</span><span>head</span><span>)</span> <span>{</span>\n    <span>if</span> <span>(</span>head <span>==</span> <span>null</span><span>)</span> <span>return</span> head\n    <span>let</span> prev <span>=</span> <span>null</span>\n    <span>let</span> curr <span>=</span> head\n    <span>let</span> next <span>=</span> head<span>.</span>next\n\n    <span>while</span> <span>(</span>curr <span>!=</span> <span>null</span><span>)</span> <span>{</span>\n        curr<span>.</span>next <span>=</span> prev\n        prev <span>=</span> curr\n        <span>;</span><span>(</span>curr <span>=</span> next<span>)</span> <span>&amp;&amp;</span> <span>(</span>next <span>=</span> next<span>.</span>next<span>)</span>\n    <span>}</span>\n    <span>return</span> prev\n<span>}</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br></div></div><div><pre><code><span>// 递归解法</span>\n<span>// 这是一个递归回溯过程，所以考虑问题的时候要从最小单位来考虑，此处的最小单位为 最后一个节点指向null</span>\n<span>var</span> <span>reverseList</span> <span>=</span> <span>function</span><span>(</span><span>head</span><span>)</span> <span>{</span>\n    <span>if</span> <span>(</span>head <span>==</span> <span>null</span> <span>||</span> head<span>.</span>next <span>==</span> <span>null</span><span>)</span> <span>return</span> head\n    <span>const</span> tail <span>=</span> head<span>.</span>next\n    <span>const</span> list <span>=</span> <span>reverseList</span><span>(</span>head<span>.</span>next<span>)</span>\n    <span>// 本质上，head 从 tail 手上接过来的就是一个 null</span>\n    <span>// head.next = tail.next</span>\n    head<span>.</span>next <span>=</span> <span>null</span>\n    tail<span>.</span>next <span>=</span> head\n    <span>return</span> list\n<span>}</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br></div></div><ol start=\"2\">\n<li><a href=\"https://leetcode-cn.com/problems/reverse-linked-list-ii/\" target=\"_blank\" rel=\"noopener noreferrer\">#92 给你单链表的头指针 head 和两个整数 left 和 right ，其中 left &lt;= right 。请你反转从位置 left 到位置 right 的链表节点，返回 反转后的链表</a></li>\n</ol>\n<div><pre><code><span>var</span> <span>reverseBetween</span> <span>=</span> <span>function</span><span>(</span><span>head<span>,</span> m<span>,</span> n</span><span>)</span> <span>{</span>\n    <span>if</span> <span>(</span>m <span>===</span> <span>1</span><span>)</span> <span>return</span> <span>reverseN</span><span>(</span>head<span>,</span> n<span>)</span>\n\n    <span>// 相对于 head.next，翻转区间应该是 [m - 1, n - 1]</span>\n    head<span>.</span>next <span>=</span> <span>reverseBetween</span><span>(</span>head<span>.</span>next<span>,</span> m <span>-</span> <span>1</span><span>,</span> n <span>-</span> <span>1</span><span>)</span>\n    <span>return</span> head\n<span>}</span><span>;</span>\n\n<span>let</span> successor <span>=</span> <span>null</span>\n\n<span>function</span> <span>reverseN</span><span>(</span><span>head<span>,</span> n</span><span>)</span> <span>{</span>\n  <span>if</span> <span>(</span>n <span>===</span> <span>1</span><span>)</span> <span>{</span>\n    successor <span>=</span> head<span>.</span>next\n    <span>return</span> head\n  <span>}</span>\n  <span>const</span> list <span>=</span> <span>reverseN</span><span>(</span>head<span>.</span>next<span>,</span> n <span>-</span> <span>1</span><span>)</span>\n  head<span>.</span>next<span>.</span>next <span>=</span> head\n  head<span>.</span>next <span>=</span> successor\n  <span>return</span> list\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br></div></div><ol start=\"3\">\n<li><a href=\"https://leetcode-cn.com/problems/reverse-nodes-in-k-group/\" target=\"_blank\" rel=\"noopener noreferrer\">#25 K个一组翻转链表</a></li>\n</ol>\n<div><pre><code><span>function</span> <span>reverseKGroup</span><span>(</span><span>head<span>,</span> k</span><span>)</span> <span>{</span>\n  <span>if</span> <span>(</span>head <span>==</span> <span>null</span><span>)</span> <span>return</span> <span>null</span>\n  <span>let</span> a <span>=</span> b <span>=</span> head\n  <span>// 循环有两个目的：1、判断个数是否大于 k;2、得到翻转的终止节点</span>\n  <span>for</span> <span>(</span><span>let</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> k<span>;</span> i<span>++</span><span>)</span> <span>{</span>\n    <span>// 个数不足，无需反转</span>\n    <span>if</span> <span>(</span>b <span>==</span> <span>null</span><span>)</span> <span>return</span> head\n    b <span>=</span> b<span>.</span>next\n  <span>}</span>\n  <span>const</span> newHead <span>=</span> <span>reverse</span><span>(</span>a<span>,</span> b<span>)</span>\n  a<span>.</span>next <span>=</span> <span>reverseKGroup</span><span>(</span>b<span>,</span> k<span>)</span>\n  <span>return</span> newHead\n<span>}</span>\n\n<span>// 左闭右开，两个节点</span>\n<span>function</span> <span>reverse</span><span>(</span><span>head<span>,</span> end</span><span>)</span> <span>{</span>\n  <span>if</span> <span>(</span>head <span>==</span> <span>null</span><span>)</span> <span>return</span> head\n  <span>let</span> prev <span>=</span> <span>null</span><span>,</span> curr <span>=</span> head<span>,</span> next <span>=</span> head<span>.</span>next\n  <span>// 与反转整个链表唯一的不同点</span>\n  <span>while</span> <span>(</span>curr <span>!=</span> end<span>)</span> <span>{</span>\n    curr<span>.</span>next <span>=</span> prev\n    prev <span>=</span> curr\n    curr <span>=</span> next\n    curr <span>&amp;&amp;</span> <span>(</span>next <span>=</span> curr<span>.</span>next<span>)</span>\n  <span>}</span>\n  <span>return</span> prev\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br></div></div><ol start=\"4\">\n<li><a href=\"https://leetcode-cn.com/problems/rotate-list/\" target=\"_blank\" rel=\"noopener noreferrer\">#61 旋转链表</a></li>\n</ol>\n<div><pre><code><span>function</span> <span>rotateRight</span><span>(</span><span>head<span>,</span> k</span><span>)</span> <span>{</span>\n  <span>if</span> <span>(</span>head <span>==</span> <span>null</span> <span>||</span> head<span>.</span>next <span>==</span> <span>null</span><span>)</span> <span>return</span> head\n  <span>// 将链表变成一个环</span>\n  <span>let</span> curr <span>=</span> head<span>,</span> size <span>=</span> <span>1</span>\n  <span>while</span> <span>(</span>curr<span>.</span>next <span>!=</span> <span>null</span><span>)</span> <span>{</span>\n    curr <span>=</span> curr<span>.</span>next\n    size<span>++</span>\n  <span>}</span>\n  curr<span>.</span>next <span>=</span> head\n  <span>let</span> newHead <span>=</span> head<span>,</span> newTail <span>=</span> curr\n  <span>// 计算旋转的步数</span>\n  <span>const</span> times <span>=</span> size <span>-</span> <span>(</span>k <span>%</span> size<span>)</span>\n  <span>// 一步一步走</span>\n  <span>for</span> <span>(</span><span>let</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> times<span>;</span> i<span>++</span><span>)</span> <span>{</span>\n    newHead <span>=</span> newHead<span>.</span>next\n    newTail <span>=</span> newTail<span>.</span>next\n  <span>}</span>\n  <span>// 断开首尾的连接</span>\n  newTail<span>.</span>next <span>=</span> <span>null</span>\n  <span>return</span> newHead\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br></div></div><ol start=\"5\">\n<li><a href=\"https://leetcode-cn.com/problems/swap-nodes-in-pairs\" target=\"_blank\" rel=\"noopener noreferrer\">#24 两两交换链表中的节点</a></li>\n</ol>\n<div><pre><code></code></pre>\n<div></div></div><h2 id=\"链表节点的删除\"> 链表节点的删除</h2>\n<ol>\n<li><a href=\"https://leetcode-cn.com/problems/remove-nth-node-from-end-of-list\" target=\"_blank\" rel=\"noopener noreferrer\">#19 删除链表的倒数第 N 个结点</a></li>\n</ol>\n<div><pre><code></code></pre>\n<div></div></div><ol start=\"2\">\n<li><a href=\"https://leetcode-cn.com/problems/remove-duplicates-from-sorted-list\" target=\"_blank\" rel=\"noopener noreferrer\">#83 删除排序链表中的重复元素</a></li>\n</ol>\n<div><pre><code></code></pre>\n<div></div></div><ol start=\"3\">\n<li><a href=\"https://leetcode-cn.com/problems/remove-duplicates-from-sorted-list-ii\" target=\"_blank\" rel=\"noopener noreferrer\">#82 删除排序链表中的重复元素 II</a></li>\n</ol>\n<div><pre><code></code></pre>\n<div></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "队列",
      "url": "https://x-vic.gitee.io/code/code/views/algorithm/queue/",
      "id": "https://x-vic.gitee.io/code/code/views/algorithm/queue/",
      "content_html": "<ol>\n<li><a href=\"https://leetcode-cn.com/problems/partition-list\" target=\"_blank\" rel=\"noopener noreferrer\">#86 分隔链表</a></li>\n</ol>\n<div><pre><code></code></pre>\n<div></div></div><ol start=\"2\">\n<li><a href=\"https://leetcode-cn.com/problems/copy-list-with-random-pointer\" target=\"_blank\" rel=\"noopener noreferrer\">#138 复制带随机指针的链表</a></li>\n</ol>\n<div><pre><code></code></pre>\n<div></div></div><ol start=\"3\">\n<li><a href=\"https://leetcode-cn.com/problems/design-circular-queue\" target=\"_blank\" rel=\"noopener noreferrer\">#622 设计循环队列</a></li>\n</ol>\n<div><pre><code></code></pre>\n<div></div></div><ol start=\"4\">\n<li>\n<p><a href=\"https://leetcode-cn.com/problems/design-circular-deque\" target=\"_blank\" rel=\"noopener noreferrer\">#641 设计循环双端队列</a></p>\n</li>\n<li>\n<p><a href=\"https://leetcode-cn.com/problems/design-front-middle-back-queue\" target=\"_blank\" rel=\"noopener noreferrer\">#1670 设计前中后队列 </a></p>\n</li>\n<li>\n<p><a href=\"https://leetcode-cn.com/problems/number-of-recent-calls\" target=\"_blank\" rel=\"noopener noreferrer\">#933 最近的请求次数</a></p>\n</li>\n<li>\n<p><a href=\"https://leetcode-cn.com/problems/buddy-strings\" target=\"_blank\" rel=\"noopener noreferrer\">#859 亲密字符串</a></p>\n</li>\n<li>\n<p><a href=\"https://leetcode-cn.com/problems/lemonade-change\" target=\"_blank\" rel=\"noopener noreferrer\">#860 柠檬水找零</a></p>\n</li>\n<li>\n<p><a href=\"https://leetcode-cn.com/problems/pancake-sorting\" target=\"_blank\" rel=\"noopener noreferrer\">#969 煎饼排序</a></p>\n</li>\n<li>\n<p><a href=\"https://leetcode-cn.com/problems/task-scheduler\" target=\"_blank\" rel=\"noopener noreferrer\">#621 任务调度器</a></p>\n</li>\n</ol>\n",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "applicative",
      "url": "https://x-vic.gitee.io/code/code/views/functional/applicative/",
      "id": "https://x-vic.gitee.io/code/code/views/functional/applicative/",
      "content_html": "<blockquote>\n<p>applicative functor 是实现了 ap 方法的 pointed functor</p>\n</blockquote>\n<blockquote>\n<p>ap 就是这样一种函数，能够把一个 functor 的函数值应用到另一个 functor 的值上</p>\n</blockquote>\n<h2 id=\"瓶中之船\"> 瓶中之船</h2>\n<p>先看下面这个简单的加法运算</p>\n<div><pre><code><span>// 这样是行不通的，因为 2 和 3 都藏在瓶子里。</span>\n<span>add</span><span>(</span>Container<span>.</span><span>of</span><span>(</span><span>2</span><span>)</span><span>,</span> Container<span>.</span><span>of</span><span>(</span><span>3</span><span>)</span><span>)</span><span>;</span>\n<span>//NaN</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br></div></div><p>我们想要对瓶中之船进行直接的操作，巧的是，我们已经有这样的工具存在了。那就是 <code>chain</code> 函数</p>\n<div><pre><code><span>// add 是接收两个参数的柯里化函数</span>\nContainer<span>.</span><span>of</span><span>(</span><span>2</span><span>)</span>\n  <span>.</span><span>chain</span><span>(</span>\n    <span>two</span> <span>=></span> Container<span>.</span><span>of</span><span>(</span><span>3</span><span>)</span><span>.</span><span>map</span><span>(</span><span>add</span><span>(</span>two<span>)</span><span>)</span>\n  <span>)</span>\n<span>// Container(5)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><p>只不过，这种方式有一个问题，那就是 <code>monad</code> 的顺序执行问题：所有的代码都只会在前一个 <code>monad</code> 执行完毕之后才执行。想想看，我们的这两个值足够强健且相互独立，如果仅仅为了满足 <code>monad</code> 的顺序要求而延迟 <code>Container(3)</code> 的创建，我觉得是非常没有必要的。</p>\n<p>事实上，当遇到这种问题的时候，要是能够无需借助这些不必要的函数和变量，以一种简明扼要的方式把一个 <code>functor</code> 的值应用到另一个上去就好了。</p>\n<h2 id=\"ap\"> ap</h2>\n<p>ap 是这样一种函数，能够把一个 functor（作为入参） 的<strong>函数值</strong>应用到另一个 functor（作为 this） 的值上。</p>\n<div><pre><code><span>class</span> <span>Container</span> <span>{</span>\n  <span>// 与 chain 相反，chain 自己提供转换函数，外部提供值；ap 外部提供转换函数，内部提供值；</span>\n  <span>// 与 chain 相同的是，它们都是使用外部的壳</span>\n  <span>ap</span><span>(</span><span>functor</span><span>)</span> <span>{</span>\n    <span>return</span> functor<span>.</span><span>map</span><span>(</span><span>this</span><span>.</span>__value<span>)</span>\n  <span>}</span>\n<span>}</span>\n\n<span>// 下面使用 ap</span>\nContainer<span>.</span><span>of</span><span>(</span><span>add</span><span>(</span><span>2</span><span>)</span><span>)</span><span>.</span><span>ap</span><span>(</span>Container<span>.</span><span>of</span><span>(</span><span>3</span><span>)</span><span>)</span>\n<span>// 等价于</span>\nContainer<span>.</span><span>of</span><span>(</span><span>2</span><span>)</span><span>.</span><span>map</span><span>(</span>add<span>)</span><span>.</span><span>ap</span><span>(</span>Container<span>.</span><span>of</span><span>(</span><span>3</span><span>)</span><span>)</span>\n\n<span>// 等待两个并行的异步任务</span>\nTask<span>.</span><span>of</span><span>(</span><span>(</span><span>name<span>,</span> age</span><span>)</span> <span>=></span> <span><span>`</span><span>name:</span><span><span>${</span>name<span>}</span></span><span>  age:</span><span><span>${</span>age<span>}</span></span><span>`</span></span><span>)</span><span>.</span><span>ap</span><span>(</span>Task<span>.</span><span>of</span><span>(</span>Http<span>.</span><span>get</span><span>(</span><span>'/name'</span><span>)</span><span>)</span><span>)</span><span>.</span><span>ap</span><span>(</span>Task<span>.</span><span>of</span><span>(</span>Http<span>.</span><span>get</span><span>(</span><span>'/age'</span><span>)</span><span>)</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br></div></div><h2 id=\"lift\"> lift</h2>\n<p>一个函数在调用的时候，如果被 <code>map</code> 包裹了，那么它就会从一个非 functor 函数转换为一个 functor 函数。我们把这个过程叫做 <code>lift</code>。</p>\n<p>一般情况下，普通函数更适合操作普通的数据类型而不是容器类型，在必要的时候再通过 <code>lift</code> 变为合适的容器去操作容器类型。这样做的好处是能得到更简单、重用性更高的函数，它们能够随需求而变，兼容任意 functor。</p>\n<p>我们来试试以一种 pointfree 的方式调用 applicative functor。因为 map 等价于 <code>of/ap</code>，那么我们就可以定义无数个 <code>ap</code> 通用函数。</p>\n<div><pre><code><span>const</span> liftA2 <span>=</span> <span>curry</span><span>(</span><span>(</span><span>fn<span>,</span> functor1<span>,</span> functor2</span><span>)</span> <span>=></span> functor1<span>.</span><span>map</span><span>(</span>fn<span>)</span><span>.</span><span>ap</span><span>(</span>functor2<span>)</span><span>)</span>\n\n<span>const</span> liftA3 <span>=</span> <span>curry</span><span>(</span><span>(</span><span>fn<span>,</span> functor1<span>,</span> functor2<span>,</span> functor3</span><span>)</span> <span>=></span> functor1<span>.</span><span>map</span><span>(</span>fn<span>)</span><span>.</span><span>ap</span><span>(</span>functor2<span>)</span><span>.</span><span>ap</span><span>(</span>functor3<span>)</span><span>)</span>\n\n<span>// liftA4, etc</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></div></div><p>接下来看看实际用例：</p>\n<div><pre><code><span>// checkEmail :: User -> Either String Email</span>\n<span>// checkName :: User -> Either String String</span>\n\n<span>//  createUser :: Email -> String -> IO User</span>\n<span>var</span> createUser <span>=</span> <span>curry</span><span>(</span><span>function</span><span>(</span><span>email<span>,</span> name</span><span>)</span> <span>{</span> <span>/* creating... */</span> <span>}</span><span>)</span><span>;</span>\n\nEither<span>.</span><span>of</span><span>(</span>createUser<span>)</span><span>.</span><span>ap</span><span>(</span><span>checkEmail</span><span>(</span>user<span>)</span><span>)</span><span>.</span><span>ap</span><span>(</span><span>checkName</span><span>(</span>user<span>)</span><span>)</span><span>;</span>\n<span>// Left(\"invalid email\")</span>\n\n<span>liftA2</span><span>(</span>createUser<span>,</span> <span>checkEmail</span><span>(</span>user<span>)</span><span>,</span> <span>checkName</span><span>(</span>user<span>)</span><span>)</span><span>;</span>\n<span>// Left(\"invalid email\")</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><p>上述两个执行语句是等价的，但是使用了 <code>liftA2</code> 的版本没有提到 <code>Either</code>，这就使得它更加通用灵活，因为不必与特定的数据类型耦合在一起。</p>\n",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "函数的组合",
      "url": "https://x-vic.gitee.io/code/code/views/functional/compose/",
      "id": "https://x-vic.gitee.io/code/code/views/functional/compose/",
      "content_html": "<blockquote>\n<p>实际生产中，我们经常需要对数据进行分阶段加工。在这个过程中，不可避免就会出现<code>a(b(c()))</code>的写法，这种写法不利于阅读以及修改，下面祭出函数组合的神器“compose”</p>\n</blockquote>\n<h2 id=\"compose\"> compose</h2>\n<p>compose 接收一系列的函数，返回一个新的函数。调用这个返回的函数时，会将右侧函数的返回值作为其左侧函数的参数传入，以此类推，直到执行完所有函数。</p>\n<div><pre><code><span>// 简单实现，不建议在生产环境中使用</span>\n<span>const</span> <span>compose</span> <span>=</span> <span>(</span><span><span>...</span>fns</span><span>)</span> <span>=></span> \n  fns<span>.</span>length <span>&lt;=</span> <span>1</span>\n    <span>?</span> fns<span>[</span><span>0</span><span>]</span>\n    ：fns<span>.</span><span>reduce</span><span>(</span><span>(</span><span>prev<span>,</span> curr</span><span>)</span> <span>=></span> <span>(</span><span><span>...</span>args</span><span>)</span> <span>=></span> <span>prev</span><span>(</span><span>curr</span><span>(</span><span>...</span>args<span>)</span><span>)</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "函子",
      "url": "https://x-vic.gitee.io/code/code/views/functional/functor/",
      "id": "https://x-vic.gitee.io/code/code/views/functional/functor/",
      "content_html": "<blockquote>\n<p>我们已经知道如何书写函数式的程序了，即通过管道把数据在一系列纯函数间传递的程序。我们也知道了，这些程序就是声明式的行为规范。但是，控制流（control flow）、异常处理（error handling）、异步操作（asynchronous actions）和状态（state）呢？还有更棘手的作用（effects）呢？本章将对上述这些抽象概念赖以建立的基础作一番探究。</p>\n</blockquote>\n<h2 id=\"一个最简单的函子\"> 一个最简单的函子</h2>\n<div><pre><code><span>class</span> <span>Container</span> <span>{</span>\n  <span>constructor</span><span>(</span><span>value</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span>__value <span>=</span> value\n  <span>}</span>\n  <span>static</span> <span>of</span><span>(</span>value<span>)</span> <span>{</span>\n    <span>return</span> <span>new</span> <span>Container</span><span>(</span>value<span>)</span>\n  <span>}</span>\n  <span>// 不同函子的 map 实现不一样，但它们的功能都是提供一个操作内部值(__value)的接口</span>\n  <span>map</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span><span>.</span>constructor<span>.</span><span>of</span><span>(</span><span>fn</span><span>(</span><span>this</span><span>.</span>__value<span>)</span><span>)</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br></div></div><div><p>Tips</p>\n<p>functor 是实现了 map 函数并遵守一些特定规则的容器类型。</p>\n</div>\n<h2 id=\"maybe\"> Maybe</h2>\n<p>最大名鼎鼎的 Maybe 大概是薛定谔的猫了。它代表一种不确定的状态（在我们打开容器之前）。</p>\n<div><pre><code><span>class</span> <span>Maybe</span> <span>{</span>\n  <span>constructor</span><span>(</span><span>value</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span>__value <span>=</span> value\n  <span>}</span>\n  <span>static</span> <span>of</span><span>(</span>value<span>)</span> <span>{</span>\n    <span>return</span> <span>new</span> <span>Maybe</span><span>(</span>value<span>)</span>\n  <span>}</span>\n  <span>isNothing</span><span>(</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span><span>.</span>__value <span>===</span> <span>null</span> <span>||</span> <span>this</span><span>.</span>__value <span>===</span> <span>undefined</span>\n  <span>}</span>\n  <span>// Maybe 的 map 会检测内部的值是否有效</span>\n  <span>map</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span><span>.</span><span>isNothing</span><span>(</span><span>)</span> <span>?</span> <span>this</span><span>.</span>constructor<span>.</span><span>of</span><span>(</span><span>null</span><span>)</span> <span>:</span> <span>this</span><span>.</span>constructor<span>.</span><span>of</span><span>(</span><span>fn</span><span>(</span><span>this</span><span>.</span>__value<span>)</span><span>)</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br></div></div><h3 id=\"一个安全取值的例子\"> 一个安全取值的例子</h3>\n<div><pre><code><span>const</span> <span>map</span> <span>=</span> <span>(</span><span>fn<span>,</span> functor</span><span>)</span> <span>=></span> functor<span>.</span><span>map</span><span>(</span>fn<span>)</span>\n\n<span>const</span> prop <span>=</span> <span>curry</span><span>(</span><span>(</span><span>prop<span>,</span> obj</span><span>)</span> <span>=></span> obj<span>[</span>prop<span>]</span><span>)</span>\n<span>const</span> safeprop <span>=</span> <span>curry</span><span>(</span><span>(</span><span>prop<span>,</span> obj</span><span>)</span> <span>=></span> Maybe<span>.</span><span>of</span><span>(</span>obj<span>[</span>prop<span>]</span><span>)</span><span>)</span>\n\n<span>const</span> getC <span>=</span> <span>compose</span><span>(</span><span>map</span><span>(</span><span>prop</span><span>(</span><span>'c'</span><span>)</span><span>)</span><span>,</span> <span>safeprop</span><span>(</span><span>'b'</span><span>)</span><span>,</span> <span>prop</span><span>(</span><span>'a'</span><span>)</span><span>)</span>\n\n<span>getC</span><span>(</span><span>{</span>\n  a<span>:</span> <span>{</span>\n    b<span>:</span> <span>{</span>\n      c<span>:</span> <span>2</span>\n    <span>}</span>\n  <span>}</span>\n<span>}</span><span>)</span>\n<span>// Maybe { __value: 2 }</span>\n\n<span>getC</span><span>(</span><span>{</span>\n  a<span>:</span> <span>{</span><span>}</span>\n<span>}</span><span>)</span>\n<span>// Maybe { __value: null }</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br></div></div><div><p>Tips</p>\n<p>实际当中，Maybe 最常用在那些可能会无法成功返回结果的函数中。<br>\n这个例子依然存在很严重的问题：如果每一个属性都要试探性地取值，那我们最终会得到一个嵌套多层地 Maybe。后面我们会来解决这个问题。</p>\n</div>\n<h3 id=\"maybe-2\"> maybe</h3>\n<p>我们最终是要拿到 Maybe 里面的值进行操作的，下面我们来定义一个 maybe 函数来处理最终结果</p>\n<div><pre><code><span>const</span> maybe <span>=</span> <span>curry</span><span>(</span><span>(</span><span>errMsg<span>,</span> fn<span>,</span> functor</span><span>)</span> <span>=></span> functor<span>.</span><span>isNothing</span><span>(</span><span>)</span> <span>?</span> errMsg <span>:</span> <span>fn</span><span>(</span>functor<span>.</span>__value<span>)</span><span>)</span>\n\n<span>// 延续上面安全取值的例子</span>\n<span>const</span> handleC <span>=</span> <span>compose</span><span>(</span><span>maybe</span><span>(</span><span>'失败了！'</span><span>,</span> <span>val</span> <span>=></span> val<span>)</span><span>,</span> getC<span>)</span>\n\n<span>handleC</span><span>(</span><span>{</span>\n  a<span>:</span> <span>{</span>\n    b<span>:</span> <span>{</span>\n      c<span>:</span> <span>2</span>\n    <span>}</span>\n  <span>}</span>\n<span>}</span><span>)</span>\n<span>// 2</span>\n<span>handleC</span><span>(</span><span>{</span>\n  a<span>:</span> <span>{</span><span>}</span>\n<span>}</span><span>)</span>\n<span>// 失败了！</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br></div></div><h2 id=\"either\"> Either</h2>\n<p>Either 函子是一个抽象类，用来进行错误处理，那就是返回一条有礼貌的的错误消息作为回应。<br>\nEither 本身不能使用，真正起作用的是它的两个子类：Left 和 Right。<br>\n下面看看它们的实现：</p>\n<div><pre><code><span>class</span> <span>Left</span> <span>{</span>\n  <span>constructor</span><span>(</span><span>value</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span>__value <span>=</span> value\n  <span>}</span>\n  <span>static</span> <span>of</span><span>(</span>value<span>)</span> <span>{</span>\n    <span>return</span> <span>new</span> <span>Left</span><span>(</span>value<span>)</span>\n  <span>}</span>\n  <span>// Left 会忽略 fn</span>\n  <span>map</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span>\n  <span>}</span>\n<span>}</span>\n\n<span>class</span> <span>Right</span> <span>{</span>\n  <span>constructor</span><span>(</span><span>value</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span>__value <span>=</span> value\n  <span>}</span>\n  <span>static</span> <span>of</span><span>(</span>value<span>)</span> <span>{</span>\n    <span>return</span> <span>new</span> <span>Right</span><span>(</span>value<span>)</span>\n  <span>}</span>\n  <span>map</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>return</span> Right<span>.</span><span>of</span><span>(</span><span>fn</span><span>(</span><span>this</span><span>.</span>__value<span>)</span><span>)</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br></div></div><h3 id=\"either-的实例\"> Either 的实例</h3>\n<div><pre><code><span>// 退 10 钱，看看余额够不够</span>\n<span>const</span> <span>withdrow</span> <span>=</span> <span>total</span> <span>=></span> total <span>-</span> <span>10</span> <span>>=</span> <span>0</span> <span>?</span> Right<span>.</span><span>of</span><span>(</span>total <span>-</span> <span>10</span><span>)</span> <span>:</span> Left<span>.</span><span>of</span><span>(</span><span>'没得退了！'</span><span>)</span>\n\n\n<span>withdrow</span><span>(</span><span>20</span><span>)</span>\n<span>// Right { __value: 10 }</span>\n<span>withdrow</span><span>(</span><span>5</span><span>)</span>\n<span>// Left { __value: '没得退了！' }</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div><h3 id=\"either-取出值\"> either 取出值</h3>\n<p>使用 Either 进行错误处理之后会有两种结果的函子出现，在不能确定函子类型的情况下，我们很难确定下一个函数怎么来处理上一个函数返回的值。<br>\n此时就可以祭出 either 辅助函数将 Either 中的值取出来，交给下一个函数处理。</p>\n<div><pre><code><span>const</span> either <span>=</span> <span>curry</span><span>(</span><span>(</span><span>leftFn<span>,</span> rightFn<span>,</span> functor</span><span>)</span> <span>=></span> <span>{</span>\n  <span>switch</span><span>(</span>functor<span>.</span>constructor<span>)</span> <span>{</span>\n    <span>case</span> Left<span>:</span> <span>return</span> <span>leftFn</span><span>(</span>functor<span>.</span>__value<span>)</span>\n    <span>case</span> Right<span>:</span> <span>return</span> <span>rightFn</span><span>(</span>functor<span>.</span>__value<span>)</span>\n  <span>}</span>\n<span>}</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><p>继续上一个例子：</p>\n<div><pre><code><span>const</span> withdrow2 <span>=</span> <span>compose</span><span>(</span>console<span>.</span>log<span>,</span> <span>either</span><span>(</span><span>val</span> <span>=></span> <span>'失败！！'</span> <span>+</span> val<span>,</span> <span>val</span> <span>=></span> <span>'成功！'</span> <span>+</span> val<span>)</span><span>,</span> withdrow<span>)</span>\n\n<span>withdrow2</span><span>(</span><span>20</span><span>)</span>\n<span>// 成功！10</span>\n<span>withdrow2</span><span>(</span><span>5</span><span>)</span>\n<span>// 失败！！没得退了！</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><h2 id=\"io\"> IO</h2>\n<blockquote>\n<p>现在我们用我们的纯函数去接触真是环境中的脏东西了。这个脏东西就是“副作用”。</p>\n</blockquote>\n<h3 id=\"处理副作用的办法\"> 处理副作用的办法</h3>\n<p>副作用会让函数的输出变得不可靠，而我们的编程希望使用纯函数来让代码变得透明可靠。采取的方式就是“<strong>延迟</strong>”，实际上的做法就是将副作用封印到一个函数中，在我们纯函数链条中不去使用它，而是将副作用使用交到调用者的手上。而我们的输入与输出都是纯的函数。</p>\n<h3 id=\"io-函子的实现\"> IO 函子的实现</h3>\n<div><pre><code><span>// IO 函子实际上是将副作用包裹在一个函数中延迟执行，这样一来，它还是一个纯函数</span>\n<span>class</span> <span>IO</span> <span>{</span>\n  <span>constructor</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span>unsafePerformIO <span>=</span> fn\n  <span>}</span>\n  <span>static</span> <span>of</span><span>(</span>fn<span>)</span> <span>{</span>\n    <span>return</span> <span>new</span> <span>IO</span><span>(</span>fn<span>)</span>\n  <span>}</span>\n  <span>map</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>// 与普通函子不同的是：普通函数调用 fn，而 IO 函子组合 fn</span>\n    <span>return</span> <span>IO</span><span>.</span><span>of</span><span>(</span><span>compose</span><span>(</span>fn<span>,</span> <span>this</span><span>.</span>unsafePerformIO<span>)</span><span>)</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br></div></div><h3 id=\"io-的应用实例\"> IO 的应用实例</h3>\n<div><pre><code><span>const</span> <span>$</span> <span>=</span> <span>selector</span> <span>=></span> <span>IO</span><span>.</span><span>of</span><span>(</span><span>(</span><span>)</span> <span>=></span> document<span>.</span><span>querySelectorAll</span><span>(</span>selector<span>)</span><span>)</span>\n\n<span>const</span> getValue <span>=</span> <span>compose</span><span>(</span><span>map</span><span>(</span><span>dom</span> <span>=></span> dom<span>.</span>value<span>)</span><span>,</span> <span>map</span><span>(</span><span>domList</span> <span>=></span> domList<span>[</span><span>0</span><span>]</span><span>)</span><span>,</span> $<span>)</span>\n\n<span>getValue</span><span>(</span><span>'#sb_form_q'</span><span>)</span><span>.</span><span>unsafePerformIO</span><span>(</span><span>)</span>\n<span>// 这段代码可以查看 bing 搜索框中的内容</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><h2 id=\"task-精密的时间胶囊\"> Task 精密的时间胶囊</h2>\n<p>除了IO读写这种阻塞式的副作用，还有一种常见的非阻塞式的副作用，即异步。<br>\n而将异步操作变纯的思路跟 IO 函子纯化副作用的思路一致，都是将副作用延迟执行。不同之处在于 IO 函子可以直接返回所需的值，而 Task 函子则需要传入函数，通过函数的参数来得到所需的值。<br>\n使用 Task 需要调用它的 fork 方法。</p>\n<h3 id=\"task-的简单实现\"> Task 的简单实现</h3>\n<div><pre><code><span>class</span> <span>Task</span> <span>{</span>\n  <span>constructor</span><span>(</span><span>computation</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span>fork <span>=</span> computation\n  <span>}</span>\n  <span>static</span> <span>of</span><span>(</span>resFn<span>)</span> <span>{</span>\n    <span>return</span> <span>new</span> <span>Task</span><span>(</span><span>(</span><span>_<span>,</span> resolve</span><span>)</span> <span>=></span> <span>resolve</span><span>(</span>resFn<span>)</span><span>)</span>\n  <span>}</span>\n  <span>// fn 要作用到 resolve 接收的参数上</span>\n  <span>map</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>const</span> fork <span>=</span> <span>this</span><span>.</span>fork\n    <span>return</span> <span>new</span> <span>Task</span><span>(</span><span>(</span><span>reject<span>,</span> resolve</span><span>)</span> <span>=></span> <span>fork</span><span>(</span>\n      <span>rejFn</span> <span>=></span> <span>reject</span><span>(</span>rejFn<span>)</span><span>,</span>\n      <span>resFn</span> <span>=></span> <span>resolve</span><span>(</span><span>fn</span><span>(</span>resFn<span>)</span><span>)</span>\n    <span>)</span><span>)</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><h3 id=\"使用-task-的例子\"> 使用 Task 的例子</h3>\n<div><pre><code><span>const</span> <span>delayPrint</span> <span>=</span> <span>(</span><span>)</span> <span>=></span> <span>new</span> <span>Task</span><span>(</span><span>(</span><span>reject<span>,</span> resolve</span><span>)</span> <span>=></span> <span>{</span>\n  <span>setTimeout</span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>resolve</span><span>(</span><span>'hehe'</span><span>)</span><span>,</span> <span>2000</span><span>)</span>\n<span>}</span><span>)</span>\n\n<span>const</span> getPrint <span>=</span> <span>compose</span><span>(</span><span>map</span><span>(</span><span>res</span> <span>=></span> res <span>+</span> <span>'!!!'</span><span>)</span><span>,</span> delayPrint<span>)</span>\n\n<span>// fork 方法执行的时候，异步动作才真正执行</span>\n<span>getPrint</span><span>(</span><span>)</span><span>.</span><span>fork</span><span>(</span>\n  <span>rej</span> <span>=></span> rej<span>,</span>\n  console<span>.</span>log\n<span>)</span>\n<span>// 2秒之后打印 hehe!!!</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br></div></div><h2 id=\"一个综合的例子-either、io、task\"> 一个综合的例子（Either、IO、Task）</h2>\n<ol>\n<li>判断用户输入的路径，返回不同的 Either(__value)</li>\n<li>Right 分支上读取文件，返回 Either(IO(unsafePerformIO))</li>\n<li>将文件内容传入异步任务，返回 Either(IO(Task))</li>\n</ol>\n<div><pre><code><span>const</span> either <span>=</span> <span>curry</span><span>(</span><span>(</span><span>leftFn<span>,</span> rightFn<span>,</span> functor</span><span>)</span> <span>=></span> <span>{</span>\n  <span>switch</span><span>(</span>functor<span>.</span>constructor<span>)</span> <span>{</span>\n    <span>case</span> Left<span>:</span> <span>return</span> <span>leftFn</span><span>(</span>functor<span>.</span>__value<span>)</span>\n    <span>case</span> Right<span>:</span> <span>return</span> <span>rightFn</span><span>(</span>functor<span>.</span>__value<span>)</span>\n  <span>}</span>\n<span>}</span><span>)</span>\n\n<span>const</span> <span>IOFn</span> <span>=</span> <span>filePath</span> <span>=></span> <span>new</span> <span>IO</span><span>(</span>\n  <span>(</span><span>)</span> <span>=></span> <span>readFileSync</span><span>(</span>filePath<span>,</span> <span>'utf-8'</span><span>)</span>\n<span>)</span>\n\n<span>const</span> <span>eitherFn</span> <span>=</span> <span>str</span> <span>=></span> str<span>.</span>length <span>>=</span> <span>14</span> <span>?</span> Right<span>.</span><span>of</span><span>(</span>str<span>)</span> <span>:</span> Left<span>.</span><span>of</span><span>(</span><span>'文件路径少于14个字符'</span><span>)</span>\n\n<span>const</span> <span>taskFn</span> <span>=</span> <span>content</span> <span>=></span> <span>new</span> <span>Task</span><span>(</span><span>(</span><span>reject<span>,</span> resolve</span><span>)</span> <span>=></span> <span>{</span>\n  <span>setTimeout</span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>resolve</span><span>(</span>content<span>)</span><span>,</span> <span>2000</span><span>)</span>\n<span>}</span><span>)</span>\n\n<span>// 直接使用这个函数的话会得到一个嵌套多层容器的结果，需要这般使用：res.__value.unsafePerformIO().fork(resFn, rejFn)</span>\n<span>// res.__value.unsafePerformIO().fork(resFn, rejFn) 这样的调用方式只适用 Right 分支；Left 分支只有一层 Either 容器</span>\n<span>const</span> asyncGetFile <span>=</span> <span>compose</span><span>(</span><span>map</span><span>(</span><span>map</span><span>(</span>taskFn<span>)</span><span>)</span><span>,</span> <span>map</span><span>(</span>IOFn<span>)</span><span>,</span> eitherFn<span>)</span>\n\nremoveNeedlessContainer <span>=</span> <span>compose</span><span>(</span><span>either</span><span>(</span><span>val</span> <span>=></span> val<span>,</span> <span>val</span> <span>=></span> val<span>.</span><span>unsafePerformIO</span><span>(</span><span>)</span><span>)</span><span>,</span> asyncGetFile<span>)</span>\n\n<span>removeNeedlessContainer</span><span>(</span><span>'./src/test.txt'</span><span>)</span><span>.</span><span>fork</span><span>(</span>\n  console<span>.</span>log<span>,</span>\n  console<span>.</span>log\n<span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br></div></div><div><p>Tips</p>\n<p>至此，四类常用的函子已经介绍完毕。可以延伸的话题还很多，例如 Task 与 Promise 的关系...这些暂不准备展开来讲。<br>\n在最后一个综合示例中我们可以看到一些别扭的地方，如 compose 中的嵌套 map、返回结果的多层容器嵌套。下面准备请出 monad 登场来解决这两个问题。</p>\n</div>\n",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "函数式编程",
      "url": "https://x-vic.gitee.io/code/code/views/functional/",
      "id": "https://x-vic.gitee.io/code/code/views/functional/",
      "content_html": "<p>函数式编程总结（使用 javascript 语言）。预计会有一下几块：</p>\n<ol>\n<li>函数参数处理</li>\n<li>函数组合</li>\n<li>函子</li>\n<li>monad functor</li>\n<li>applicative functor</li>\n<li>响应函数式编程</li>\n</ol>\n",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "函数输入处理",
      "url": "https://x-vic.gitee.io/code/code/views/functional/inputs/",
      "id": "https://x-vic.gitee.io/code/code/views/functional/inputs/",
      "content_html": "<h2 id=\"为什么要对函数的参数进行处理\"> 为什么要对函数的参数进行处理</h2>\n<p>多个参数的输入会增加函数的复杂性，这违背了<strong>一个函数只做一件事</strong>。</p>\n<h2 id=\"如何减少函数参数\"> 如何减少函数参数</h2>\n<p>我们可以利用闭包来收集参数，让函数延迟执行，等到函数参数收集完成，再最终执行函数</p>\n<h3 id=\"偏函数-partial\"> 偏函数(partial)</h3>\n<ol>\n<li>传入原始函数以及提前确定好的参数（能提前确定的参数一定要定义到靠前位置）</li>\n<li>返回新的函数</li>\n<li>调用新的函数，传入剩下的参数</li>\n</ol>\n<div><pre><code><span>const</span> <span>partial</span> <span>=</span> <span>(</span><span>fn<span>,</span> <span>...</span>presetArgs</span><span>)</span> <span>=></span>\n  <span>(</span><span><span>...</span>laterArgs</span><span>)</span> <span>=></span> \n    <span>fn</span><span>(</span><span>...</span>presetArgs<span>,</span> <span>...</span>laterArgs<span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br></div></div><h3 id=\"柯里化-currying\"> 柯里化(currying)</h3>\n<ol>\n<li>传入原始函数</li>\n<li>返回新的函数</li>\n<li>调用新的函数，传入提前确定好的参数（这个过程可以进行多次，直到参数收集完成）</li>\n</ol>\n<div><pre><code><span>const</span> <span>curry</span> <span>=</span> <span>(</span><span>fn<span>,</span> arity <span>=</span> fn<span>.</span>length<span>,</span> nextCurried</span><span>)</span> <span>=></span> \n  <span>(</span><span>nextCurried</span> <span>=</span> <span>prevArgs</span> <span>=></span> \n    <span>(</span><span><span>...</span>nextArgs</span><span>)</span> <span>=></span> <span>{</span>\n      <span>const</span> args <span>=</span> <span>[</span> <span>...</span>prevArgs<span>,</span> <span>...</span>nextArgs <span>]</span>\n      <span>return</span> args<span>.</span>length <span>>=</span> arity\n        <span>?</span> <span>fn</span><span>(</span><span>...</span>args<span>)</span>\n        <span>:</span> <span>nextCurried</span><span>(</span>args<span>)</span>\n    <span>}</span>\n  <span>)</span><span>(</span><span>[</span><span>]</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br></div></div><div><p>Tips</p>\n<p>这里我们只需要关注偏函数与柯里化的用法（这两个工具在几乎所有函数式编程的库里都已经实现），至于它们的实现原理，不用太过深究。</p>\n</div>\n",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "monad",
      "url": "https://x-vic.gitee.io/code/code/views/functional/monad/",
      "id": "https://x-vic.gitee.io/code/code/views/functional/monad/",
      "content_html": "<blockquote>\n<p>monad 是可以变扁（flatten）的 pointed functor。</p>\n</blockquote>\n<h2 id=\"容器嵌套引发的灾难\"> 容器嵌套引发的灾难</h2>\n<p>先看下面一个例子：</p>\n<div><pre><code><span>const</span> safeProp <span>=</span> <span>curry</span><span>(</span><span>(</span><span>prop<span>,</span> obj</span><span>)</span> <span>=></span> Maybe<span>.</span><span>of</span><span>(</span>obj<span>[</span>prop<span>]</span><span>)</span><span>)</span>\n\n<span>const</span> getD <span>=</span> <span>compose</span><span>(</span><span>map</span><span>(</span><span>map</span><span>(</span><span>map</span><span>(</span><span>safeProp</span><span>(</span><span>'d'</span><span>)</span><span>)</span><span>)</span><span>)</span><span>,</span> <span>map</span><span>(</span><span>map</span><span>(</span><span>safeProp</span><span>(</span><span>'c'</span><span>)</span><span>)</span><span>)</span><span>,</span> <span>map</span><span>(</span><span>safeProp</span><span>(</span><span>'b'</span><span>)</span><span>)</span><span>,</span> <span>safeProp</span><span>(</span><span>'a'</span><span>)</span><span>)</span>\n\n<span>getD</span><span>(</span><span>{</span> a<span>:</span> <span>{</span> b<span>:</span> <span>{</span> c<span>:</span> <span>{</span> d<span>:</span> <span>'d'</span> <span>}</span> <span>}</span> <span>}</span> <span>}</span><span>)</span>\n<span>// Maybe { __value: Maybe { __value: Maybe { __value: [Maybe] } } }</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><h2 id=\"join-来解围\"> join 来解围</h2>\n<p>往 Maybe 函子里面添加 join 方法来解开一层外衣（不同函子的 join 实现不一样）</p>\n<div><pre><code><span>// 依然用上面的例子</span>\n<span>class</span> <span>Maybe</span> <span>{</span>\n  <span>// ...</span>\n  <span>join</span><span>(</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span><span>.</span>__value\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><p>下面我们来重构上面的这个例子</p>\n<div><pre><code><span>const</span> <span>join</span> <span>=</span> <span>functor</span> <span>=></span> functor<span>.</span><span>join</span><span>(</span><span>)</span>\n\n<span>// 每当外套达到两件时，就用 join 脱掉一件</span>\n<span>const</span> getD <span>=</span> <span>compose</span><span>(</span>join<span>,</span> <span>map</span><span>(</span><span>safeProp</span><span>(</span><span>'d'</span><span>)</span><span>)</span><span>,</span> join<span>,</span> <span>map</span><span>(</span><span>safeProp</span><span>(</span><span>'c'</span><span>)</span><span>)</span><span>,</span> join<span>,</span> <span>map</span><span>(</span><span>safeProp</span><span>(</span><span>'b'</span><span>)</span><span>)</span><span>,</span> <span>safeProp</span><span>(</span><span>'a'</span><span>)</span><span>)</span>\n\n<span>getD</span><span>(</span><span>{</span> a<span>:</span> <span>{</span> b<span>:</span> <span>{</span> c<span>:</span> <span>{</span> d<span>:</span> <span>'d'</span> <span>}</span> <span>}</span> <span>}</span> <span>}</span><span>)</span>\n<span>// Maybe { __value: 'd' }</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><h2 id=\"chain-更进一步\"> chain 更进一步</h2>\n<p>我们总是在紧跟着 map 的后面调用 join。让我们把这个行为抽象到一个叫做 chain 的函数里。<br>\nchain 将 map 之后再 join 的行为整合到一起，从而简化我们的书写。</p>\n<div><pre><code><span>class</span> <span>Maybe</span> <span>{</span>\n  <span>// ...</span>\n  <span>chain</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span><span>.</span><span>map</span><span>(</span>fn<span>)</span><span>.</span><span>join</span><span>(</span><span>)</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><p>使用 chain 来重构上面的例子</p>\n<div><pre><code><span>const</span> chain <span>=</span> <span>curry</span><span>(</span><span>(</span><span>fn<span>,</span> functor</span><span>)</span> <span>=></span> functor<span>.</span><span>chain</span><span>(</span>fn<span>)</span><span>)</span>\n\n<span>const</span> getD <span>=</span> <span>compose</span><span>(</span><span>chain</span><span>(</span><span>safeProp</span><span>(</span><span>'d'</span><span>)</span><span>)</span><span>,</span> <span>chain</span><span>(</span><span>safeProp</span><span>(</span><span>'c'</span><span>)</span><span>)</span><span>,</span> <span>chain</span><span>(</span><span>safeProp</span><span>(</span><span>'b'</span><span>)</span><span>)</span><span>,</span> <span>safeProp</span><span>(</span><span>'a'</span><span>)</span><span>)</span>\n<span>// Maybe { __value: 'd' }</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><h2 id=\"其他函子的-chain-实现\"> 其他函子的 chain 实现</h2>\n<p>Either</p>\n<div><pre><code><span>class</span> <span>Left</span> <span>{</span>\n  <span>join</span><span>(</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span>\n  <span>}</span>\n  <span>chain</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span>\n  <span>}</span>\n<span>}</span>\n<span>class</span> <span>Right</span> <span>{</span>\n  <span>join</span><span>(</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span><span>.</span>__value\n  <span>}</span>\n  <span>chain</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span><span>.</span><span>map</span><span>(</span>fn<span>)</span><span>.</span><span>join</span><span>(</span><span>)</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><p>IO</p>\n<div><pre><code><span>class</span> <span>IO</span> <span>{</span>\n  <span>join</span><span>(</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span><span>.</span><span>unsafePerformIO</span><span>(</span><span>)</span>\n  <span>}</span>\n  <span>chain</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span><span>.</span><span>map</span><span>(</span>fn<span>)</span><span>.</span><span>join</span><span>(</span><span>)</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div><p>Task</p>\n<div><pre><code><span>class</span> <span>Task</span> <span>{</span>\n  <span>join</span><span>(</span><span>)</span> <span>{</span>\n    <span>const</span> fork <span>=</span> <span>this</span><span>.</span>fork\n    <span>return</span> <span>new</span> <span>Task</span><span>(</span><span>(</span><span>reject<span>,</span> resolve</span><span>)</span> <span>=></span> <span>fork</span><span>(</span>\n      <span>err</span> <span>=></span> <span>reject</span><span>(</span>err<span>)</span><span>,</span>\n      <span>res</span> <span>=></span> res<span>.</span><span>fork</span><span>(</span>reject<span>,</span> resolve<span>)</span>\n    <span>)</span><span>)</span>\n  <span>}</span>\n  <span>// 借助 map 和 join 方法（尝试用 . 的方式调用 chain 方法执行串行的两个任务看看，会有惊喜）</span>\n  <span>chain</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span><span>.</span><span>map</span><span>(</span>fn<span>)</span><span>.</span><span>join</span><span>(</span><span>)</span>\n  <span>}</span>\n  <span>// 完整实现</span>\n  <span>chain</span> <span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>const</span> fork <span>=</span> <span>this</span><span>.</span>fork\n    <span>return</span> <span>new</span> <span>Task</span><span>(</span><span>(</span><span>reject<span>,</span> resolve</span><span>)</span> <span>=></span> <span>fork</span><span>(</span>\n      <span>err</span> <span>=></span> <span>reject</span><span>(</span>err<span>)</span><span>,</span> \n      <span>res</span> <span>=></span> <span>fn</span><span>(</span>res<span>)</span><span>.</span><span>fork</span><span>(</span>reject<span>,</span> resolve<span>)</span>\n    <span>)</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br></div></div><h2 id=\"换个角度看-chain\"> 换个角度看 chain</h2>\n<blockquote>\n<p>使用传入的函数处理自己的值，使用外部的壳（如果外部带壳的话）</p>\n</blockquote>\n<p>前面我们由 <code>map</code> 和 <code>join</code> 进化为 <code>chain</code>。但如果只是把 <code>chain</code> 当作是一个吸尘器的话，还是太小看 <code>chain</code> 了。而且每次理解 <code>chain</code> 都要借助 map 和 join 的话，对我们心智也是个不小的负担。</p>\n<p>因为 <code>chain</code> 可以轻松地嵌套多个作用，因此我们就能以一种纯函数的方式来表示序列(sequence)和变量赋值(variable assignment)。</p>\n<div><pre><code><span>// getJSON :: Url -> Params -> Task JSON</span>\n<span>// querySelector :: Selector -> IO DOM</span>\n\n<span>getJSON</span><span>(</span><span>'/authenticate'</span><span>,</span> <span>{</span>username<span>:</span> <span>'stale'</span><span>,</span> password<span>:</span> <span>'crackers'</span><span>}</span><span>)</span>\n  <span>.</span><span>chain</span><span>(</span><span>user</span> <span>=></span> <span>getJSON</span><span>(</span><span>'/friends'</span><span>,</span> <span>{</span>user_id<span>:</span> user<span>.</span>id<span>}</span><span>)</span><span>)</span>\n\n<span>querySelector</span><span>(</span><span>\"input.username\"</span><span>)</span>\n  <span>.</span><span>chain</span><span>(</span><span>uname</span> <span>=></span> <span>querySelector</span><span>(</span><span>\"input.email\"</span><span>)</span>\n    <span>.</span><span>chain</span><span>(</span><span>email</span> <span>=></span> <span>IO</span><span>.</span><span>of</span><span>(</span><span>\"Welcome \"</span> <span>+</span> uname<span>.</span>value <span>+</span> <span>\" \"</span> <span>+</span> <span>\"prepare for spam at \"</span> <span>+</span> email<span>.</span>value<span>)</span><span>)</span>\n  <span>)</span>\n\nMaybe<span>.</span><span>of</span><span>(</span><span>3</span><span>)</span>\n  <span>.</span><span>chain</span><span>(</span><span>three</span> <span>=></span> Maybe<span>.</span><span>of</span><span>(</span><span>2</span><span>)</span><span>.</span><span>map</span><span>(</span><span>add</span><span>(</span>three<span>)</span><span>)</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "Observable",
      "url": "https://x-vic.gitee.io/code/code/views/functional/rxjs/",
      "id": "https://x-vic.gitee.io/code/code/views/functional/rxjs/",
      "content_html": "<blockquote>\n<p>Observable 是 rx 体系中的一个概念，而 rx 本身就是一个很大的话题。但是这里我们只是单纯地从函数式编程的角度来理解 Observable</p>\n</blockquote>\n<h2 id=\"observable-如何使用\"> Observable 如何使用</h2>\n<p><code>Observable</code> 接收一个生产数据的函数，每当这个函数（生产者）生产出新的数据，就会调用 <code>subscribe</code> 传入的函数（消费者）。<br>\n它看起来有点像之前提到过的 Task functor，同样是传入生产函数，通过某个方法传入回调函数。不同之处在于 <code>Task</code> 有成功、pedding、失败三种状态。而 <code>Observable</code> 由成功变为完成状态，pedding 变成不断发射值的 next 状态，失败状态与 <code>Task</code> 保持一致。<br>\n用一句糙话来讲就是：<code>Observable</code> 是 <code>Task</code> 或是 <code>Promise</code> 的加强版。</p>\n<div><pre><code><span>const</span> observable <span>=</span> <span>new</span> <span>Observable</span><span>(</span><span>observer</span> <span>=></span> <span>{</span>\n  <span>let</span> i <span>=</span> <span>1</span>\n  <span>setInterval</span><span>(</span><span>(</span><span>)</span> <span>=></span> observer<span>.</span><span>next</span><span>(</span>i<span>++</span><span>)</span><span>,</span> <span>1000</span><span>)</span>\n<span>}</span><span>)</span>\n\nobservable\n  <span>.</span><span>pipe</span><span>(</span>\n    <span>val</span> <span>=></span> val <span>*</span> <span>2</span><span>,</span>\n    <span>val</span> <span>=></span> <span>++</span>val\n  <span>)</span>\n  <span>.</span><span>subscribe</span><span>(</span>\n    console<span>.</span>log\n  <span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br></div></div><h2 id=\"observable-简单实现\"> Observable 简单实现</h2>\n<div><pre><code><span>class</span> <span>Observable</span> <span>{</span>\n  <span>constructor</span><span>(</span><span>createFn</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span>createFn <span>=</span> createFn\n  <span>}</span>\n  <span>next</span><span>(</span><span>value</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span><span>resFn</span><span>(</span>value<span>)</span>\n  <span>}</span>\n  <span>subscribe</span><span>(</span><span>resFn</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span><span>createFn</span><span>(</span><span>this</span><span>)</span>\n    <span>this</span><span>.</span>resFn <span>=</span> <span>compose</span><span>(</span>resFn<span>,</span> <span>this</span><span>.</span>handleFn<span>)</span>\n  <span>}</span>\n  <span>pipe</span><span>(</span><span><span>...</span>fns</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span>handleFn <span>=</span> <span>compose</span><span>(</span><span>...</span>fns<span>.</span><span>reverse</span><span>(</span><span>)</span><span>)</span>\n    <span>return</span> <span>this</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><h2 id=\"next-是对-resolve-的升维\"> next 是对 resolve 的升维</h2>\n<p>对于 Task 而言，resolve 意味着该函子生命周期的结束。而放到一个应用中看，我们需要许许多多的 Task 来管理我们的应用。而经过 next 这个状态的扩展之后，前段中的很多场景都可以被抽象为 Observable 了。如：事件响应、ajax、websocket......<br>\n增加一个维度，表现力大增。<br>\n夹一个私货：为什么毛笔的艺术表现力强于钢笔，窃以为毛笔比钢笔多了线条宽度这样一个维度。</p>\n",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "函子之间的转换",
      "url": "https://x-vic.gitee.io/code/code/views/functional/transform/",
      "id": "https://x-vic.gitee.io/code/code/views/functional/transform/",
      "content_html": "<blockquote>\n<p>我们在借用函子的各种能力的时候，不可避免会出现函子嵌套函子的情况。前面两章，我们分别介绍了 chain 以及 ap 工具来避免了这种嵌套的情况。</p>\n</blockquote>\n<h2 id=\"totask\"> toTask</h2>\n<p><code>Task</code> 之外的函子转换比较简单，这里不再赘述。这里只能看到其他函子转成 Task，而不能看到 Task 转成其他函子，因为我们没法将异步操作转为同步操作。</p>\n<div><pre><code><span>// eitherToTask :: Either a b -> Task a b</span>\n<span>const</span> eitherToTask <span>=</span> <span>either</span><span>(</span>Task<span>.</span>rejected<span>,</span> Task<span>.</span>of<span>)</span>\n\n<span>// ioToTask :: IO a -> Task () a</span>\n<span>const</span> <span>ioToTask</span> <span>=</span> <span>x</span> <span>=></span> <span>new</span> <span>Task</span><span>(</span><span>(</span><span>reject<span>,</span> resolve</span><span>)</span> <span>=></span> <span>resolve</span><span>(</span>x<span>.</span><span>unsafePerform</span><span>(</span><span>)</span><span>)</span><span>)</span>\n\n<span>// maybeToTask :: Maybe a -> Task () a</span>\n<span>const</span> <span>maybeToTask</span> <span>=</span> <span>x</span> <span>=></span> <span>(</span>x<span>.</span>isNothing <span>?</span> Task<span>.</span><span>rejected</span><span>(</span><span>)</span> <span>:</span> Task<span>.</span><span>of</span><span>(</span>x<span>.</span>$value<span>)</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div><h2 id=\"同构-promise-与-task\"> 同构 Promise 与 Task</h2>\n<div><pre><code><span>// promiseToTask :: Promise a b -> Task a b</span>\n<span>const</span> <span>promiseToTask</span> <span>=</span> <span>x</span> <span>=></span> <span>new</span> <span>Task</span><span>(</span><span>(</span><span>reject<span>,</span> resolve</span><span>)</span> <span>=></span> x<span>.</span><span>then</span><span>(</span>resolve<span>)</span><span>.</span><span>catch</span><span>(</span>reject<span>)</span><span>)</span>\n\n<span>// taskToPromise :: Task a b -> Promise a b</span>\n<span>const</span> <span>taskToPromise</span> <span>=</span> <span>x</span> <span>=></span> <span>new</span> <span>Promise</span><span>(</span><span>(</span><span>resolve<span>,</span> reject</span><span>)</span> <span>=></span> x<span>.</span><span>fork</span><span>(</span>reject<span>,</span> resolve<span>)</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></div></div><h2 id=\"使用示例-顺便复习前面的内容\"> 使用示例（顺便复习前面的内容）</h2>\n<p>下面来模拟一个场景：读取本地文件的内容，将之提交给服务器。</p>\n<ol>\n<li>校验传入的文件路径（文件读取失败时，reject 一个 Maybe 包装值）</li>\n<li>将 Maybe 转为 Task</li>\n<li>校验内容长度</li>\n<li>将 Either 转为 Task</li>\n<li>提交内容</li>\n</ol>\n<div><pre><code><span>const</span> <span>{</span> readFile <span>}</span> <span>=</span> <span>require</span><span>(</span><span>'fs'</span><span>)</span>\n<span>const</span> <span>{</span> compose<span>,</span> curry <span>}</span> <span>=</span> <span>require</span><span>(</span><span>'ramda'</span><span>)</span>\n\n<span>class</span> <span>Maybe</span> <span>{</span>\n  <span>constructor</span><span>(</span><span>value</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span>__value <span>=</span> value\n  <span>}</span>\n  <span>static</span> <span>of</span><span>(</span>value<span>)</span> <span>{</span>\n    <span>return</span> <span>new</span> <span>Maybe</span><span>(</span>value<span>)</span>\n  <span>}</span>\n  <span>isNothing</span><span>(</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span><span>.</span>__value <span>===</span> <span>undefined</span> <span>||</span> <span>this</span><span>.</span>__value <span>===</span> <span>null</span>\n  <span>}</span>\n  <span>map</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span><span>.</span>isNothing\n      <span>?</span> <span>this</span><span>.</span>constructor<span>.</span><span>of</span><span>(</span><span>null</span><span>)</span>\n      <span>:</span> <span>this</span><span>.</span>constructor<span>.</span><span>of</span><span>(</span><span>fn</span><span>(</span><span>this</span><span>.</span>__value<span>)</span><span>)</span>\n  <span>}</span>\n  <span>chain</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>return</span> <span>fn</span><span>(</span><span>this</span><span>.</span>__value<span>)</span>\n  <span>}</span>\n<span>}</span>\n\n<span>class</span> <span>Either</span> <span>{</span>\n  <span>constructor</span><span>(</span><span>value</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span>__value <span>=</span> value\n  <span>}</span>\n<span>}</span>\n\n<span>class</span> <span>Left</span> <span>extends</span> <span>Either</span> <span>{</span>\n  <span>static</span> <span>of</span><span>(</span>value<span>)</span> <span>{</span>\n    <span>return</span> <span>new</span> <span>Left</span><span>(</span>value<span>)</span>\n  <span>}</span>\n  <span>map</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span>\n  <span>}</span>\n  <span>isLeft</span><span>(</span><span>)</span> <span>{</span>\n    <span>return</span> <span>true</span>\n  <span>}</span>\n  <span>isRight</span><span>(</span><span>)</span> <span>{</span>\n    <span>return</span> <span>false</span>\n  <span>}</span>\n<span>}</span>\n\n<span>class</span> <span>Right</span> <span>extends</span> <span>Either</span> <span>{</span>\n  <span>static</span> <span>of</span><span>(</span>value<span>)</span> <span>{</span>\n    <span>return</span> <span>new</span> <span>Right</span><span>(</span>value<span>)</span>\n  <span>}</span>\n  <span>map</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span><span>.</span>constructor<span>.</span><span>of</span><span>(</span><span>fn</span><span>(</span><span>this</span><span>.</span>constructor<span>)</span><span>)</span>\n  <span>}</span>\n  <span>isLeft</span><span>(</span><span>)</span> <span>{</span>\n    <span>return</span> <span>false</span>\n  <span>}</span>\n  <span>isRight</span><span>(</span><span>)</span> <span>{</span>\n    <span>return</span> <span>true</span>\n  <span>}</span>\n<span>}</span>\n\n<span>class</span> <span>Task</span> <span>{</span>\n  <span>constructor</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span>fork <span>=</span> fn\n  <span>}</span>\n  <span>// 组合 resolve 与 fn</span>\n  <span>map</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>return</span> <span>new</span> <span>Task</span><span>(</span><span>(</span><span>reject<span>,</span> resolve</span><span>)</span> <span>=></span> <span>this</span><span>.</span><span>fork</span><span>(</span>\n      reject<span>,</span>\n      <span>compose</span><span>(</span>resolve<span>,</span> fn<span>)</span>\n    <span>)</span><span>)</span>\n  <span>}</span>\n  <span>// 调用 fork 之后，返回的依然是 Task</span>\n  <span>chain</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>return</span> <span>new</span> <span>Task</span><span>(</span><span>(</span><span>reject<span>,</span> resolve</span><span>)</span> <span>=></span> <span>this</span><span>.</span><span>fork</span><span>(</span>\n      reject<span>,</span>\n      <span>res</span> <span>=></span> <span>fn</span><span>(</span>res<span>)</span><span>.</span><span>fork</span><span>(</span>reject<span>,</span> resolve<span>)</span><span>)</span>\n    <span>)</span>\n  <span>}</span>\n  <span>ap</span><span>(</span><span>functor</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span><span>.</span><span>chain</span><span>(</span><span>fn</span> <span>=></span> functor<span>.</span><span>map</span><span>(</span>fn<span>)</span><span>)</span>\n  <span>}</span>\n<span>}</span>\n\n<span>const</span> map <span>=</span> <span>curry</span><span>(</span><span>(</span><span>fn<span>,</span> functor</span><span>)</span> <span>=></span> functor<span>.</span><span>map</span><span>(</span>fn<span>)</span><span>)</span>\n<span>const</span> either <span>=</span> <span>curry</span><span>(</span><span>(</span><span>leftFn<span>,</span> rightFn<span>,</span> functor</span><span>)</span> <span>=></span> <span>{</span>\n  <span>if</span> <span>(</span>functor<span>.</span><span>isLeft</span><span>(</span><span>)</span><span>)</span> <span>return</span> <span>leftFn</span><span>(</span>functor<span>.</span>__value<span>)</span>\n  <span>if</span> <span>(</span>functor<span>.</span><span>isRight</span><span>(</span><span>)</span><span>)</span> <span>return</span> <span>rightFn</span><span>(</span>functor<span>.</span>__value<span>)</span>\n<span>}</span><span>)</span>\n<span>const</span> chain <span>=</span> <span>curry</span><span>(</span><span>(</span><span>fn<span>,</span> functor</span><span>)</span> <span>=></span> functor<span>.</span><span>chain</span><span>(</span>fn<span>)</span><span>)</span>\n\n<span>const</span> <span>maybeToTask</span> <span>=</span> <span>functor</span> <span>=></span> <span>new</span> <span>Task</span><span>(</span><span>(</span><span>reject<span>,</span> resolve</span><span>)</span> <span>=></span> functor<span>.</span><span>isNothing</span><span>(</span><span>)</span> <span>?</span> <span>reject</span><span>(</span><span>)</span> <span>:</span> <span>resolve</span><span>(</span>functor<span>.</span>__value<span>)</span><span>)</span>\n<span>const</span> <span>eitherToTask</span> <span>=</span> <span>functor</span> <span>=></span> <span>new</span> <span>Task</span><span>(</span><span>(</span><span>reject<span>,</span> resolve</span><span>)</span> <span>=></span> <span>either</span><span>(</span>reject<span>,</span> resolve<span>,</span> functor<span>)</span><span>)</span>\n\n<span>// 读取文件</span>\n<span>const</span> <span>read</span> <span>=</span> <span>(</span><span>path</span><span>)</span> <span>=></span> <span>new</span> <span>Task</span><span>(</span><span>(</span><span>reject<span>,</span> resolve</span><span>)</span> <span>=></span> <span>{</span>\n  <span>if</span> <span>(</span><span>!</span>path<span>)</span> <span>return</span> <span>reject</span><span>(</span><span>'非法 path'</span><span>)</span>\n  <span>readFile</span><span>(</span>path<span>,</span> <span>'utf8'</span><span>,</span> <span>(</span><span>err<span>,</span> res</span><span>)</span> <span>=></span> <span>{</span>\n    <span>if</span><span>(</span>err<span>)</span> <span>return</span> <span>reject</span><span>(</span>err<span>)</span>\n    <span>resolve</span><span>(</span>Maybe<span>.</span><span>of</span><span>(</span>res<span>)</span><span>)</span>\n  <span>}</span><span>)</span>\n<span>}</span><span>)</span>\n<span>const</span> <span>validateLen</span> <span>=</span> <span>str</span> <span>=></span> str<span>.</span>length <span>&lt;</span> <span>3</span> <span>?</span> Left<span>.</span><span>of</span><span>(</span>str<span>)</span> <span>:</span> Right<span>.</span><span>of</span><span>(</span>str<span>)</span>\n<span>const</span> <span>submitStr</span> <span>=</span> <span>str</span> <span>=></span> <span>new</span> <span>Task</span><span>(</span><span>(</span><span>reject<span>,</span> resolve</span><span>)</span> <span>=></span> <span>{</span>\n  <span>if</span> <span>(</span>str<span>.</span>length <span>&lt;=</span> <span>10</span><span>)</span> <span>return</span> <span>resolve</span><span>(</span><span>'响应内容：'</span> <span>+</span> str<span>)</span>\n  <span>return</span> <span>reject</span><span>(</span><span>'长度超过10'</span> <span>+</span> str<span>)</span>\n<span>}</span><span>)</span>\n\n<span>// 永远记住：对 Task 进行 chain 相当于执行了上一个 Task.fork 函数</span>\n<span>const</span> run <span>=</span> <span>compose</span><span>(</span>\n  <span>chain</span><span>(</span>submitStr<span>)</span><span>,</span>\n  <span>chain</span><span>(</span>eitherToTask<span>)</span><span>,</span>\n  <span>map</span><span>(</span>validateLen<span>)</span><span>,</span>\n  <span>chain</span><span>(</span>maybeToTask<span>)</span><span>,</span>\n  read\n<span>)</span>\n\n<span>run</span><span>(</span><span>'./src/00.txt'</span><span>)</span><span>.</span><span>fork</span><span>(</span>\n  <span>rej</span> <span>=></span> console<span>.</span><span>log</span><span>(</span><span>'rej:::'</span><span>,</span> rej<span>)</span><span>,</span>\n  <span>res</span> <span>=></span> console<span>.</span><span>log</span><span>(</span><span>'res:::'</span><span>,</span> res<span>)</span>\n<span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br><span>82</span><br><span>83</span><br><span>84</span><br><span>85</span><br><span>86</span><br><span>87</span><br><span>88</span><br><span>89</span><br><span>90</span><br><span>91</span><br><span>92</span><br><span>93</span><br><span>94</span><br><span>95</span><br><span>96</span><br><span>97</span><br><span>98</span><br><span>99</span><br><span>100</span><br><span>101</span><br><span>102</span><br><span>103</span><br><span>104</span><br><span>105</span><br><span>106</span><br><span>107</span><br><span>108</span><br><span>109</span><br><span>110</span><br><span>111</span><br><span>112</span><br><span>113</span><br><span>114</span><br><span>115</span><br><span>116</span><br><span>117</span><br><span>118</span><br><span>119</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "redux-observable 源码解读",
      "url": "https://x-vic.gitee.io/code/code/views/others/redux-observable/",
      "id": "https://x-vic.gitee.io/code/code/views/others/redux-observable/",
      "content_html": "<blockquote>\n<p>redux-observable 是一个 redux 中间件。与多数 redux 中间件不同的是：其他中间件做的是改造 action 的工作，而 redux-observable 是在 action 的上层添加了一个对 action 流的监听，获取它所需要的 action，最后处理成不同的 action.</p>\n</blockquote>\n<h2 id=\"提问\"> 提问</h2>\n<ul>\n<li>redux-observable 如何能够监听到所有的 action ？</li>\n<li>业务里面的 epic 是何时被调用的？</li>\n<li>其他中间件如何接管 redux-observable 映射出来的 action？</li>\n</ul>\n<h2 id=\"createepicmiddleware-创建中间件\"> createEpicMiddleware 创建中间件</h2>\n<ol>\n<li>创建 action 流</li>\n<li>创建 state 流（有初始值）</li>\n<li>创建 result 流（后面经过一次 run 会转化成各种 $action 的变形）</li>\n<li>监听 result$ 出发 dispatch</li>\n</ol>\n<div><pre><code><span>const</span> epicMiddleware<span>:</span> EpicMiddleware<span>&lt;</span><span>T</span><span>,</span> <span>O</span><span>,</span> <span>S</span><span>,</span> <span>D</span><span>></span> <span>=</span> _store <span>=></span> <span>{</span>\n    store <span>=</span> _store<span>;</span>\n    <span>const</span> actionSubject$ <span>=</span> <span>new</span> <span>Subject<span>&lt;</span><span>T</span><span>></span></span><span>(</span><span>)</span><span>;</span>\n    <span>const</span> stateSubject$ <span>=</span> <span>new</span> <span>Subject<span>&lt;</span><span>S</span><span>></span></span><span>(</span><span>)</span><span>;</span>\n    <span>const</span> action$ <span>=</span> actionSubject$\n      <span>.</span><span>asObservable</span><span>(</span><span>)</span>\n      <span>.</span><span>pipe</span><span>(</span><span>observeOn</span><span>(</span>uniqueQueueScheduler<span>)</span><span>)</span><span>;</span>\n    <span>const</span> state$ <span>=</span> <span>new</span> <span>StateObservable</span><span>(</span>\n      stateSubject$<span>.</span><span>pipe</span><span>(</span><span>observeOn</span><span>(</span>uniqueQueueScheduler<span>)</span><span>)</span><span>,</span>\n      store<span>.</span><span>getState</span><span>(</span><span>)</span>\n    <span>)</span><span>;</span>\n\n    <span>const</span> result$ <span>=</span> epic$<span>.</span><span>pipe</span><span>(</span>\n      <span>map</span><span>(</span>epic <span>=></span> <span>{</span>\n        <span>const</span> output$ <span>=</span> <span>epic</span><span>(</span>action$<span>,</span> state$<span>,</span> options<span>.</span>dependencies<span>!</span><span>)</span><span>;</span>\n        <span>return</span> output$<span>;</span>\n      <span>}</span><span>)</span><span>,</span>\n      <span>// 合并所有 epic 返回的流</span>\n      <span>mergeMap</span><span>(</span>output$ <span>=></span>\n        <span>from</span><span>(</span>output$<span>)</span><span>.</span><span>pipe</span><span>(</span>\n          <span>subscribeOn</span><span>(</span>uniqueQueueScheduler<span>)</span><span>,</span>\n          <span>observeOn</span><span>(</span>uniqueQueueScheduler<span>)</span>\n        <span>)</span>\n      <span>)</span>\n    <span>)</span><span>;</span>\n\n    result$<span>.</span><span>subscribe</span><span>(</span>store<span>.</span>dispatch<span>)</span><span>;</span>\n\n    <span>// 返回的这一整块是 redux 中间件</span>\n    <span>return</span> next <span>=></span> <span>{</span>\n      <span>return</span> action <span>=></span> <span>{</span>\n        <span>const</span> result <span>=</span> <span>next</span><span>(</span>action<span>)</span><span>;</span>\n        stateSubject$<span>.</span><span>next</span><span>(</span>store<span>.</span><span>getState</span><span>(</span><span>)</span><span>)</span><span>;</span>\n        <span>// 每次有 action 发出，就通知 epic 里面的监听器</span>\n        actionSubject$<span>.</span><span>next</span><span>(</span>action<span>)</span><span>;</span>\n        <span>return</span> result<span>;</span>\n      <span>}</span><span>;</span>\n    <span>}</span><span>;</span>\n  <span>}</span><span>;</span>\n\n  epicMiddleware<span>.</span><span>run</span> <span>=</span> rootEpic <span>=></span> <span>{</span>\n    epic$<span>.</span><span>next</span><span>(</span>rootEpic<span>)</span><span>;</span>\n  <span>}</span><span>;</span>\n\n  <span>return</span> epicMiddleware<span>;</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br></div></div><h2 id=\"combineepics-合并所有-epic-返回新的-epic\"> combineEpics 合并所有 epic 返回新的 epic</h2>\n<div><pre><code><span>export</span> <span>function</span> <span>combineEpics</span><span>(</span><span><span>...</span>epics</span><span>)</span> <span>{</span>\n  <span>return</span> <span>(</span><span><span>...</span>args</span><span>)</span> <span>=></span> <span>merge</span><span>(</span>\n    <span>...</span>epics<span>.</span><span>map</span><span>(</span><span>epic</span> <span>=></span> <span>{</span>\n      <span>return</span> <span>epic</span><span>(</span><span>...</span>args<span>)</span>\n    <span>}</span><span>)</span>\n  <span>)</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><h2 id=\"最后\"> 最后</h2>\n<p>redux-observable 如何能够监听到所有的 action ？</p>\n<p>epic 里边监听了 action$；每次有 action 发射的时候，action$ 会将这个 action 发射出去。</p>\n<p>其他中间件如何接管 redux-observable 映射出来的 action ？</p>\n<p>$result 被监听最终会执行 dispatch</p>\n",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "rxjs-hooks 源码解读",
      "url": "https://x-vic.gitee.io/code/code/views/others/rxjs-hooks/",
      "id": "https://x-vic.gitee.io/code/code/views/others/rxjs-hooks/",
      "content_html": "<div><p>Tips</p>\n<p>这里一共 useObservable 以及 useEventCallback 两个 hook。<br>\nuseObservable 从虚无中或是变化的 props 中得到衍生的数据。<br>\nuseEventCallback 从点击事件、变化的 props 中得到衍生数据。</p>\n</div>\n<h2 id=\"useobservable\"> useObservable</h2>\n<ol>\n<li>创建 state</li>\n<li>调用传入的函数，得到输出流，监听该流，更新 state</li>\n<li>组件销毁时做一些清理工作</li>\n</ol>\n<div><pre><code><span>export</span> <span>function</span> <span>useObservable</span><span>(</span>\n  inputFactory<span>,</span>\n  initialState<span>,</span>\n  inputs<span>,</span>\n<span>)</span> <span>{</span>\n  <span>const</span> <span>[</span>state<span>,</span> setState<span>]</span> <span>=</span> <span>useState</span><span>(</span><span>typeof</span> initialState <span>!==</span> <span>'undefined'</span> <span>?</span> initialState <span>:</span> <span>null</span><span>)</span>\n\n  <span>const</span> state$ <span>=</span> <span>useConstant</span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>new</span> <span>BehaviorSubject</span><span>(</span>initialState<span>)</span><span>)</span>\n  <span>const</span> inputs$ <span>=</span> <span>useConstant</span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>new</span> <span>BehaviorSubject</span><span>(</span>inputs<span>)</span><span>)</span>\n\n  <span>useEffect</span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>{</span>\n    inputs$<span>.</span><span>next</span><span>(</span>inputs<span>)</span>\n  <span>}</span><span>,</span> inputs <span>||</span> <span>[</span><span>]</span><span>)</span>\n\n  <span>useEffect</span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>{</span>\n    <span>let</span> output$\n    <span>if</span> <span>(</span>inputs<span>)</span> <span>{</span>\n      output$ <span>=</span> <span>inputFactory</span><span>(</span>state$<span>,</span> inputs$<span>)</span>\n    <span>}</span> <span>else</span> <span>{</span>\n      output$ <span>=</span> <span>inputFactory</span><span>(</span>state$<span>)</span>\n    <span>}</span>\n    <span>const</span> subscription <span>=</span> output$<span>.</span><span>subscribe</span><span>(</span><span>(</span>value<span>)</span> <span>=></span> <span>{</span>\n      state$<span>.</span><span>next</span><span>(</span>value<span>)</span>\n      <span>setState</span><span>(</span>value<span>)</span>\n    <span>}</span><span>)</span>\n    <span>return</span> <span>(</span><span>)</span> <span>=></span> <span>{</span>\n      subscription<span>.</span><span>unsubscribe</span><span>(</span><span>)</span>\n      inputs$<span>.</span><span>complete</span><span>(</span><span>)</span>\n      state$<span>.</span><span>complete</span><span>(</span><span>)</span>\n    <span>}</span>\n  <span>}</span><span>,</span> <span>[</span><span>]</span><span>)</span>\n\n  <span>return</span> state\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br></div></div><h2 id=\"useeventcallback\"> useEventCallback</h2>\n<p>与 useObservable 相似，不过是提供了从外部发射事件的能力。</p>\n<div><pre><code><span>export</span> <span>function</span> <span>useEventCallback</span><span>(</span>\n  callback<span>,</span>\n  initialState<span>,</span>\n  inputs<span>,</span>\n<span>)</span> <span>{</span>\n  <span>const</span> initialValue <span>=</span> <span>typeof</span> initialState <span>!==</span> <span>'undefined'</span> <span>?</span> initialState <span>:</span> <span>null</span>\n  <span>const</span> <span>[</span>state<span>,</span> setState<span>]</span> <span>=</span> <span>useState</span><span>(</span>initialValue<span>)</span>\n  <span>const</span> event$ <span>=</span> <span>useConstant</span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>new</span> <span>Subject</span><span>(</span><span>)</span><span>)</span>\n  <span>const</span> state$ <span>=</span> <span>useConstant</span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>new</span> <span>BehaviorSubject</span><span>(</span>initialValue<span>)</span><span>)</span>\n  <span>const</span> inputs$ <span>=</span> <span>useConstant</span><span>(</span>\n    <span>(</span><span>)</span> <span>=></span> <span>new</span> <span>BehaviorSubject</span><span>(</span><span>typeof</span> inputs <span>===</span> <span>'undefined'</span> <span>?</span> <span>null</span> <span>:</span> inputs<span>)</span><span>,</span>\n  <span>)</span>\n\n  <span>function</span> <span>eventCallback</span><span>(</span>e<span>)</span> <span>{</span>\n    <span>return</span> event$<span>.</span><span>next</span><span>(</span>e<span>)</span>\n  <span>}</span>\n  <span>const</span> returnedCallback <span>=</span> <span>useCallback</span><span>(</span>eventCallback<span>,</span> <span>[</span><span>]</span><span>)</span>\n\n  <span>useEffect</span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>{</span>\n    inputs$<span>.</span><span>next</span><span>(</span>inputs<span>!</span><span>)</span>\n  <span>}</span><span>,</span> inputs <span>||</span> <span>[</span><span>]</span><span>)</span>\n\n  <span>useEffect</span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>{</span>\n    <span>setState</span><span>(</span>initialValue<span>)</span>\n    <span>let</span> value$\n\n    <span>if</span> <span>(</span><span>!</span>inputs<span>)</span> <span>{</span>\n      value$ <span>=</span> <span>callback</span><span>(</span>event$<span>,</span> state$<span>)</span>\n    <span>}</span> <span>else</span> <span>{</span>\n      value$ <span>=</span> <span>callback</span><span>(</span>event$<span>,</span> state$<span>,</span> inputs$<span>)</span>\n    <span>}</span>\n    <span>const</span> subscription <span>=</span> value$<span>.</span><span>subscribe</span><span>(</span><span>(</span>value<span>)</span> <span>=></span> <span>{</span>\n      state$<span>.</span><span>next</span><span>(</span>value<span>)</span>\n      <span>setState</span><span>(</span>value<span>)</span>\n    <span>}</span><span>)</span>\n    <span>return</span> <span>(</span><span>)</span> <span>=></span> <span>{</span>\n      subscription<span>.</span><span>unsubscribe</span><span>(</span><span>)</span>\n      state$<span>.</span><span>complete</span><span>(</span><span>)</span>\n      inputs$<span>.</span><span>complete</span><span>(</span><span>)</span>\n      event$<span>.</span><span>complete</span><span>(</span><span>)</span>\n    <span>}</span>\n  <span>}</span><span>,</span> <span>[</span><span>]</span><span>)</span> <span>// immutable forever</span>\n\n  <span>return</span> <span>[</span>returnedCallback<span>,</span> state<span>]</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "koa",
      "url": "https://x-vic.gitee.io/code/code/views/owner-koa/",
      "id": "https://x-vic.gitee.io/code/code/views/owner-koa/",
      "content_html": "<blockquote>\n<p>koa 给我印象比较深刻的是 ctx 以及中间件的洋葱模型，本次简单实现中，重点实现这两个特性</p>\n</blockquote>\n<h2 id=\"目录结构\"> 目录结构</h2>\n<p>koa 主要有以下几个模块：</p>\n<ul>\n<li>application.js 核心模块</li>\n<li>context.js 上下文模块</li>\n<li>response.js 响应对象模块</li>\n<li>request.js 请求对象模块</li>\n</ul>\n<h2 id=\"request\"> request</h2>\n<div><pre><code><span>const</span> url <span>=</span> <span>require</span><span>(</span><span>'url'</span><span>)</span>\n\n<span>const</span> request <span>=</span> <span>{</span>\n  <span>get</span> <span>url</span><span>(</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span><span>.</span>req<span>.</span>url\n  <span>}</span><span>,</span>\n  <span>get</span> <span>path</span><span>(</span><span>)</span> <span>{</span>\n    <span>return</span> url<span>.</span><span>parse</span><span>(</span><span>this</span><span>.</span>req<span>.</span>url<span>)</span><span>.</span>pathname\n  <span>}</span><span>,</span>\n  <span>get</span> <span>query</span><span>(</span><span>)</span> <span>{</span>\n    <span>return</span> url<span>.</span><span>parse</span><span>(</span><span>this</span><span>.</span>req<span>.</span>url<span>)</span><span>.</span>query\n  <span>}</span>\n<span>}</span>\n\nmodule<span>.</span>exports <span>=</span> request\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br></div></div><h2 id=\"response\"> response</h2>\n<div><pre><code><span>const</span> response <span>=</span> <span>{</span>\n  <span>get</span> <span>body</span><span>(</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span><span>.</span>_body\n  <span>}</span><span>,</span>\n  <span>set</span> <span>body</span><span>(</span><span>value</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span>res<span>.</span>statusCode <span>=</span> <span>200</span>\n    <span>this</span><span>.</span>_body <span>=</span> value\n  <span>}</span>\n<span>}</span>\n\nmodule<span>.</span>exports <span>=</span> response\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><h2 id=\"context\"> context</h2>\n<div><div><br><br><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><br><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><br><br><br><br><br><br><br><br></div><pre><code><span>const</span> proto <span>=</span> <span>{</span><span>}</span>\n\n<span>function</span> <span>defineGetter</span><span>(</span><span>prop<span>,</span> name</span><span>)</span> <span>{</span>\n  proto<span>.</span><span>__defineGetter__</span><span>(</span>name<span>,</span> <span>function</span><span>(</span><span>)</span> <span>{</span>\n    <span>return</span> <span>this</span><span>[</span>prop<span>]</span><span>[</span>name<span>]</span>\n  <span>}</span><span>)</span>\n<span>}</span>\n\n<span>function</span> <span>defineSetter</span><span>(</span><span>prop<span>,</span> name</span><span>)</span> <span>{</span>\n  proto<span>.</span><span>__defineSetter__</span><span>(</span>name<span>,</span> <span>function</span><span>(</span><span>val</span><span>)</span> <span>{</span>\n    <span>this</span><span>[</span>prop<span>]</span><span>[</span>name<span>]</span> <span>=</span> val\n  <span>}</span><span>)</span>\n<span>}</span>\n<span>// 访问 ctx 的某个属性时，代理到 request 或 response 的对应属性上</span>\n<span>defineGetter</span><span>(</span><span>'request'</span><span>,</span> <span>'url'</span><span>)</span>\n<span>defineGetter</span><span>(</span><span>'request'</span><span>,</span> <span>'path'</span><span>)</span>\n<span>defineGetter</span><span>(</span><span>'response'</span><span>,</span> <span>'body'</span><span>)</span>\n<span>defineSetter</span><span>(</span><span>'response'</span><span>,</span> <span>'body'</span><span>)</span>\n\nmodule<span>.</span>exports <span>=</span> proto\n</code></pre><div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br></div></div><h2 id=\"application\"> application</h2>\n<div><div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre><code><span>const</span> http <span>=</span> <span>require</span><span>(</span><span>'http'</span><span>)</span>\n<span>const</span> EventEmmit <span>=</span> <span>require</span><span>(</span><span>'events'</span><span>)</span>\n<span>const</span> Stream <span>=</span> <span>require</span><span>(</span><span>'stream'</span><span>)</span>\n<span>const</span> request <span>=</span> <span>require</span><span>(</span><span>'./request'</span><span>)</span>\n<span>const</span> context <span>=</span> <span>require</span><span>(</span><span>'./context'</span><span>)</span>\n<span>const</span> response <span>=</span> <span>require</span><span>(</span><span>'./response'</span><span>)</span>\n\n<span>class</span> <span>VKoa</span> <span>extends</span> <span>EventEmmit</span> <span>{</span>\n  <span>constructor</span><span>(</span><span>)</span> <span>{</span>\n    <span>super</span><span>(</span><span>)</span>\n    <span>this</span><span>.</span>middlewares <span>=</span> <span>[</span><span>]</span>\n    <span>this</span><span>.</span>request <span>=</span> request\n    <span>this</span><span>.</span>response <span>=</span> response\n    <span>this</span><span>.</span>context <span>=</span> context\n  <span>}</span>\n  <span>use</span><span>(</span><span>fn</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span>middlewares<span>.</span><span>push</span><span>(</span>fn<span>)</span>\n  <span>}</span>\n  <span>// 实现洋葱模型中间件的关键逻辑</span>\n  <span>async</span> <span>compose</span><span>(</span><span>middlewares<span>,</span> ctx</span><span>)</span> <span>{</span>\n    <span>const</span> <span>dispatch</span> <span>=</span> <span>async</span><span>(</span><span>index</span><span>)</span> <span>=></span> <span>{</span>\n      <span>if</span> <span>(</span>index <span>>=</span> middlewares<span>.</span>length<span>)</span> <span>return</span>\n      <span>const</span> middleware <span>=</span> middlewares<span>[</span>index<span>]</span>\n      <span>return</span> <span>middleware</span><span>(</span>ctx<span>,</span> <span>(</span><span>)</span> <span>=></span> <span>dispatch</span><span>(</span>index <span>+</span> <span>1</span><span>)</span><span>)</span>\n    <span>}</span>\n    <span>return</span> <span>dispatch</span><span>(</span><span>0</span><span>)</span>\n  <span>}</span>\n  <span>// 这一块主要是让用户能够更方便地获取 ctx request response 三个对象</span>\n  <span>createContext</span><span>(</span><span>req<span>,</span> res</span><span>)</span><span>{</span>\n    <span>const</span> ctx <span>=</span> Object<span>.</span><span>create</span><span>(</span><span>this</span><span>.</span>context<span>)</span>\n    <span>const</span> request <span>=</span> ctx<span>.</span>request <span>=</span> Object<span>.</span><span>create</span><span>(</span><span>this</span><span>.</span>request<span>)</span>\n    <span>const</span> response <span>=</span> ctx<span>.</span>response <span>=</span> Object<span>.</span><span>create</span><span>(</span><span>this</span><span>.</span>response<span>)</span>\n    ctx<span>.</span>req <span>=</span> request<span>.</span>req <span>=</span> response<span>.</span>req <span>=</span> req\n    ctx<span>.</span>res <span>=</span> request<span>.</span>res <span>=</span> response<span>.</span>res <span>=</span> res\n    request<span>.</span>ctx <span>=</span> response<span>.</span>ctx <span>=</span> ctx\n    request<span>.</span>response <span>=</span> response\n    response<span>.</span>request <span>=</span> request\n    <span>return</span> ctx\n  <span>}</span>\n  <span>// 执行完所有中间件之后，根据 ctx.body 的类型返回相应的 Content-Type</span>\n  <span>handleRequest</span><span>(</span><span>req<span>,</span> res</span><span>)</span><span>{</span>\n    res<span>.</span>statusCode <span>=</span> <span>404</span>\n    <span>const</span> ctx <span>=</span> <span>this</span><span>.</span><span>createContext</span><span>(</span>req<span>,</span> res<span>)</span>\n    <span>const</span> fn <span>=</span> <span>this</span><span>.</span><span>compose</span><span>(</span><span>this</span><span>.</span>middlewares<span>,</span> ctx<span>)</span>\n    fn<span>.</span><span>then</span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>{</span>\n      <span>if</span><span>(</span><span>typeof</span> ctx<span>.</span>body <span>==</span> <span>'object'</span><span>)</span><span>{</span>\n        res<span>.</span><span>setHeader</span><span>(</span><span>'Content-Type'</span><span>,</span> <span>'application/json;charset=utf8'</span><span>)</span>\n        res<span>.</span><span>end</span><span>(</span><span>JSON</span><span>.</span><span>stringify</span><span>(</span>ctx<span>.</span>body<span>)</span><span>)</span>\n      <span>}</span> <span>else</span> <span>if</span> <span>(</span>ctx<span>.</span>body <span>instanceof</span> <span>Stream</span><span>)</span><span>{</span> <span>// 如果是流</span>\n        ctx<span>.</span>body<span>.</span><span>pipe</span><span>(</span>res<span>)</span>\n      <span>}</span>\n      <span>else</span> <span>if</span> <span>(</span><span>typeof</span> ctx<span>.</span>body <span>===</span> <span>'string'</span> <span>||</span> Buffer<span>.</span><span>isBuffer</span><span>(</span>ctx<span>.</span>body<span>)</span><span>)</span> <span>{</span>\n        res<span>.</span><span>setHeader</span><span>(</span><span>'Content-Type'</span><span>,</span> <span>'text/htmlcharset=utf8'</span><span>)</span>\n        res<span>.</span><span>end</span><span>(</span>ctx<span>.</span>body<span>)</span>\n      <span>}</span> <span>else</span> <span>{</span>\n        res<span>.</span><span>end</span><span>(</span><span>'Not found'</span><span>)</span>\n      <span>}</span>\n    <span>}</span><span>)</span><span>.</span><span>catch</span><span>(</span><span>err</span> <span>=></span> <span>{</span>\n      <span>this</span><span>.</span><span>emit</span><span>(</span><span>'error'</span><span>,</span> err<span>)</span>\n      res<span>.</span>statusCode <span>=</span> <span>500</span>\n      res<span>.</span><span>end</span><span>(</span><span>'server error'</span><span>)</span>\n    <span>}</span><span>)</span>\n  <span>}</span>\n  <span>listen</span><span>(</span><span><span>...</span>args</span><span>)</span> <span>{</span>\n    <span>const</span> server <span>=</span> http<span>.</span><span>createServer</span><span>(</span><span>this</span><span>.</span><span>handleRequest</span><span>.</span><span>bind</span><span>(</span><span>this</span><span>)</span><span>)</span>\n    server<span>.</span><span>listen</span><span>(</span><span>3000</span><span>)</span>\n  <span>}</span>\n<span>}</span>\n\nmodule<span>.</span>exports <span>=</span> VKoa\n</code></pre><div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "Concurrent Mode & fiber",
      "url": "https://x-vic.gitee.io/code/code/views/owner-react/fiber/",
      "id": "https://x-vic.gitee.io/code/code/views/owner-react/fiber/",
      "content_html": "<div><p>主旨</p>\n<p>上一版实现的 <code>render</code> 是通过递归的方式将 <code>dom</code> 层层插入，最终实现了虚拟dom到页面的渲染。<br>\n但是这么做的问题在于递归的过程无法中断，从而导致阻塞用户点击事件和渲染动画这些高优先级的操作，给人一种卡顿的感觉。<br>\n这次旨在解决上述问题。</p>\n</div>\n<p>Concurrent Mode\n@flowstart\nrender=&gt;start: 设置下一个执行单元为根fiber\nsetNextUnitOfWork=&gt;operation: 设置下一个执行单元\nnextUnitOfWork=&gt;condition: 浏览器空闲\nhandleCurrentFiber=&gt;parallel: 处理当前fiber\nnextCallback=&gt;operation: 设置下一次空闲时的任务</p>\n<p>createDom=&gt;operation: 给 fiber 创建 dom\nappendChild=&gt;operation: 将自身的 dom 插到父 fiber 上\ncreateChildrenFiber=&gt;subroutine: 为每一个子元素创建 fiber\nfiberHasChild=&gt;condition: fiber 是否有 child\nhasSibling=&gt;condition: 是否有 sibling\nhasParentSibling=&gt;condition: 父节点是否有 sibling\nreturnParent=&gt;operation: 回到上层继续查找\nend=&gt;end: 暂停遍历 fiber 树</p>\n<p>render-&gt;setNextUnitOfWork-&gt;nextUnitOfWork(yes)-&gt;handleCurrentFiber(path1, left)-&gt;setNextUnitOfWork\nnextUnitOfWork(no)-&gt;nextCallback-&gt;end\n@flowend</p>\n<h2 id=\"利用浏览器的空闲算力\"> 利用浏览器的空闲算力</h2>\n<p>在一个循环中执行任务单元；<br>\n更新下一个任务单元，同时判断是否还有空闲时间；<br>\n跳出循环之后将任务添加到下一次空闲操作中。\nreact 目前是使用自己实现的调度算法，这里使用 <code>requestIdleCallback</code> 这个浏览器提供的 API 实现。</p>\n<div><pre><code><span>let</span> nextUnitOfWork <span>=</span> <span>null</span>\n\n<span>// 一旦浏览器空闲，就触发执行单元任务</span>\n<span>requestIdleCallback</span><span>(</span>workLoop<span>)</span><span>;</span>\n\n<span>function</span> <span>workLoop</span><span>(</span><span>deadline</span><span>)</span> <span>{</span>\n  <span>let</span> shouldYield <span>=</span> <span>false</span><span>;</span>\n  <span>while</span> <span>(</span>nextUnitOfWork <span>&amp;&amp;</span> <span>!</span>shouldYield<span>)</span> <span>{</span>\n    nextUnitOfWork <span>=</span> <span>performUnitOfWork</span><span>(</span>nextUnitOfWork<span>)</span>\n    shouldYield <span>=</span> deadline<span>.</span><span>timeRemaining</span><span>(</span><span>)</span> <span>&lt;</span> <span>1</span>\n  <span>}</span>\n  <span>requestIdleCallback</span><span>(</span>workLoop<span>)</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br></div></div><h2 id=\"如何处理一个-fiber\"> 如何处理一个 fiber</h2>\n<p><img src=\"/code/images/fiber.png\" alt=\"fiber\"></p>\n<ol>\n<li>创建对应的 dom</li>\n<li>将自身的 dom 插入到父 dom 上</li>\n<li>为 children 创建 fiber\n<ol>\n<li>为每一个 child 创建 parent 指向当前 fiber</li>\n<li>创建当前 fiber 到第一个 child 的指向</li>\n<li>为相邻的 child 创建前一个到后一个的 sibling 指向</li>\n</ol>\n</li>\n<li>找到下一个任务单元返回\n<ol>\n<li>当前 fiber 有 child 返回它</li>\n<li>当前 fiber 有 sibling 返回它</li>\n<li>没有 child 也没有 sibling，那就回到 4.2 找 parent 的 sibling</li>\n</ol>\n</li>\n</ol>\n<div><pre><code><span>function</span> <span>performUnitOfWork</span><span>(</span><span>fiber</span><span>)</span> <span>{</span>\n  <span>if</span> <span>(</span><span>!</span>fiber<span>.</span>dom<span>)</span> <span>{</span>\n    fiber<span>.</span>dom <span>=</span> <span>createDom</span><span>(</span>fiber<span>)</span>\n  <span>}</span>\n  <span>if</span> <span>(</span>fiber<span>.</span>parent<span>)</span> <span>{</span>\n    fiber<span>.</span>parent<span>.</span>dom<span>.</span><span>appendChild</span><span>(</span>fiber<span>.</span>dom<span>)</span>\n  <span>}</span>\n  <span>// 为每个子元素创建新的 fiber</span>\n  <span>const</span> elements <span>=</span> fiber<span>.</span>props<span>.</span>children\n  <span>let</span> index <span>=</span> <span>0</span>\n  <span>let</span> prevSibling <span>=</span> <span>null</span>\n  <span>while</span> <span>(</span>index <span>&lt;</span> elements<span>.</span>length<span>)</span> <span>{</span>\n    <span>const</span> element <span>=</span> elements<span>[</span>index<span>]</span>\n    <span>const</span> newFiber <span>=</span> <span>{</span>\n      type<span>:</span> element<span>.</span>type<span>,</span>\n      props<span>:</span> element<span>.</span>props<span>,</span>\n      parent<span>:</span> fiber<span>,</span>\n      dom<span>:</span> <span>null</span>\n    <span>}</span><span>;</span>\n    <span>// 根据上面的图示，父节点只链接第一个子节点</span>\n    <span>if</span> <span>(</span>index <span>===</span> <span>0</span><span>)</span> <span>{</span>\n      fiber<span>.</span>child <span>=</span> newFiber\n    <span>}</span> <span>else</span> <span>{</span>\n      <span>// 兄节点链接弟节点</span>\n      prevSibling<span>.</span>sibling <span>=</span> newFiber\n    <span>}</span>\n    prevSibling <span>=</span> newFiber\n    index<span>++</span>\n  <span>}</span>\n  <span>// 返回下一个任务单元（fiber）</span>\n  <span>// 有子节点直接返回</span>\n  <span>if</span> <span>(</span>fiber<span>.</span>child<span>)</span> <span>{</span>\n    <span>return</span> fiber<span>.</span>child\n  <span>}</span>\n  <span>// 没有子节点则找兄弟节点，兄弟节点也没有找父节点的兄弟节点，</span>\n  <span>// 循环遍历直至找到为止</span>\n  <span>let</span> nextFiber <span>=</span> fiber\n  <span>while</span> <span>(</span>nextFiber<span>)</span> <span>{</span>\n    <span>if</span> <span>(</span>nextFiber<span>.</span>sibling<span>)</span> <span>{</span>\n      <span>return</span> nextFiber<span>.</span>sibling\n    <span>}</span>\n    nextFiber <span>=</span> nextFiber<span>.</span>parent\n  <span>}</span>\n  <span>return</span> <span>null</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br></div></div><h2 id=\"整体一览\"> 整体一览</h2>\n<div><pre><code><span>let</span> nextUnitOfWork <span>=</span> <span>null</span>\n\n<span>// 一旦浏览器空闲，就触发执行单元任务</span>\n<span>requestIdleCallback</span><span>(</span>workLoop<span>)</span><span>;</span>\n\n<span>function</span> <span>createDom</span><span>(</span><span>fiber</span><span>)</span> <span>{</span>\n  <span>const</span> dom <span>=</span> fiber<span>.</span>type <span>===</span> <span>'TEXT_ELEMENT'</span>\n      <span>?</span> document<span>.</span><span>createTextNode</span><span>(</span><span>''</span><span>)</span>\n      <span>:</span> document<span>.</span><span>createElement</span><span>(</span>fiber<span>.</span>type<span>)</span>\n  <span>const</span> <span>isProperty</span> <span>=</span> <span>key</span> <span>=></span> key <span>!==</span> <span>'children'</span>\n  Object<span>.</span><span>keys</span><span>(</span>fiber<span>.</span>props<span>)</span>\n    <span>.</span><span>filter</span><span>(</span>isProperty<span>)</span>\n    <span>.</span><span>forEach</span><span>(</span><span>name</span> <span>=></span> <span>{</span>\n      dom<span>[</span>name<span>]</span> <span>=</span> fiber<span>.</span>props<span>[</span>name<span>]</span><span>;</span>\n    <span>}</span><span>)</span>\n  <span>return</span> dom\n<span>}</span>\n\n<span>// render 设置 nextUnitOfWork 为根的 fiber</span>\n<span>export</span> <span>function</span> <span>render</span><span>(</span><span>element<span>,</span> container</span><span>)</span> <span>{</span>\n  nextUnitOfWork <span>=</span> <span>{</span>\n    dom<span>:</span> container<span>,</span>\n    props<span>:</span> <span>{</span>\n      children<span>:</span> <span>[</span>element<span>]</span>\n    <span>}</span>\n  <span>}</span>\n<span>}</span>\n\n<span>function</span> <span>workLoop</span><span>(</span><span>deadline</span><span>)</span> <span>{</span>\n  <span>let</span> shouldYield <span>=</span> <span>false</span><span>;</span>\n  <span>while</span> <span>(</span>nextUnitOfWork <span>&amp;&amp;</span> <span>!</span>shouldYield<span>)</span> <span>{</span>\n    nextUnitOfWork <span>=</span> <span>performUnitOfWork</span><span>(</span>nextUnitOfWork<span>)</span>\n    shouldYield <span>=</span> deadline<span>.</span><span>timeRemaining</span><span>(</span><span>)</span> <span>&lt;</span> <span>1</span>\n  <span>}</span>\n  <span>requestIdleCallback</span><span>(</span>workLoop<span>)</span>\n<span>}</span>\n\n<span>// 处理一个 fiber</span>\n<span>function</span> <span>performUnitOfWork</span><span>(</span><span>fiber</span><span>)</span> <span>{</span>\n  <span>if</span> <span>(</span><span>!</span>fiber<span>.</span>dom<span>)</span> <span>{</span>\n    fiber<span>.</span>dom <span>=</span> <span>createDom</span><span>(</span>fiber<span>)</span>\n  <span>}</span>\n  <span>if</span> <span>(</span>fiber<span>.</span>parent<span>)</span> <span>{</span>\n    fiber<span>.</span>parent<span>.</span>dom<span>.</span><span>appendChild</span><span>(</span>fiber<span>.</span>dom<span>)</span>\n  <span>}</span>\n  <span>// 为每个子元素创建新的 fiber</span>\n  <span>const</span> elements <span>=</span> fiber<span>.</span>props<span>.</span>children\n  <span>let</span> index <span>=</span> <span>0</span>\n  <span>let</span> prevSibling <span>=</span> <span>null</span>\n  <span>while</span> <span>(</span>index <span>&lt;</span> elements<span>.</span>length<span>)</span> <span>{</span>\n    <span>const</span> element <span>=</span> elements<span>[</span>index<span>]</span>\n    <span>const</span> newFiber <span>=</span> <span>{</span>\n      type<span>:</span> element<span>.</span>type<span>,</span>\n      props<span>:</span> element<span>.</span>props<span>,</span>\n      parent<span>:</span> fiber<span>,</span>\n      dom<span>:</span> <span>null</span>\n    <span>}</span><span>;</span>\n    <span>// 根据上面的图示，父节点只链接第一个子节点</span>\n    <span>if</span> <span>(</span>index <span>===</span> <span>0</span><span>)</span> <span>{</span>\n      fiber<span>.</span>child <span>=</span> newFiber\n    <span>}</span> <span>else</span> <span>{</span>\n      <span>// 兄节点链接弟节点</span>\n      prevSibling<span>.</span>sibling <span>=</span> newFiber\n    <span>}</span>\n    prevSibling <span>=</span> newFiber\n    index<span>++</span>\n  <span>}</span>\n  <span>// 返回下一个任务单元（fiber）</span>\n  <span>// 有子节点直接返回</span>\n  <span>if</span> <span>(</span>fiber<span>.</span>child<span>)</span> <span>{</span>\n    <span>return</span> fiber<span>.</span>child\n  <span>}</span>\n  <span>// 没有子节点则找兄弟节点，兄弟节点也没有找父节点的兄弟节点，</span>\n  <span>// 循环遍历直至找到为止</span>\n  <span>let</span> nextFiber <span>=</span> fiber\n  <span>while</span> <span>(</span>nextFiber<span>)</span> <span>{</span>\n    <span>if</span> <span>(</span>nextFiber<span>.</span>sibling<span>)</span> <span>{</span>\n      <span>return</span> nextFiber<span>.</span>sibling\n    <span>}</span>\n    nextFiber <span>=</span> nextFiber<span>.</span>parent\n  <span>}</span>\n  <span>return</span> <span>null</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br><span>82</span><br><span>83</span><br></div></div><div><p>问题</p>\n<p>目前虽然实现的中断遍历过程，但是中断之后可能会造成页面只渲染一部分的情况...</p>\n</div>\n",
      "image": "https://x-vic.gitee.io/code/code/code/images/fiber.png",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "函数组件",
      "url": "https://x-vic.gitee.io/code/code/views/owner-react/functionComponent/",
      "id": "https://x-vic.gitee.io/code/code/views/owner-react/functionComponent/",
      "content_html": "<h2 id=\"函数组件是怎样转化的\"> 函数组件是怎样转化的？</h2>\n<div><pre><code><span>/** @jsx Redact.createElement */</span>\n<span>function</span> <span>App</span><span>(</span><span>props</span><span>)</span> <span>{</span>\n  <span>return</span> <span><span><span>&lt;</span>h1</span><span>></span></span><span>Hi </span><span>{</span>props<span>.</span>name<span>}</span><span><span><span>&lt;/</span>h1</span><span>></span></span><span>;</span>\n<span>}</span><span>;</span>\n<span>// 等效 JS 代码 👇</span>\n<span>function</span> <span>App</span><span>(</span><span>props</span><span>)</span> <span>{</span>\n  <span>return</span> Redact<span>.</span><span>createElement</span><span>(</span>\n    <span>\"h1\"</span><span>,</span>\n    <span>null</span><span>,</span>\n    <span>\"Hi \"</span><span>,</span>\n    props<span>.</span>name\n  <span>)</span><span>;</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br></div></div><div><p>函数组件与普通`jsx`的不同点</p>\n<ol>\n<li>函数组件的 fiber 节点没有对应 DOM</li>\n<li>函数组件的 children 来自函数执行结果，而不是像标签元素一样直接从 props 获取，因为 children 不只是函数组件使用时包含的子孙节点，还需要组合组件本身的结构</li>\n</ol>\n</div>\n<h2 id=\"实现一览\"> 实现一览</h2>\n<blockquote>\n<p>注意以下代码省略了未改动部分</p>\n</blockquote>\n<div><div><br><br><br><br><br><br><br><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><br><br><br><br><br><br><br><div>&nbsp;</div><br><br><br><br><br><br><br><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><br><br><br><br><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><br><br><br><br><br><br><br><br><br><br><br><br><br><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><br></div><pre><code><span>function</span> <span>commitWork</span><span>(</span><span>fiber</span><span>)</span> <span>{</span>\n  <span>if</span> <span>(</span><span>!</span>fiber<span>)</span> <span>{</span>\n    <span>return</span><span>;</span>\n  <span>}</span>\n\n  <span>// 当 fiber 是函数组件时节点不存在 DOM，</span>\n  <span>// 故需要遍历父节点以找到最近的有 DOM 的节点</span>\n  <span>let</span> domParentFiber <span>=</span> fiber<span>.</span>parent<span>;</span>\n  <span>while</span> <span>(</span><span>!</span>domParentFiber<span>.</span>dom<span>)</span> <span>{</span>\n    domParentFiber <span>=</span> domParentFiber<span>.</span>parent<span>;</span>\n  <span>}</span>\n  <span>const</span> domParent <span>=</span> domParentFiber<span>.</span>dom<span>;</span>\n  <span>if</span> <span>(</span>fiber<span>.</span>effectTag <span>===</span> <span>\"PLACEMENT\"</span> <span>&amp;&amp;</span> fiber<span>.</span>dom <span>!=</span> <span>null</span><span>)</span> <span>{</span>\n    domParent<span>.</span><span>appendChild</span><span>(</span>fiber<span>.</span>dom<span>)</span><span>;</span>\n  <span>}</span> <span>else</span> <span>if</span> <span>(</span>fiber<span>.</span>effectTag <span>===</span> <span>\"UPDATE\"</span> <span>&amp;&amp;</span> fiber<span>.</span>dom <span>!=</span> <span>null</span><span>)</span> <span>{</span>\n    <span>updateDom</span><span>(</span>fiber<span>.</span>dom<span>,</span> fiber<span>.</span>alternate<span>.</span>props<span>,</span> fiber<span>.</span>props<span>)</span><span>;</span>\n  <span>}</span> <span>else</span> <span>if</span> <span>(</span>fiber<span>.</span>effectTag <span>===</span> <span>\"DELETION\"</span><span>)</span> <span>{</span>\n    <span>// 直接移除 DOM 替换成 commitDeletion 函数</span>\n    <span>commitDeletion</span><span>(</span>fiber<span>,</span> domParent<span>)</span><span>;</span>\n  <span>}</span>\n\n  <span>commitWork</span><span>(</span>fiber<span>.</span>child<span>)</span><span>;</span>\n  <span>commitWork</span><span>(</span>fiber<span>.</span>sibling<span>)</span><span>;</span>\n<span>}</span>\n\n<span>// 新增函数，移除 DOM 节点</span>\n<span>function</span> <span>commitDeletion</span><span>(</span><span>fiber<span>,</span> domParent</span><span>)</span> <span>{</span>\n  <span>// 当 child 是函数组件时不存在 DOM，</span>\n  <span>// 故需要递归遍历子节点找到真正的 DOM</span>\n  <span>if</span> <span>(</span>fiber<span>.</span>dom<span>)</span> <span>{</span>\n    domParent<span>.</span><span>removeChild</span><span>(</span>fiber<span>.</span>dom<span>)</span><span>;</span>\n  <span>}</span> <span>else</span> <span>{</span>\n    <span>commitDeletion</span><span>(</span>fiber<span>.</span>child<span>,</span> domParent<span>)</span><span>;</span>\n  <span>}</span>\n<span>}</span>\n\n<span>function</span> <span>performUnitOfWork</span><span>(</span><span>fiber</span><span>)</span> <span>{</span>\n  <span>const</span> isFunctionComponent <span>=</span> fiber<span>.</span>type <span>instanceof</span> <span>Function</span><span>;</span>\n  <span>// 原本逻辑挪到 updateHostComponent 函数</span>\n  <span>if</span> <span>(</span>isFunctionComponent<span>)</span> <span>{</span>\n    <span>updateFunctionComponent</span><span>(</span>fiber<span>)</span><span>;</span>\n  <span>}</span> <span>else</span> <span>{</span>\n    <span>updateHostComponent</span><span>(</span>fiber<span>)</span><span>;</span>\n  <span>}</span>\n  <span>if</span> <span>(</span>fiber<span>.</span>child<span>)</span> <span>{</span>\n    <span>return</span> fiber<span>.</span>child<span>;</span>\n  <span>}</span>\n  <span>let</span> nextFiber <span>=</span> fiber<span>;</span>\n  <span>while</span> <span>(</span>nextFiber<span>)</span> <span>{</span>\n    <span>if</span> <span>(</span>nextFiber<span>.</span>sibling<span>)</span> <span>{</span>\n      <span>return</span> nextFiber<span>.</span>sibling<span>;</span>\n    <span>}</span>\n    nextFiber <span>=</span> nextFiber<span>.</span>parent<span>;</span>\n  <span>}</span>\n<span>}</span>\n\n<span>// 新增函数，处理函数组件</span>\n<span>function</span> <span>updateFunctionComponent</span><span>(</span><span>fiber</span><span>)</span> <span>{</span>\n  <span>// 执行函数组件得到 children</span>\n  <span>const</span> children <span>=</span> <span>[</span>fiber<span>.</span><span>type</span><span>(</span>fiber<span>.</span>props<span>)</span><span>]</span><span>;</span>\n  <span>reconcileChildren</span><span>(</span>fiber<span>,</span> children<span>)</span><span>;</span>\n<span>}</span>\n\n<span>// 新增函数，处理原生标签组件</span>\n<span>function</span> <span>updateHostComponent</span><span>(</span><span>fiber</span><span>)</span> <span>{</span>\n  <span>if</span> <span>(</span><span>!</span>fiber<span>.</span>dom<span>)</span> <span>{</span>\n    fiber<span>.</span>dom <span>=</span> <span>createDom</span><span>(</span>fiber<span>)</span><span>;</span>\n  <span>}</span>\n  <span>reconcileChildren</span><span>(</span>fiber<span>,</span> fiber<span>.</span>props<span>.</span>children<span>)</span><span>;</span>\n<span>}</span>\n</code></pre><div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "createElement && render",
      "url": "https://x-vic.gitee.io/code/code/views/owner-react/",
      "id": "https://x-vic.gitee.io/code/code/views/owner-react/",
      "content_html": "<h2 id=\"createelement\"> createElement</h2>\n<p>将 <code>babel</code> 解析过后的参数处理成一个虚拟 <code>dom</code></p>\n<div><pre><code><span>export</span> <span>function</span> <span>createElement</span><span>(</span><span>type<span>,</span> props<span>,</span> <span>...</span>children</span><span>)</span> <span>{</span>\n  <span>return</span> <span>{</span>\n    type<span>,</span>\n    props<span>:</span> <span>{</span>\n      <span>...</span>props<span>,</span>\n      children<span>:</span> children<span>.</span><span>map</span><span>(</span><span>child</span> <span>=></span> <span>typeof</span> child <span>===</span> <span>'object'</span> <span>?</span> child <span>:</span> <span>createTextElement</span><span>(</span>child<span>)</span><span>)</span>\n    <span>}</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br></div></div><details><summary>createTextElement的实现</summary>\n<div><pre><code><span>function</span> <span>createTextElement</span><span>(</span><span>text</span><span>)</span> <span>{</span>\n  <span>return</span> <span>{</span>\n    type<span>:</span> <span>'TEXT_ELEMENT'</span><span>,</span>\n    props<span>:</span> <span>{</span>\n      nodeValue<span>:</span> text<span>,</span>\n      children<span>:</span> <span>[</span><span>]</span>\n    <span>}</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br></div></div></details>\n<h2 id=\"render\"> render</h2>\n<div><pre><code><span>export</span> <span>function</span> <span>render</span><span>(</span><span>element<span>,</span> container</span><span>)</span> <span>{</span>\n  <span>// 创建节点</span>\n  <span>const</span> dom <span>=</span> element<span>.</span>type <span>===</span> <span>'TEXT_ELEMENT'</span>\n    <span>?</span> document<span>.</span><span>createTextNode</span><span>(</span><span>''</span><span>)</span>\n    <span>:</span> document<span>.</span><span>createElement</span><span>(</span>element<span>.</span>type<span>)</span>\n  <span>const</span> <span>isProperty</span> <span>=</span> <span>key</span> <span>=></span> key <span>!==</span> <span>'children'</span>\n  Object<span>.</span><span>keys</span><span>(</span>element<span>.</span>props<span>)</span>\n    <span>.</span><span>filter</span><span>(</span>isProperty<span>)</span>\n    <span>.</span><span>forEach</span><span>(</span><span>name</span> <span>=></span> <span>{</span>\n      dom<span>[</span>name<span>]</span> <span>=</span> element<span>.</span>props<span>[</span>name<span>]</span>\n    <span>}</span><span>)</span>\n  <span>// 递归遍历子节点</span>\n  element<span>.</span>props<span>.</span>children<span>.</span><span>forEach</span><span>(</span><span>child</span> <span>=></span> <span>render</span><span>(</span>child<span>,</span> dom<span>)</span><span>)</span>\n  container<span>.</span><span>appendChild</span><span>(</span>dom<span>)</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "reconciliation",
      "url": "https://x-vic.gitee.io/code/code/views/owner-react/reconciliation/",
      "id": "https://x-vic.gitee.io/code/code/views/owner-react/reconciliation/",
      "content_html": "<blockquote>\n<p>目前我们只添加节点到 DOM，还没考虑更新和删除节点的情况。要处理这2种情况，需要对比上次渲染的 fiber 和当前渲染的 fiber 的差异，根据差异决定是更新还是删除节点。React 把这个过程叫 <code>Reconciliation</code>。</p>\n</blockquote>\n<h2 id=\"概览\"> 概览</h2>\n<div><div><br><br><br><br><br><br><div>&nbsp;</div><br><br><br><br><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><br><br><div>&nbsp;</div><br><div>&nbsp;</div><br><br><br><br><br><br><br><br><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><br><br><br><br><br><br><br><br><br><br><div>&nbsp;</div><br><div>&nbsp;</div><br><br><br><br><div>&nbsp;</div><br><div>&nbsp;</div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div>&nbsp;</div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div>&nbsp;</div><br><br><br><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><br><br><br><br><br><br><br><br><br><br><br><br></div><pre><code><span>function</span> <span>createDom</span><span>(</span><span>fiber</span><span>)</span> <span>{</span>\n  <span>const</span> dom <span>=</span>\n    fiber<span>.</span>type <span>===</span> <span>\"TEXT_ELEMENT\"</span>\n      <span>?</span> document<span>.</span><span>createTextNode</span><span>(</span><span>\"\"</span><span>)</span>\n      <span>:</span> document<span>.</span><span>createElement</span><span>(</span>fiber<span>.</span>type<span>)</span><span>;</span>\n\n  <span>updateDom</span><span>(</span>dom<span>,</span> <span>{</span><span>}</span><span>,</span> fiber<span>.</span>props<span>)</span><span>;</span>\n\n  <span>return</span> dom<span>;</span>\n<span>}</span>\n\n<span>const</span> <span>isEvent</span> <span>=</span> <span>key</span> <span>=></span> key<span>.</span><span>startsWith</span><span>(</span><span>\"on\"</span><span>)</span><span>;</span>\n<span>const</span> <span>isProperty</span> <span>=</span> <span>key</span> <span>=></span> key <span>!==</span> <span>\"children\"</span> <span>&amp;&amp;</span> <span>!</span><span>isEvent</span><span>(</span>key<span>)</span><span>;</span>\n<span>const</span> <span>isNew</span> <span>=</span> <span>(</span><span>prev<span>,</span> next</span><span>)</span> <span>=></span> <span>key</span> <span>=></span> prev<span>[</span>key<span>]</span> <span>!==</span> next<span>[</span>key<span>]</span><span>;</span>\n<span>const</span> <span>isGone</span> <span>=</span> <span>(</span><span>prev<span>,</span> next</span><span>)</span> <span>=></span> <span>key</span> <span>=></span> <span>!</span><span>(</span>key <span>in</span> next<span>)</span><span>;</span>\n\n<span>// 新增函数，更新 DOM 节点属性</span>\n<span>function</span> <span>updateDom</span><span>(</span><span>dom<span>,</span> prevProps <span>=</span> <span>{</span><span>}</span><span>,</span> nextProps <span>=</span> <span>{</span><span>}</span></span><span>)</span> <span>{</span>\n  <span>// 以 “on” 开头的属性作为事件要特别处理</span>\n  <span>// 移除旧的或者变化了的的事件处理函数</span>\n  Object<span>.</span><span>keys</span><span>(</span>prevProps<span>)</span>\n    <span>.</span><span>filter</span><span>(</span>isEvent<span>)</span>\n    <span>.</span><span>filter</span><span>(</span><span>key</span> <span>=></span> <span>!</span><span>(</span>key <span>in</span> nextProps<span>)</span> <span>||</span> <span>isNew</span><span>(</span>prevProps<span>,</span> nextProps<span>)</span><span>(</span>key<span>)</span><span>)</span>\n    <span>.</span><span>forEach</span><span>(</span><span>name</span> <span>=></span> <span>{</span>\n      <span>const</span> eventType <span>=</span> name<span>.</span><span>toLowerCase</span><span>(</span><span>)</span><span>.</span><span>substring</span><span>(</span><span>2</span><span>)</span><span>;</span>\n      dom<span>.</span><span>removeEventListener</span><span>(</span>eventType<span>,</span> prevProps<span>[</span>name<span>]</span><span>)</span><span>;</span>\n    <span>}</span><span>)</span><span>;</span>\n\n  <span>// 移除旧的属性</span>\n  Object<span>.</span><span>keys</span><span>(</span>prevProps<span>)</span>\n    <span>.</span><span>filter</span><span>(</span>isProperty<span>)</span>\n    <span>.</span><span>filter</span><span>(</span><span>isGone</span><span>(</span>prevProps<span>,</span> nextProps<span>)</span><span>)</span>\n    <span>.</span><span>forEach</span><span>(</span><span>name</span> <span>=></span> <span>{</span>\n      dom<span>[</span>name<span>]</span> <span>=</span> <span>\"\"</span><span>;</span>\n    <span>}</span><span>)</span><span>;</span>\n\n  <span>// 添加或者更新属性</span>\n  Object<span>.</span><span>keys</span><span>(</span>nextProps<span>)</span>\n    <span>.</span><span>filter</span><span>(</span>isProperty<span>)</span>\n    <span>.</span><span>filter</span><span>(</span><span>isNew</span><span>(</span>prevProps<span>,</span> nextProps<span>)</span><span>)</span>\n    <span>.</span><span>forEach</span><span>(</span><span>name</span> <span>=></span> <span>{</span>\n      <span>// React 规定 style 内联样式是驼峰命名的对象，</span>\n      <span>// 根据规范给 style 每个属性单独赋值</span>\n      <span>if</span> <span>(</span>name <span>===</span> <span>\"style\"</span><span>)</span> <span>{</span>\n        Object<span>.</span><span>entries</span><span>(</span>nextProps<span>[</span>name<span>]</span><span>)</span><span>.</span><span>forEach</span><span>(</span><span>(</span><span><span>[</span>key<span>,</span> value<span>]</span></span><span>)</span> <span>=></span> <span>{</span>\n          dom<span>.</span>style<span>[</span>key<span>]</span> <span>=</span> value<span>;</span>\n        <span>}</span><span>)</span><span>;</span>\n      <span>}</span> <span>else</span> <span>{</span>\n        dom<span>[</span>name<span>]</span> <span>=</span> nextProps<span>[</span>name<span>]</span><span>;</span>\n      <span>}</span>\n    <span>}</span><span>)</span><span>;</span>\n\n  <span>// 添加新的事件处理函数</span>\n  Object<span>.</span><span>keys</span><span>(</span>nextProps<span>)</span>\n    <span>.</span><span>filter</span><span>(</span>isEvent<span>)</span>\n    <span>.</span><span>filter</span><span>(</span><span>isNew</span><span>(</span>prevProps<span>,</span> nextProps<span>)</span><span>)</span>\n    <span>.</span><span>forEach</span><span>(</span><span>name</span> <span>=></span> <span>{</span>\n      <span>const</span> eventType <span>=</span> name<span>.</span><span>toLowerCase</span><span>(</span><span>)</span><span>.</span><span>substring</span><span>(</span><span>2</span><span>)</span><span>;</span>\n      dom<span>.</span><span>addEventListener</span><span>(</span>eventType<span>,</span> nextProps<span>[</span>name<span>]</span><span>)</span><span>;</span>\n    <span>}</span><span>)</span><span>;</span>\n<span>}</span>\n\n<span>function</span> <span>commitRoot</span><span>(</span><span>)</span> <span>{</span>\n  deletions<span>.</span><span>forEach</span><span>(</span>commitWork<span>)</span><span>;</span>\n  <span>commitWork</span><span>(</span>wipRoot<span>.</span>child<span>)</span><span>;</span>\n  currentRoot <span>=</span> wipRoot<span>;</span>\n  wipRoot <span>=</span> <span>null</span><span>;</span>\n<span>}</span>\n\n<span>function</span> <span>commitWork</span><span>(</span><span>fiber</span><span>)</span> <span>{</span>\n  <span>if</span> <span>(</span><span>!</span>fiber<span>)</span> <span>{</span>\n    <span>return</span><span>;</span>\n  <span>}</span>\n  <span>const</span> domParent <span>=</span> fiber<span>.</span>parent<span>.</span>dom<span>;</span>\n  <span>if</span> <span>(</span>fiber<span>.</span>effectTag <span>===</span> <span>\"PLACEMENT\"</span> <span>&amp;&amp;</span> fiber<span>.</span>dom <span>!=</span> <span>null</span><span>)</span> <span>{</span>\n    domParent<span>.</span><span>appendChild</span><span>(</span>fiber<span>.</span>dom<span>)</span><span>;</span>\n  <span>}</span> <span>else</span> <span>if</span> <span>(</span>fiber<span>.</span>effectTag <span>===</span> <span>\"UPDATE\"</span> <span>&amp;&amp;</span> fiber<span>.</span>dom <span>!=</span> <span>null</span><span>)</span> <span>{</span>\n    <span>updateDom</span><span>(</span>fiber<span>.</span>dom<span>,</span> fiber<span>.</span>alternate<span>.</span>props<span>,</span> fiber<span>.</span>props<span>)</span><span>;</span>\n  <span>}</span> <span>else</span> <span>if</span> <span>(</span>fiber<span>.</span>effectTag <span>===</span> <span>\"DELETION\"</span><span>)</span> <span>{</span>\n    domParent<span>.</span><span>removeChild</span><span>(</span>fiber<span>.</span>dom<span>)</span><span>;</span>\n  <span>}</span>\n  <span>commitWork</span><span>(</span>fiber<span>.</span>child<span>)</span><span>;</span>\n  <span>commitWork</span><span>(</span>fiber<span>.</span>sibling<span>)</span><span>;</span>\n<span>}</span>\n\n<span>function</span> <span>render</span><span>(</span><span>element<span>,</span> container</span><span>)</span> <span>{</span>\n  wipRoot <span>=</span> <span>{</span>\n    dom<span>:</span> container<span>,</span>\n    props<span>:</span> <span>{</span>\n      children<span>:</span> <span>[</span>element<span>]</span>\n    <span>}</span><span>,</span>\n    alternate<span>:</span> currentRoot\n  <span>}</span><span>;</span>\n  deletions <span>=</span> <span>[</span><span>]</span><span>;</span>\n  nextUnitOfWork <span>=</span> wipRoot<span>;</span>\n<span>}</span>\n\n<span>let</span> nextUnitOfWork <span>=</span> <span>null</span><span>;</span>\n<span>let</span> currentRoot <span>=</span> <span>null</span><span>;</span>\n<span>let</span> wipRoot <span>=</span> <span>null</span><span>;</span>\n<span>let</span> deletions <span>=</span> <span>null</span><span>;</span>\n\n<span>function</span> <span>workLoop</span><span>(</span><span>deadline</span><span>)</span> <span>{</span>\n  <span>let</span> shouldYield <span>=</span> <span>false</span><span>;</span>\n  <span>while</span> <span>(</span>nextUnitOfWork <span>&amp;&amp;</span> <span>!</span>shouldYield<span>)</span> <span>{</span>\n    nextUnitOfWork <span>=</span> <span>performUnitOfWork</span><span>(</span>nextUnitOfWork<span>)</span><span>;</span>\n    shouldYield <span>=</span> deadline<span>.</span><span>timeRemaining</span><span>(</span><span>)</span> <span>&lt;</span> <span>1</span><span>;</span>\n  <span>}</span>\n\n  <span>if</span> <span>(</span><span>!</span>nextUnitOfWork <span>&amp;&amp;</span> wipRoot<span>)</span> <span>{</span>\n    <span>commitRoot</span><span>(</span><span>)</span><span>;</span>\n  <span>}</span>\n\n  <span>requestIdleCallback</span><span>(</span>workLoop<span>)</span><span>;</span>\n<span>}</span>\n\n<span>requestIdleCallback</span><span>(</span>workLoop<span>)</span><span>;</span>\n\n<span>function</span> <span>performUnitOfWork</span><span>(</span><span>fiber</span><span>)</span> <span>{</span>\n  <span>if</span> <span>(</span><span>!</span>fiber<span>.</span>dom<span>)</span> <span>{</span>\n    fiber<span>.</span>dom <span>=</span> <span>createDom</span><span>(</span>fiber<span>)</span><span>;</span>\n  <span>}</span>\n\n  <span>const</span> elements <span>=</span> fiber<span>.</span>props<span>.</span>children<span>;</span>\n  <span>// 原本添加 fiber 的逻辑挪到 reconcileChildren 函数</span>\n  <span>reconcileChildren</span><span>(</span>fiber<span>,</span> elements<span>)</span><span>;</span>\n\n  <span>if</span> <span>(</span>fiber<span>.</span>child<span>)</span> <span>{</span>\n    <span>return</span> fiber<span>.</span>child<span>;</span>\n  <span>}</span>\n  <span>let</span> nextFiber <span>=</span> fiber<span>;</span>\n  <span>while</span> <span>(</span>nextFiber<span>)</span> <span>{</span>\n    <span>if</span> <span>(</span>nextFiber<span>.</span>sibling<span>)</span> <span>{</span>\n      <span>return</span> nextFiber<span>.</span>sibling<span>;</span>\n    <span>}</span>\n    nextFiber <span>=</span> nextFiber<span>.</span>parent<span>;</span>\n  <span>}</span>\n<span>}</span>\n\n<span>// 新增函数</span>\n<span>function</span> <span>reconcileChildren</span><span>(</span><span>wipFiber<span>,</span> elements</span><span>)</span> <span>{</span>\n  <span>let</span> index <span>=</span> <span>0</span><span>;</span>\n  <span>// 上次渲染完成之后的 fiber 节点</span>\n  <span>let</span> oldFiber <span>=</span> wipFiber<span>.</span>alternate <span>&amp;&amp;</span> wipFiber<span>.</span>alternate<span>.</span>child<span>;</span>\n  <span>let</span> prevSibling <span>=</span> <span>null</span><span>;</span>\n\n  <span>// 扁平化 props.children，处理函数组件的 children</span>\n  elements <span>=</span> elements<span>.</span><span>flat</span><span>(</span><span>)</span><span>;</span>\n\n  <span>while</span> <span>(</span>index <span>&lt;</span> elements<span>.</span>length <span>||</span> oldFiber <span>!=</span> <span>null</span><span>)</span> <span>{</span>\n    <span>// 本次需要渲染的子元素</span>\n    <span>const</span> element <span>=</span> elements<span>[</span>index<span>]</span><span>;</span>\n    <span>let</span> newFiber <span>=</span> <span>null</span><span>;</span>\n\n    <span>// 比较当前和上一次渲染的 type，即 DOM tag 'div'，</span>\n    <span>// 暂不考虑自定义组件</span>\n    <span>const</span> sameType <span>=</span> oldFiber <span>&amp;&amp;</span> element <span>&amp;&amp;</span> element<span>.</span>type <span>===</span> oldFiber<span>.</span>type<span>;</span>\n\n    <span>// 同类型节点，只需更新节点 props 即可</span>\n    <span>if</span> <span>(</span>sameType<span>)</span> <span>{</span>\n      newFiber <span>=</span> <span>{</span>\n        type<span>:</span> oldFiber<span>.</span>type<span>,</span>\n        props<span>:</span> element<span>.</span>props<span>,</span>\n        dom<span>:</span> oldFiber<span>.</span>dom<span>,</span> <span>// 复用旧节点的 DOM</span>\n        parent<span>:</span> wipFiber<span>,</span>\n        alternate<span>:</span> oldFiber<span>,</span>\n        effectTag<span>:</span> <span>\"UPDATE\"</span> <span>// 新增属性，在提交/commit 阶段使用</span>\n      <span>}</span><span>;</span>\n    <span>}</span>\n    <span>// 不同类型节点且存在新的元素时，创建新的 DOM 节点</span>\n    <span>if</span> <span>(</span>element <span>&amp;&amp;</span> <span>!</span>sameType<span>)</span> <span>{</span>\n      newFiber <span>=</span> <span>{</span>\n        type<span>:</span> element<span>.</span>type<span>,</span>\n        props<span>:</span> element<span>.</span>props<span>,</span>\n        dom<span>:</span> <span>null</span><span>,</span>\n        parent<span>:</span> wipFiber<span>,</span>\n        alternate<span>:</span> <span>null</span><span>,</span>\n        effectTag<span>:</span> <span>\"PLACEMENT\"</span> <span>// PLACEMENT 表示需要添加新的节点</span>\n      <span>}</span><span>;</span>\n    <span>}</span>\n    <span>// 不同类型节点，且存在旧的 fiber 节点时，</span>\n    <span>// 需要移除该节点</span>\n    <span>if</span> <span>(</span>oldFiber <span>&amp;&amp;</span> <span>!</span>sameType<span>)</span> <span>{</span>\n      oldFiber<span>.</span>effectTag <span>=</span> <span>\"DELETION\"</span><span>;</span>\n      <span>// 当最后提交 fiber 树到 DOM 时，我们是从 wipRoot 开始的，</span>\n      <span>// 此时没有上一次的 fiber，所以这里用一个数组来跟踪需要</span>\n      <span>// 删除的节点</span>\n      deletions<span>.</span><span>push</span><span>(</span>oldFiber<span>)</span><span>;</span>\n    <span>}</span>\n\n    <span>if</span> <span>(</span>oldFiber<span>)</span> <span>{</span>\n      <span>// 同步更新下一个旧 fiber 节点</span>\n      oldFiber <span>=</span> oldFiber<span>.</span>sibling<span>;</span>\n    <span>}</span>\n\n    <span>if</span> <span>(</span>index <span>===</span> <span>0</span><span>)</span> <span>{</span>\n      wipFiber<span>.</span>child <span>=</span> newFiber<span>;</span>\n    <span>}</span> <span>else</span> <span>{</span>\n      prevSibling<span>.</span>sibling <span>=</span> newFiber<span>;</span>\n    <span>}</span>\n\n    prevSibling <span>=</span> newFiber<span>;</span>\n    index<span>++</span><span>;</span>\n  <span>}</span>\n<span>}</span>\n</code></pre><div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br><span>82</span><br><span>83</span><br><span>84</span><br><span>85</span><br><span>86</span><br><span>87</span><br><span>88</span><br><span>89</span><br><span>90</span><br><span>91</span><br><span>92</span><br><span>93</span><br><span>94</span><br><span>95</span><br><span>96</span><br><span>97</span><br><span>98</span><br><span>99</span><br><span>100</span><br><span>101</span><br><span>102</span><br><span>103</span><br><span>104</span><br><span>105</span><br><span>106</span><br><span>107</span><br><span>108</span><br><span>109</span><br><span>110</span><br><span>111</span><br><span>112</span><br><span>113</span><br><span>114</span><br><span>115</span><br><span>116</span><br><span>117</span><br><span>118</span><br><span>119</span><br><span>120</span><br><span>121</span><br><span>122</span><br><span>123</span><br><span>124</span><br><span>125</span><br><span>126</span><br><span>127</span><br><span>128</span><br><span>129</span><br><span>130</span><br><span>131</span><br><span>132</span><br><span>133</span><br><span>134</span><br><span>135</span><br><span>136</span><br><span>137</span><br><span>138</span><br><span>139</span><br><span>140</span><br><span>141</span><br><span>142</span><br><span>143</span><br><span>144</span><br><span>145</span><br><span>146</span><br><span>147</span><br><span>148</span><br><span>149</span><br><span>150</span><br><span>151</span><br><span>152</span><br><span>153</span><br><span>154</span><br><span>155</span><br><span>156</span><br><span>157</span><br><span>158</span><br><span>159</span><br><span>160</span><br><span>161</span><br><span>162</span><br><span>163</span><br><span>164</span><br><span>165</span><br><span>166</span><br><span>167</span><br><span>168</span><br><span>169</span><br><span>170</span><br><span>171</span><br><span>172</span><br><span>173</span><br><span>174</span><br><span>175</span><br><span>176</span><br><span>177</span><br><span>178</span><br><span>179</span><br><span>180</span><br><span>181</span><br><span>182</span><br><span>183</span><br><span>184</span><br><span>185</span><br><span>186</span><br><span>187</span><br><span>188</span><br><span>189</span><br><span>190</span><br><span>191</span><br><span>192</span><br><span>193</span><br><span>194</span><br><span>195</span><br><span>196</span><br><span>197</span><br><span>198</span><br><span>199</span><br><span>200</span><br><span>201</span><br><span>202</span><br><span>203</span><br><span>204</span><br><span>205</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "render & commit",
      "url": "https://x-vic.gitee.io/code/code/views/owner-react/render&commit/",
      "id": "https://x-vic.gitee.io/code/code/views/owner-react/render&commit/",
      "content_html": "<h2 id=\"render\"> render</h2>\n<div><div><br><br><div>&nbsp;</div><br><br><br><br><br><div>&nbsp;</div><br><br></div><pre><code><span>function</span> <span>render</span><span>(</span><span>element<span>,</span> container</span><span>)</span> <span>{</span>\n  <span>// render 时记录 wipRoot</span>\n  wipRoot <span>=</span> <span>{</span>\n    dom<span>:</span> container<span>,</span>\n    props<span>:</span> <span>{</span>\n      children<span>:</span> <span>[</span>element<span>]</span><span>,</span>\n    <span>}</span><span>,</span>\n  <span>}</span><span>;</span>\n  nextUnitOfWork <span>=</span> wipRoot\n<span>}</span>\n</code></pre><div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br></div></div><h2 id=\"何时做一次整体提交\"> 何时做一次整体提交</h2>\n<div><div><br><br><br><br><br><br><br><br><br><br><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><br><br><br></div><pre><code><span>function</span> <span>workLoop</span><span>(</span><span>deadline</span><span>)</span> <span>{</span>\n  <span>let</span> shouldYield <span>=</span> <span>false</span>\n  <span>while</span> <span>(</span>nextUnitOfWork <span>&amp;&amp;</span> <span>!</span>shouldYield<span>)</span> <span>{</span>\n    nextUnitOfWork <span>=</span> <span>performUnitOfWork</span><span>(</span>\n      nextUnitOfWork\n    <span>)</span><span>;</span>\n    shouldYield <span>=</span> deadline<span>.</span><span>timeRemaining</span><span>(</span><span>)</span> <span>&lt;</span> <span>1</span>\n  <span>}</span>\n  <span>// 当 nextUnitOfWork 为空则表示渲染 fiber 树完成了，</span>\n  <span>// 可以提交到 DOM 了</span>\n  <span>if</span> <span>(</span><span>!</span>nextUnitOfWork <span>&amp;&amp;</span> wipRoot<span>)</span> <span>{</span>\n    <span>commitRoot</span><span>(</span><span>)</span><span>;</span>\n  <span>}</span>\n  <span>requestIdleCallback</span><span>(</span>workLoop<span>)</span>\n<span>}</span>\n</code></pre><div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br></div></div><h2 id=\"commit\"> commit</h2>\n<div><div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><br><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><br></div><pre><code><span>function</span> <span>commitRoot</span><span>(</span><span>)</span> <span>{</span>\n  <span>commitWork</span><span>(</span>wipRoot<span>.</span>child<span>)</span><span>;</span>\n  wipRoot <span>=</span> <span>null</span><span>;</span>\n<span>}</span>\n\n<span>function</span> <span>commitWork</span><span>(</span><span>fiber</span><span>)</span> <span>{</span>\n  <span>if</span> <span>(</span><span>!</span>fiber<span>)</span> <span>{</span>\n    <span>return</span><span>;</span>\n  <span>}</span>\n  <span>const</span> domParent <span>=</span> fiber<span>.</span>parent<span>.</span>dom<span>;</span>\n  domParent<span>.</span><span>appendChild</span><span>(</span>fiber<span>.</span>dom<span>)</span><span>;</span>\n  <span>// 递归子节点和兄弟节点</span>\n  <span>commitWork</span><span>(</span>fiber<span>.</span>child<span>)</span><span>;</span>\n  <span>commitWork</span><span>(</span>fiber<span>.</span>sibling<span>)</span><span>;</span>\n<span>}</span>\n</code></pre><div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br></div></div><h2 id=\"整体一览\"> 整体一览</h2>\n<div><div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><br><br><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><br><br><br><div>&nbsp;</div><br><br><br><br><br><div>&nbsp;</div><br><br><br><br><div>&nbsp;</div><br><br><br><br><br><br><br><br><br><br><br><br><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre><code><span>function</span> <span>createDom</span><span>(</span><span>fiber</span><span>)</span> <span>{</span>\n  <span>const</span> dom <span>=</span>\n    fiber<span>.</span>type <span>==</span> <span>\"TEXT_ELEMENT\"</span>\n      <span>?</span> document<span>.</span><span>createTextNode</span><span>(</span><span>\"\"</span><span>)</span>\n      <span>:</span> document<span>.</span><span>createElement</span><span>(</span>fiber<span>.</span>type<span>)</span><span>;</span>\n​\n  <span>const</span> <span>isProperty</span> <span>=</span> <span>key</span> <span>=></span> key <span>!==</span> <span>\"children\"</span><span>;</span>\n  Object<span>.</span><span>keys</span><span>(</span>fiber<span>.</span>props<span>)</span>\n    <span>.</span><span>filter</span><span>(</span>isProperty<span>)</span>\n    <span>.</span><span>forEach</span><span>(</span><span>name</span> <span>=></span> <span>{</span>\n      dom<span>[</span>name<span>]</span> <span>=</span> fiber<span>.</span>props<span>[</span>name<span>]</span><span>;</span>\n    <span>}</span><span>)</span><span>;</span>\n​\n  <span>return</span> dom<span>;</span>\n<span>}</span>\n\n<span>// 新增函数，提交根结点到 DOM</span>\n<span>function</span> <span>commitRoot</span><span>(</span><span>)</span> <span>{</span>\n  <span>commitWork</span><span>(</span>wipRoot<span>.</span>child<span>)</span><span>;</span>\n  wipRoot <span>=</span> <span>null</span><span>;</span>\n<span>}</span>\n​\n<span>// 新增子函数</span>\n<span>function</span> <span>commitWork</span><span>(</span><span>fiber</span><span>)</span> <span>{</span>\n  <span>if</span> <span>(</span><span>!</span>fiber<span>)</span> <span>{</span>\n    <span>return</span><span>;</span>\n  <span>}</span>\n  <span>const</span> domParent <span>=</span> fiber<span>.</span>parent<span>.</span>dom<span>;</span>\n  domParent<span>.</span><span>appendChild</span><span>(</span>fiber<span>.</span>dom<span>)</span><span>;</span>\n  <span>// 递归子节点和兄弟节点</span>\n  <span>commitWork</span><span>(</span>fiber<span>.</span>child<span>)</span><span>;</span>\n  <span>commitWork</span><span>(</span>fiber<span>.</span>sibling<span>)</span><span>;</span>\n<span>}</span>\n\n<span>function</span> <span>render</span><span>(</span><span>element<span>,</span> container</span><span>)</span> <span>{</span>\n  <span>// render 时记录 wipRoot</span>\n  wipRoot <span>=</span> <span>{</span>\n    dom<span>:</span> container<span>,</span>\n    props<span>:</span> <span>{</span>\n      children<span>:</span> <span>[</span>element<span>]</span><span>,</span>\n    <span>}</span><span>,</span>\n  <span>}</span><span>;</span>\n  nextUnitOfWork <span>=</span> wipRoot<span>;</span>\n<span>}</span>\n​\n<span>let</span> nextUnitOfWork <span>=</span> <span>null</span><span>;</span>\n<span>// 新增变量，跟踪渲染进行中的根 fiber</span>\n<span>let</span> wipRoot <span>=</span> <span>null</span><span>;</span>\n\n<span>function</span> <span>workLoop</span><span>(</span><span>deadline</span><span>)</span> <span>{</span>\n  <span>let</span> shouldYield <span>=</span> <span>false</span><span>;</span>\n  <span>while</span> <span>(</span>nextUnitOfWork <span>&amp;&amp;</span> <span>!</span>shouldYield<span>)</span> <span>{</span>\n    nextUnitOfWork <span>=</span> <span>performUnitOfWork</span><span>(</span>\n      nextUnitOfWork\n    <span>)</span><span>;</span>\n    shouldYield <span>=</span> deadline<span>.</span><span>timeRemaining</span><span>(</span><span>)</span> <span>&lt;</span> <span>1</span><span>;</span>\n  <span>}</span>\n\n  <span>// 当 nextUnitOfWork 为空则表示渲染 fiber 树完成了，</span>\n  <span>// 可以提交到 DOM 了</span>\n  <span>if</span> <span>(</span><span>!</span>nextUnitOfWork <span>&amp;&amp;</span> wipRoot<span>)</span> <span>{</span>\n    <span>commitRoot</span><span>(</span><span>)</span><span>;</span>\n  <span>}</span>\n  <span>requestIdleCallback</span><span>(</span>workLoop<span>)</span><span>;</span>\n<span>}</span>\n\n​<span>// 一旦浏览器空闲，就触发执行单元任务</span>\n<span>requestIdleCallback</span><span>(</span>workLoop<span>)</span><span>;</span>\n\n<span>function</span> <span>performUnitOfWork</span><span>(</span><span>fiber</span><span>)</span> <span>{</span>\n  <span>if</span> <span>(</span><span>!</span>fiber<span>.</span>dom<span>)</span> <span>{</span>\n    fiber<span>.</span>dom <span>=</span> <span>createDom</span><span>(</span>fiber<span>)</span><span>;</span>\n  <span>}</span>\n\n  <span>const</span> elements <span>=</span> fiber<span>.</span>props<span>.</span>children<span>;</span>\n  <span>let</span> index <span>=</span> <span>0</span><span>;</span>\n  <span>let</span> prevSibling <span>=</span> <span>null</span><span>;</span>\n​\n  <span>while</span> <span>(</span>index <span>&lt;</span> elements<span>.</span>length<span>)</span> <span>{</span>\n    <span>const</span> element <span>=</span> elements<span>[</span>index<span>]</span><span>;</span>\n​\n    <span>const</span> newFiber <span>=</span> <span>{</span>\n      type<span>:</span> element<span>.</span>type<span>,</span>\n      props<span>:</span> element<span>.</span>props<span>,</span>\n      parent<span>:</span> fiber<span>,</span>\n      dom<span>:</span> <span>null</span><span>,</span>\n    <span>}</span><span>;</span>\n\n    <span>if</span> <span>(</span>index <span>===</span> <span>0</span><span>)</span> <span>{</span>\n      fiber<span>.</span>child <span>=</span> newFiber<span>;</span>\n    <span>}</span> <span>else</span> <span>{</span>\n      prevSibling<span>.</span>sibling <span>=</span> newFiber<span>;</span>\n    <span>}</span>\n​\n    prevSibling <span>=</span> newFiber<span>;</span>\n    index<span>++</span><span>;</span>\n  <span>}</span>\n\n  <span>if</span> <span>(</span>fiber<span>.</span>child<span>)</span> <span>{</span>\n    <span>return</span> fiber<span>.</span>child<span>;</span>\n  <span>}</span>\n\n  <span>let</span> nextFiber <span>=</span> fiber<span>;</span>\n  <span>while</span> <span>(</span>nextFiber<span>)</span> <span>{</span>\n    <span>if</span> <span>(</span>nextFiber<span>.</span>sibling<span>)</span> <span>{</span>\n      <span>return</span> nextFiber<span>.</span>sibling<span>;</span>\n    <span>}</span>\n    nextFiber <span>=</span> nextFiber<span>.</span>parent<span>;</span>\n  <span>}</span>\n<span>}</span>\n</code></pre><div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br><span>82</span><br><span>83</span><br><span>84</span><br><span>85</span><br><span>86</span><br><span>87</span><br><span>88</span><br><span>89</span><br><span>90</span><br><span>91</span><br><span>92</span><br><span>93</span><br><span>94</span><br><span>95</span><br><span>96</span><br><span>97</span><br><span>98</span><br><span>99</span><br><span>100</span><br><span>101</span><br><span>102</span><br><span>103</span><br><span>104</span><br><span>105</span><br><span>106</span><br><span>107</span><br><span>108</span><br><span>109</span><br><span>110</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "useState",
      "url": "https://x-vic.gitee.io/code/code/views/owner-react/useState/",
      "id": "https://x-vic.gitee.io/code/code/views/owner-react/useState/",
      "content_html": "<blockquote>\n<p>注意以下代码省略了未变化部分</p>\n</blockquote>\n<div><pre><code><span>// 新增变量，渲染进行中的 fiber 节点</span>\n<span>let</span> wipFiber <span>=</span> <span>null</span><span>;</span>\n<span>// 新增变量，当前 hook 的索引，以支持同一个函数组件多次调用 useState</span>\n<span>let</span> hookIndex <span>=</span> <span>null</span><span>;</span>\n\n<span>function</span> <span>updateFunctionComponent</span><span>(</span><span>fiber</span><span>)</span> <span>{</span>\n  <span>// 更新进行中的 fiber 节点</span>\n  wipFiber <span>=</span> fiber<span>;</span>\n  <span>// 重置 hook 索引</span>\n  hookIndex <span>=</span> <span>0</span><span>;</span>\n  <span>// 新增 hooks 数组以支持同一个组件多次调用 useState</span>\n  wipFiber<span>.</span>hooks <span>=</span> <span>[</span><span>]</span><span>;</span>\n  <span>const</span> children <span>=</span> <span>[</span>fiber<span>.</span><span>type</span><span>(</span>fiber<span>.</span>props<span>)</span><span>]</span><span>;</span>\n  <span>reconcileChildren</span><span>(</span>fiber<span>,</span> children<span>)</span><span>;</span>\n<span>}</span>\n\n<span>function</span> <span>useState</span><span>(</span><span>initial</span><span>)</span> <span>{</span>\n  <span>// alternate 保存了上一次渲染的 fiber 节点</span>\n  <span>const</span> oldHook <span>=</span>\n    wipFiber<span>.</span>alternate <span>&amp;&amp;</span>\n    wipFiber<span>.</span>alternate<span>.</span>hooks <span>&amp;&amp;</span>\n    wipFiber<span>.</span>alternate<span>.</span>hooks<span>[</span>hookIndex<span>]</span><span>;</span>\n  <span>const</span> hook <span>=</span> <span>{</span>\n    <span>// 第一次渲染使用入参，第二次渲染复用前一次的状态</span>\n    state<span>:</span> oldHook <span>?</span> oldHook<span>.</span>state <span>:</span> initial<span>,</span>\n    <span>// 保存每次 setState 入参的队列</span>\n    queue<span>:</span> <span>[</span><span>]</span>\n  <span>}</span><span>;</span>\n\n  <span>const</span> actions <span>=</span> oldHook <span>?</span> oldHook<span>.</span>queue <span>:</span> <span>[</span><span>]</span><span>;</span>\n  actions<span>.</span><span>forEach</span><span>(</span><span>action</span> <span>=></span> <span>{</span>\n    <span>// 根据调用 setState 顺序从前往后生成最新的 state</span>\n    hook<span>.</span>state <span>=</span> action <span>instanceof</span> <span>Function</span> <span>?</span> <span>action</span><span>(</span>hook<span>.</span>state<span>)</span> <span>:</span> action<span>;</span>\n  <span>}</span><span>)</span><span>;</span>\n\n  <span>// setState 函数用于更新 state，入参 action</span>\n  <span>// 是新的 state 值或函数返回新的 state</span>\n  <span>const</span> <span>setState</span> <span>=</span> <span>action</span> <span>=></span> <span>{</span>\n    hook<span>.</span>queue<span>.</span><span>push</span><span>(</span>action<span>)</span><span>;</span>\n    <span>// 下面这部分代码和 render 函数很像，</span>\n    <span>// 设置新的 wipRoot 和 nextUnitOfWork</span>\n    <span>// 浏览器空闲时即开始重新渲染。</span>\n    wipRoot <span>=</span> <span>{</span>\n      dom<span>:</span> currentRoot<span>.</span>dom<span>,</span>\n      props<span>:</span> currentRoot<span>.</span>props<span>,</span>\n      alternate<span>:</span> currentRoot\n    <span>}</span><span>;</span>\n    nextUnitOfWork <span>=</span> wipRoot<span>;</span>\n    deletions <span>=</span> <span>[</span><span>]</span><span>;</span>\n  <span>}</span><span>;</span>\n\n  <span>// 保存本次 hook</span>\n  wipFiber<span>.</span>hooks<span>.</span><span>push</span><span>(</span>hook<span>)</span><span>;</span>\n  hookIndex<span>++</span><span>;</span>\n  <span>return</span> <span>[</span>hook<span>.</span>state<span>,</span> setState<span>]</span><span>;</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "redux",
      "url": "https://x-vic.gitee.io/code/code/views/owner-redux/",
      "id": "https://x-vic.gitee.io/code/code/views/owner-redux/",
      "content_html": "<h2 id=\"createstore\"> createStore</h2>\n<p>创建 store 核心对象</p>\n<div><pre><code><span>const</span> <span>createStore</span> <span>=</span> <span>(</span><span>reducer<span>,</span> initState<span>,</span> enhancer</span><span>)</span> <span>=></span> <span>{</span>\n  <span>if</span> <span>(</span><span>!</span>enhancer <span>&amp;&amp;</span> <span>typeof</span> initState <span>===</span> <span>\"function\"</span><span>)</span> <span>{</span>\n    enhancer <span>=</span> initState\n    initState <span>=</span> <span>null</span>\n  <span>}</span>\n  <span>if</span> <span>(</span>enhancer <span>&amp;&amp;</span> <span>typeof</span> enhancer <span>===</span> <span>\"function\"</span><span>)</span> <span>{</span>\n    <span>return</span> <span>enhancer</span><span>(</span>createStore<span>)</span><span>(</span>reducer<span>,</span> initState<span>)</span>\n  <span>}</span>\n  <span>let</span> store <span>=</span> initState<span>,</span> \n    listeners <span>=</span> <span>[</span><span>]</span><span>,</span>\n    isDispatch <span>=</span> <span>false</span><span>;</span>\n  <span>const</span> <span>getState</span> <span>=</span> <span>(</span><span>)</span> <span>=></span> store\n  <span>// 原始 dispatch 内部执行 reducer 通知监听者</span>\n  <span>const</span> <span>dispatch</span> <span>=</span> <span>(</span><span>action</span><span>)</span> <span>=></span> <span>{</span>\n    <span>if</span> <span>(</span>isDispatch<span>)</span> <span>return</span> action\n    <span>// dispatch 必须一个个来，加锁</span>\n    isDispatch <span>=</span> <span>true</span>\n    store <span>=</span> <span>reducer</span><span>(</span>store<span>,</span> action<span>)</span>\n    isDispatch <span>=</span> <span>false</span>\n    listeners<span>.</span><span>forEach</span><span>(</span><span>listener</span> <span>=></span> <span>listener</span><span>(</span><span>getState</span><span>(</span><span>)</span><span>)</span><span>)</span>\n    <span>return</span> action\n  <span>}</span>\n  <span>const</span> <span>subscribe</span> <span>=</span> <span>(</span><span>listener</span><span>)</span> <span>=></span> <span>{</span>\n    <span>if</span> <span>(</span><span>typeof</span> listener <span>===</span> <span>\"function\"</span><span>)</span> <span>{</span>\n      listeners<span>.</span><span>push</span><span>(</span>listener<span>)</span>\n    <span>}</span>\n    <span>// 在监听的同时返回卸载监听的函数，利用闭包缓存监听者，以免想卸载监听的时候却找不到对应的想卸载的监听者</span>\n    <span>return</span> <span>(</span><span>)</span> <span>=></span> <span>unsubscribe</span><span>(</span>listener<span>)</span>\n  <span>}</span>\n  <span>const</span> <span>unsubscribe</span> <span>=</span> <span>(</span><span>listener</span><span>)</span> <span>=></span> <span>{</span>\n    <span>const</span> index <span>=</span> listeners<span>.</span><span>indexOf</span><span>(</span>listener<span>)</span>\n    listeners<span>.</span><span>splice</span><span>(</span>index<span>,</span> <span>1</span><span>)</span>\n  <span>}</span>\n  <span>return</span> <span>{</span>\n    getState<span>,</span>\n    dispatch<span>,</span>\n    subscribe<span>,</span>\n    unsubscribe\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br></div></div><h2 id=\"applymiddleware\"> applyMiddleware</h2>\n<p>添加中间件</p>\n<div><pre><code><span>const</span> <span>applyMiddleware</span> <span>=</span> <span>(</span><span><span>...</span>middlewares</span><span>)</span> <span>=></span> <span>{</span>\n  <span>return</span> <span>(</span><span>createStore</span><span>)</span> <span>=></span> <span>(</span><span>reducer<span>,</span> initState<span>,</span> enhancer</span><span>)</span> <span>=></span> <span>{</span>\n    <span>const</span> store <span>=</span> <span>createStore</span><span>(</span>reducer<span>,</span> initState<span>,</span> enhancer<span>)</span><span>;</span>\n    <span>const</span> middlewareAPI <span>=</span> <span>{</span>\n      getState<span>:</span> store<span>.</span>getState<span>,</span>\n      <span>dispatch</span><span>:</span> <span>(</span><span>action</span><span>)</span> <span>=></span> <span>dispatch</span><span>(</span>action<span>)</span>\n    <span>}</span>\n    <span>// 剥掉中间件的第一层外衣</span>\n    <span>let</span> chain <span>=</span> middlewares<span>.</span><span>map</span><span>(</span><span>middleware</span> <span>=></span> <span>middleware</span><span>(</span>middlewareAPI<span>)</span><span>)</span>\n    <span>// 剥掉中间件的第二层外衣</span>\n    store<span>.</span>dispatch <span>=</span> <span>compose</span><span>(</span><span>...</span>chain<span>)</span><span>(</span>store<span>.</span>dispatch<span>)</span>\n    <span>return</span> <span>{</span>\n      <span>...</span>store\n    <span>}</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><h3 id=\"compose\"> compose</h3>\n<div><pre><code><span>// 将一系列函数串起来，返回一个函数，增强原始 dispatch 的功能</span>\n<span>// 中间件是由三阶函数构成，这里参数的函数是剥了最外层的中间件</span>\n<span>const</span> <span>compose</span> <span>=</span> <span>(</span><span><span>...</span>funcs</span><span>)</span> <span>=></span> <span>{</span>\n  <span>// 没有传入函数则原样返回</span>\n  <span>if</span> <span>(</span><span>!</span>funcs<span>)</span> <span>{</span>\n    <span>return</span> <span>args</span> <span>=></span> args\n  <span>}</span>\n  <span>if</span> <span>(</span>funcs<span>.</span>length <span>===</span> <span>1</span><span>)</span> <span>{</span>\n    <span>return</span> funcs<span>[</span><span>0</span><span>]</span>\n  <span>}</span>\n  <span>return</span> funcs<span>.</span><span>reduce</span><span>(</span><span>(</span><span>f1<span>,</span> f2</span><span>)</span> <span>=></span> <span>(</span><span><span>...</span>args</span><span>)</span> <span>=></span> <span>f1</span><span>(</span><span>f2</span><span>(</span><span>...</span>args<span>)</span><span>)</span><span>)</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br></div></div><h2 id=\"combinereducers\"> combineReducers</h2>\n<div><pre><code><span>// 拿到 reducer 的键，修改 state 对应键的值</span>\n<span>const</span> <span>combineReducers</span> <span>=</span> <span>reducers</span> <span>=></span> <span>{</span>\n  <span>const</span> finalReducers <span>=</span> <span>{</span><span>}</span><span>,</span>\n    nativeKeys <span>=</span> Object<span>.</span>keys\n  <span>nativeKeys</span><span>(</span>reducers<span>)</span><span>.</span><span>forEach</span><span>(</span><span>reducerKey</span> <span>=></span> <span>{</span>\n    <span>if</span><span>(</span><span>typeof</span> reducers<span>[</span>reducerKey<span>]</span> <span>===</span> <span>\"function\"</span><span>)</span> <span>{</span>\n      finalReducers<span>[</span>reducerKey<span>]</span> <span>=</span> reducers<span>[</span>reducerKey<span>]</span>\n    <span>}</span>\n  <span>}</span><span>)</span>\n  <span>return</span> <span>(</span><span>state<span>,</span> action</span><span>)</span> <span>=></span> <span>{</span>\n    <span>const</span> store <span>=</span> <span>{</span><span>}</span>\n    <span>nativeKeys</span><span>(</span>finalReducers<span>)</span><span>.</span><span>forEach</span><span>(</span><span>key</span> <span>=></span> <span>{</span>\n      <span>const</span> reducer <span>=</span> finalReducers<span>[</span>key<span>]</span>\n      <span>const</span> nextState <span>=</span> <span>reducer</span><span>(</span>state<span>[</span>key<span>]</span><span>,</span> action<span>)</span>\n      store<span>[</span>key<span>]</span> <span>=</span> nextState\n    <span>}</span><span>)</span>\n    <span>return</span> store\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div><h2 id=\"bindactioncreator\"> bindActionCreator</h2>\n<div><pre><code><span>const</span> <span>bindActionCreator</span> <span>=</span> <span>(</span><span>action<span>,</span> dispatch</span><span>)</span> <span>=></span> <span>{</span>\n  <span>return</span> <span>(</span><span><span>...</span>args</span><span>)</span> <span>=></span> <span>dispatch</span><span>(</span><span>action</span><span>(</span><span>...</span>args<span>)</span><span>)</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "react-redux",
      "url": "https://x-vic.gitee.io/code/code/views/owner-redux/react-redux/",
      "id": "https://x-vic.gitee.io/code/code/views/owner-redux/react-redux/",
      "content_html": "<h2 id=\"用法\"> 用法</h2>\n<p>看看 react-redux 有两个重要的 API 的用法：</p>\n<div><pre><code><span>// Provider</span>\nReactDOM<span>.</span><span>render</span><span>(</span><span>{</span>\n  <span><span><span>&lt;</span><span>Provider</span></span> <span>store</span><span><span>=</span><span>{</span>store<span>}</span></span><span>></span></span><span><span><span>&lt;/</span><span>Provider</span></span><span>></span></span><span>,</span>\n  document<span>.</span><span>getElementById</span><span>(</span><span>'app'</span><span>)</span>\n<span>}</span><span>)</span>\n\n<span>// connect</span>\n@<span>connect</span><span>(</span>mapStateToProps<span>,</span> mapDispatchToProps<span>)</span>\n<span>class</span> <span>App</span> <span>extends</span> <span>Component</span> <span>{</span><span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br></div></div><h2 id=\"provider\"> Provider</h2>\n<p>传递 store 和 订阅方法给所有组件</p>\n<div><pre><code><span>class</span> <span>Subscription</span> <span>{</span>\n  <span>constructor</span><span>(</span><span>store</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span>store <span>=</span> store\n    <span>this</span><span>.</span>listeners <span>=</span> <span>[</span><span>this</span><span>.</span>handleChangeWrapper<span>]</span>\n  <span>}</span>\n  <span>notify</span> <span>=</span> <span>(</span><span>)</span> <span>=></span> <span>{</span>\n    <span>this</span><span>.</span>listeners<span>.</span><span>forEach</span><span>(</span><span>listener</span> <span>=></span> <span>{</span>\n      <span>listener</span><span>(</span><span>)</span>\n    <span>}</span><span>)</span>\n  <span>}</span>\n  <span>addListener</span><span>(</span><span>listener</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span>listeners<span>.</span><span>push</span><span>(</span>listener<span>)</span>\n  <span>}</span>\n  <span>// 监听 store</span>\n  <span>trySubscribe</span><span>(</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span>unsubscribe <span>=</span> <span>this</span><span>.</span>store<span>.</span><span>subscribe</span><span>(</span><span>this</span><span>.</span>notify<span>)</span>\n  <span>}</span>\n  <span>// onStateChange 需要在组件中设置</span>\n  <span>handleChangeWrapper</span> <span>=</span> <span>(</span><span>)</span> <span>=></span> <span>{</span>\n    <span>if</span> <span>(</span><span>this</span><span>.</span>onStateChange<span>)</span> <span>{</span>\n      <span>this</span><span>.</span><span>onStateChange</span><span>(</span><span>)</span>\n    <span>}</span>\n  <span>}</span>\n  <span>unsubscribe</span><span>(</span><span>)</span> <span>{</span>\n    <span>this</span><span>.</span>listeners <span>=</span> <span>null</span>\n    <span>this</span><span>.</span><span>unsubscribe</span><span>(</span><span>)</span>\n  <span>}</span>\n<span>}</span>\n\n<span>const</span> <span>Provider</span> <span>=</span> <span>(</span><span><span>{</span> store<span>,</span> children <span>}</span></span><span>)</span> <span>=></span> <span>{</span>\n  <span>const</span> contextValue <span>=</span> <span>useMemo</span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>{</span>\n    <span>const</span> subscription <span>=</span> <span>new</span> <span>Subscription</span><span>(</span>store<span>)</span>\n    <span>return</span> <span>{</span>\n      store<span>,</span>\n      subscription\n    <span>}</span>\n  <span>}</span><span>,</span> <span>[</span>store<span>]</span><span>)</span>\n  <span>// 监听 store 变化</span>\n  <span>useEffect</span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>{</span>\n    <span>const</span> <span>{</span> subscription <span>}</span> <span>=</span> contextValue\n    subscription<span>.</span><span>trySubscribe</span><span>(</span><span>)</span>\n    <span>return</span> <span>(</span><span>)</span> <span>=></span> <span>{</span>\n      subscription<span>.</span><span>unsubscribe</span><span>(</span><span>)</span>\n    <span>}</span>\n  <span>}</span><span>,</span> <span>[</span>contextValue<span>]</span><span>)</span>\n  <span>return</span> <span>(</span>\n    <span>&lt;</span>ReactReduxContext<span>.</span>Provider value<span>=</span><span>{</span>contextValue<span>}</span><span>></span>\n      <span>{</span>children<span>}</span>\n    <span>&lt;</span><span>/</span>ReactReduxContext<span>.</span>Provider<span>></span>\n  <span>)</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br></div></div><h2 id=\"connect\"> connect</h2>\n<p>从 sore 中的到 state 和 actionCreator，监听 state 变化，触发重渲染</p>\n<div><pre><code><span>const</span> <span>connect</span> <span>=</span> <span>(</span><span>mapStateToProps<span>,</span> mapDispatchToProps</span><span>)</span> <span>=></span> <span>{</span>\n  <span>return</span> <span>(</span><span>WrappedComponent</span><span>)</span> <span>=></span> <span>{</span>\n    <span>return</span> <span>(</span><span>props</span><span>)</span> <span>=></span> <span>{</span>\n      <span>// 获取 store 和 订阅方法</span>\n      <span>const</span> <span>{</span> store<span>,</span> subscription <span>}</span> <span>=</span> <span>useContext</span><span>(</span>ReactReduxContext<span>)</span>\n      <span>const</span> <span>[</span>count<span>,</span> setCount<span>]</span> <span>=</span> <span>useState</span><span>(</span><span>0</span><span>)</span>\n      <span>useEffect</span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>{</span>\n        <span>// redux 中的 state 变化 ==> 触发监听者：onStateChange ==> setCount 引发组件重渲染</span>\n        subscription<span>.</span><span>onStateChange</span> <span>=</span> <span>(</span><span>)</span> <span>=></span> <span>setCount</span><span>(</span>count <span>+</span> <span>1</span><span>)</span>\n      <span>}</span><span>,</span> <span>[</span>count<span>]</span><span>)</span>\n      <span>const</span> newProps <span>=</span> <span>useMemo</span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>{</span>\n        <span>const</span> stateProps <span>=</span> <span>mapStateToProps</span><span>(</span>store<span>.</span><span>getState</span><span>(</span><span>)</span><span>)</span>\n        <span>const</span> dispatchProps <span>=</span> <span>mapDispatchToProps</span><span>(</span>store<span>.</span>dispatch<span>)</span>\n        <span>return</span> <span>{</span>\n          <span>...</span>stateProps<span>,</span>\n          <span>...</span>dispatchProps<span>,</span>\n          <span>...</span>props\n        <span>}</span>\n      <span>}</span><span>,</span> <span>[</span>props<span>,</span> store<span>,</span> count<span>]</span><span>)</span>\n      <span>return</span> <span><span><span>&lt;</span><span>WrappedComponent</span></span> <span><span>{</span><span>...</span><span>newProps</span><span>}</span></span> <span>/></span></span>\n    <span>}</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "createApp && mount",
      "url": "https://x-vic.gitee.io/code/code/views/owner-vue-next/createApp&mount/",
      "id": "https://x-vic.gitee.io/code/code/views/owner-vue-next/createApp&mount/",
      "content_html": "<p><img src=\"/code/images/mount.svg\" alt=\"mount\"></p>\n<h2 id=\"本文目标\"> 本文目标</h2>\n<p>简单实现 vue3 中的 <code>createApp</code> 和 <code>mount</code> 两个 API。虽然只有两个 API，但是这两个 API 实现了 vue3 根实例的创建、组件的解析、vnode 数的构建...<br>\n通过这两个 API 的实现，就能够了解到整个 vue3 项目的整体挂载流程，可以说是 vue3 的核心 API。<br>\n<a href=\"https://github.com/yesixuan/test-vue-next\" target=\"_blank\" rel=\"noopener noreferrer\">本文代码 GitHub 仓库地址</a></p>\n<div><pre><code><span>// 定义根组件</span>\n<span>import</span> <span>{</span> h <span>}</span> <span>from</span> <span>'vue'</span> <span>// 文中只有 h 方法使用 vue 官方提供</span>\n<span>import</span> <span>{</span> reactive <span>}</span> <span>from</span> <span>'./vic/reactive'</span> <span>// 自己实现的 reactive</span>\n<span>import</span> <span>{</span> createApp <span>}</span> <span>from</span> <span>'./vic'</span> <span>// 自己实现的 createApp</span>\n\n<span>const</span> App <span>=</span> <span>{</span>\n  components<span>:</span> <span>{</span> SubCom <span>}</span><span>,</span>\n  <span>setup</span><span>(</span><span>)</span> <span>{</span>\n    <span>const</span> count <span>=</span> <span>reactive</span><span>(</span><span>{</span>\n      value<span>:</span> <span>0</span>\n    <span>}</span><span>)</span>\n    <span>const</span> <span>inc</span> <span>=</span> <span>(</span><span>)</span> <span>=></span> <span>{</span>\n      count<span>.</span>value<span>++</span>\n    <span>}</span>\n    <span>return</span> <span>(</span><span>)</span> <span>=></span> <span>h</span><span>(</span><span>'div'</span><span>,</span> <span>[</span><span>h</span><span>(</span><span>'h1'</span><span>,</span> count<span>.</span>value<span>)</span><span>,</span> <span>h</span><span>(</span><span>'button'</span><span>,</span> <span>{</span> onClick<span>:</span> inc <span>}</span><span>,</span> <span>'++'</span><span>)</span><span>,</span> <span>h</span><span>(</span>SubCom<span>)</span><span>]</span><span>)</span>\n  <span>}</span>\n<span>}</span>\n\n<span>// 定义子组件</span>\n<span>const</span> SubCom <span>=</span> <span>{</span>\n  <span>setup</span><span>(</span><span>)</span> <span>{</span>\n    <span>return</span> <span>(</span><span>)</span> <span>=></span> <span>h</span><span>(</span><span>'div'</span><span>,</span> <span>[</span><span>h</span><span>(</span><span>'h2'</span><span>,</span> <span>'我是子组件'</span><span>)</span><span>]</span><span>)</span>\n  <span>}</span>\n<span>}</span>\n\n<span>// 挂载</span>\n<span>createApp</span><span>(</span>App<span>)</span><span>.</span><span>mount</span><span>(</span>document<span>.</span><span>getElementById</span><span>(</span><span>'app'</span><span>)</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br></div></div><h2 id=\"代码实现\"> 代码实现</h2>\n<div><pre><code><span>import</span> <span>{</span> effect <span>}</span> <span>from</span> <span>'./reactive'</span>\n\n<span>let</span> uid <span>=</span> <span>0</span>\n\n<span>/**\n * 1. 创建 context，用来承载一些全局的配置、全局注册的指令、组件...\n * 2. 创建 app 实例（vue 项目唯一的实例，目前主要关注它提供的 mount 方法）\n */</span>\n<span>export</span> <span>const</span> <span>createApp</span> <span>=</span> <span>(</span><span>rootComponent<span>,</span> rootProps <span>=</span> <span>null</span></span><span>)</span> <span>=></span> <span>{</span>\n  <span>const</span> context <span>=</span> <span>{</span>\n    config<span>:</span> <span>{</span>\n      devtools<span>:</span> <span>true</span><span>,</span>\n      performance<span>:</span> <span>false</span><span>,</span>\n      globalProperties<span>:</span> <span>{</span><span>}</span><span>,</span>\n      optionMergeStrategies<span>:</span> <span>{</span><span>}</span><span>,</span>\n      errorHandler<span>:</span> <span>undefined</span><span>,</span>\n      warnHandler<span>:</span> <span>undefined</span>\n    <span>}</span><span>,</span>\n    mixins<span>:</span> <span>[</span><span>]</span><span>,</span>\n    components<span>:</span> <span>{</span><span>}</span><span>,</span>\n    directives<span>:</span> <span>{</span><span>}</span><span>,</span>\n    provides<span>:</span> Object<span>.</span><span>create</span><span>(</span><span>null</span><span>)</span>\n  <span>}</span>\n  <span>const</span> app <span>=</span> <span>{</span>\n    <span>/**\n     * 1. 创建根组件的 vnode\n     * 2. 调用 render 方法，将 vnode 渲染到真实 dom 上\n     */</span>\n    <span>mount</span><span>:</span> <span>(</span><span>rootContainer</span><span>)</span> <span>=></span> <span>{</span>\n      <span>const</span> vnode <span>=</span> <span>createVNode</span><span>(</span>rootComponent<span>,</span> rootProps<span>)</span>\n      vnode<span>.</span>appContext <span>=</span> context\n      <span>render</span><span>(</span>vnode<span>,</span> rootContainer<span>)</span>\n    <span>}</span><span>,</span>\n    components<span>:</span> <span>{</span><span>}</span>\n  <span>}</span>\n  <span>return</span> app\n<span>}</span>\n\n<span>/**\n * 极简版的创建 vnode\n * @param type 当 type 为对象时，表示这是个组件，当 type 为字符串时，表示这是个原生 dom 标签 \n */</span>\n<span>function</span> <span>createVNode</span><span>(</span><span>type<span>,</span> props</span><span>)</span> <span>{</span>\n  <span>const</span> vnode <span>=</span> <span>{</span>\n    __v_isVNode<span>:</span> <span>true</span><span>,</span>\n    type<span>,</span>\n    props<span>,</span>\n    key<span>:</span> props<span>,</span>\n    scopeId<span>:</span> <span>1</span><span>,</span>\n    children<span>:</span> <span>null</span><span>,</span>\n    component<span>:</span> <span>null</span><span>,</span>\n    el<span>:</span> <span>null</span><span>,</span>\n    shapeFlag<span>:</span> <span>4</span><span>,</span> <span>// 表示组件，因为这里只在创建根组件的 vnode 的时候用到，所以这里先写死</span>\n    patchFlag<span>:</span> <span>0</span><span>,</span>\n    appContext<span>:</span> <span>null</span>\n  <span>}</span>\n  <span>return</span> vnode\n<span>}</span>\n\n<span>// render 什么也没做，光是调用了 patch 方法</span>\n<span>// patch 的第一个参数传入 null 表示这是首次渲染，没有上一次的 vnode 进行 diff</span>\n<span>function</span> <span>render</span><span>(</span><span>vnode<span>,</span> container</span><span>)</span> <span>{</span>\n  <span>patch</span><span>(</span><span>null</span><span>,</span> vnode<span>,</span> container<span>)</span>\n<span>}</span>\n\n<span>// 整个 vue 应用递归挂载的起点</span>\n<span>// 根据 shapeFlag 的不同，选择挂载组件还是挂载 dom 元素</span>\n<span>function</span> <span>patch</span><span>(</span><span>n1<span>,</span> n2<span>,</span> container<span>,</span></span><span>)</span> <span>{</span>\n  <span>const</span> <span>{</span> shapeFlag <span>}</span> <span>=</span> n2\n  <span>if</span> <span>(</span><span>typeof</span> n2<span>.</span>type <span>===</span> <span>\"symbol\"</span><span>)</span> <span>{</span>\n    <span>processText</span><span>(</span>n1<span>,</span> n2<span>,</span> container<span>)</span>\n    <span>return</span>\n  <span>}</span>\n  <span>if</span> <span>(</span>shapeFlag <span>===</span> <span>17</span> <span>||</span> shapeFlag <span>===</span> <span>9</span><span>)</span> <span>{</span>\n    <span>processElement</span><span>(</span>\n      n1<span>,</span>\n      n2<span>,</span>\n      container\n    <span>)</span>\n  <span>}</span> <span>else</span> <span>if</span> <span>(</span>shapeFlag <span>===</span> <span>4</span><span>)</span> <span>{</span>\n    <span>// 首次 mount 走的就是这个分支</span>\n    <span>processComponent</span><span>(</span>\n      n1<span>,</span>\n      n2<span>,</span>\n      container\n    <span>)</span>\n  <span>}</span>\n<span>}</span>\n\n<span>// 啥也没干，调了 mountComponent 方法</span>\n<span>function</span> <span>processComponent</span><span>(</span><span>n1<span>,</span> n2<span>,</span> container</span><span>)</span> <span>{</span>\n  <span>mountComponent</span><span>(</span>n2<span>,</span> container<span>)</span>\n<span>}</span>\n\n<span>/**\n * 1. 根据 vnode 创建了它的实例\n * 2. 对实例进行各种处理，包裹 props、data、调用组件的 setup 方法、生成组件的 render 方法\n * 3. 调用实例的 render 方法，得到组件下的第一额真实 dom 的 vnode，递归调用 patch（此时 patch 传入的就是真实 dom 的 vnode 了）\n */</span>\n<span>function</span> <span>mountComponent</span><span>(</span><span>initialVNode<span>,</span> container</span><span>)</span> <span>{</span>\n  <span>const</span> instance <span>=</span> <span>(</span>initialVNode<span>.</span>component <span>=</span> <span>createComponentInstance</span><span>(</span> initialVNode<span>,</span> <span>null</span><span>,</span> <span>null</span> <span>)</span><span>)</span>\n  <span>setupComponent</span><span>(</span>instance<span>)</span>\n  <span>setupRenderEffect</span><span>(</span>instance<span>,</span> initialVNode<span>,</span> container<span>)</span>\n<span>}</span>\n\n<span>// 根据组件 vnode 创建相应的实例</span>\n<span>// 这里需要关注两个属性：appContext、components，这两个属性都继承了根实例的相应属性</span>\n<span>// 这样做有利于在每个组件中拿到项目共享的一些属性和方法，在任何组件都能够拿到全局注册过的组件</span>\n<span>function</span> <span>createComponentInstance</span><span>(</span><span>vnode<span>,</span> parent<span>,</span> suspense</span><span>)</span> <span>{</span>\n  <span>// inherit parent app context - or - if root, adopt from root vnode</span>\n  <span>const</span> appContext <span>=</span>\n    <span>(</span>parent <span>?</span> parent<span>.</span>appContext <span>:</span> vnode<span>.</span>appContext<span>)</span> <span>||</span> <span>{</span><span>}</span>\n  <span>const</span> instance <span>=</span> <span>{</span>\n    uid<span>:</span> uid<span>++</span><span>,</span>\n    vnode<span>,</span>\n    parent<span>,</span>\n    appContext<span>,</span>\n    type<span>:</span> vnode<span>.</span>type<span>,</span>\n    root<span>:</span> <span>null</span><span>,</span> <span>// to be immediately set</span>\n    next<span>:</span> <span>null</span><span>,</span>\n    subTree<span>:</span> <span>null</span><span>,</span> <span>// will be set synchronously right after creation</span>\n    update<span>:</span> <span>null</span><span>,</span> <span>// will be set synchronously right after creation</span>\n    render<span>:</span> <span>null</span><span>,</span>\n\n    <span>// state</span>\n    ctx<span>:</span> <span>{</span><span>}</span><span>,</span>\n    data<span>:</span> <span>{</span><span>}</span><span>,</span>\n    props<span>:</span> <span>{</span><span>}</span><span>,</span>\n    attrs<span>:</span> <span>{</span><span>}</span><span>,</span>\n    slots<span>:</span> <span>{</span><span>}</span><span>,</span>\n    refs<span>:</span> <span>{</span><span>}</span><span>,</span>\n    setupState<span>:</span> <span>{</span><span>}</span><span>,</span>\n    setupContext<span>:</span> <span>null</span><span>,</span>\n\n    <span>// per-instance asset storage (mutable during options resolution)</span>\n    components<span>:</span> Object<span>.</span><span>create</span><span>(</span>appContext<span>.</span>components <span>||</span> <span>[</span><span>]</span><span>)</span>\n  <span>}</span>\n  instance<span>.</span>ctx <span>=</span> <span>{</span> _<span>:</span> instance <span>}</span>\n  instance<span>.</span>root <span>=</span> parent <span>?</span> parent<span>.</span>root <span>:</span> instance\n  <span>return</span> instance\n<span>}</span>\n\n<span>// 这里主要是调用组件的 setup 方法得到了实例的 render 方法（其实还有更多工作，如处理 data、props...此处暂且不论）</span>\n<span>function</span> <span>setupComponent</span><span>(</span><span>instance</span><span>)</span> <span>{</span>\n  <span>const</span> Component <span>=</span> instance<span>.</span>type\n  <span>const</span> <span>{</span> setup <span>}</span> <span>=</span> Component\n  <span>const</span> setupResult <span>=</span> <span>setup</span><span>(</span>instance<span>.</span>props<span>,</span> <span>{</span><span>}</span><span>)</span>\n  instance<span>.</span>render <span>=</span> setupResult\n<span>}</span>\n\n<span>/**\n * 1. 使用 effect 包裹响应式操作\n * 2. 响应式操作里面主要做两件事\n *  2.1 调用实例的 render 方法得到 subTree\n *  2.2 递归调用 patch(subTree, container)\n */</span>\n<span>function</span> <span>setupRenderEffect</span><span>(</span>\n  <span>instance<span>,</span>\n  initialVNode<span>,</span>\n  container</span>\n<span>)</span> <span>{</span>\n  <span>// create reactive effect for rendering</span>\n  <span>// Vic 创建更新函数</span>\n  instance<span>.</span>update <span>=</span> <span>effect</span><span>(</span><span>function</span> <span>componentEffect</span><span>(</span><span>)</span> <span>{</span>\n    <span>const</span> <span>{</span> el <span>}</span> <span>=</span> initialVNode\n    <span>// Vic 在这里创建组件根 dom 的 vNode 树 （这棵树里面的 children 也创建出 vnode）</span>\n    <span>const</span> subTree <span>=</span>  <span>(</span>instance<span>.</span>subTree <span>=</span> <span>renderComponentRoot</span><span>(</span>instance<span>)</span><span>)</span>\n    el <span>&amp;&amp;</span> container<span>.</span><span>removeChild</span><span>(</span>el<span>)</span>\n    <span>// Vic 这个方法里面真正开始构建内存中的 dom 树</span>\n    <span>patch</span><span>(</span>\n      <span>null</span><span>,</span>\n      subTree<span>,</span>\n      container\n    <span>)</span>\n    initialVNode<span>.</span>el <span>=</span> subTree<span>.</span>el\n  <span>}</span><span>)</span>\n<span>}</span>\n\n<span>// 调用实例的 render 方法，得到该组件实例下根 dom 节点的 vnode （由 h 函数来生成）</span>\n<span>function</span> <span>renderComponentRoot</span><span>(</span><span>instance</span><span>)</span> <span>{</span>\n  <span>const</span> <span>{</span>\n    props<span>,</span>\n    slots<span>,</span>\n    attrs<span>,</span>\n    emit<span>,</span>\n    render\n  <span>}</span> <span>=</span> instance\n\n  <span>let</span> result\n  \n  <span>// 函数式组件</span>\n  result <span>=</span> <span>render</span><span>(</span>props<span>,</span> <span>{</span> attrs<span>,</span> slots<span>,</span> emit <span>}</span><span>)</span>\n  <span>return</span> result\n<span>}</span>\n\n<span>// 没啥说的，调用 mountElement 方法</span>\n<span>function</span> <span>processElement</span><span>(</span><span>n1<span>,</span> n2<span>,</span> container</span><span>)</span> <span>{</span>\n  <span>if</span> <span>(</span>n1 <span>==</span> <span>null</span><span>)</span> <span>{</span>\n    <span>mountElement</span><span>(</span>n2<span>,</span> container<span>)</span>\n  <span>}</span>\n<span>}</span>\n\n<span>/**\n * 前置： 能走到这里来就意味着 vnode 是一个 dom 的 vnode （这里的 type 一定是一个字符串）\n * 1. 根据 type 创建 dom 节点\n * 2. 将创建出来的 dom 节点添加到 container 里面\n * 3. 处理 props （属性和事件）\n * 4. mountChildren （遍历 children，递归调用 patch）\n */</span>\n<span>function</span> <span>mountElement</span><span>(</span><span>vnode<span>,</span> container</span><span>)</span> <span>{</span>\n  <span>const</span> <span>{</span> type<span>,</span> props <span>}</span> <span>=</span> vnode\n\n  <span>let</span> el <span>=</span> vnode<span>.</span>el <span>=</span> document<span>.</span><span>createElement</span><span>(</span>type<span>)</span>\n  container<span>.</span><span>appendChild</span><span>(</span>el<span>)</span>\n  Object<span>.</span><span>entries</span><span>(</span>props <span>||</span> <span>{</span><span>}</span><span>)</span><span>.</span><span>forEach</span><span>(</span><span>(</span><span><span>[</span>key<span>,</span> val<span>]</span></span><span>)</span> <span>=></span> <span>{</span>\n    <span>if</span> <span>(</span>key<span>.</span><span>startsWith</span><span>(</span><span>'on'</span><span>)</span><span>)</span> <span>{</span>\n      el<span>.</span><span>addEventListener</span><span>(</span>key<span>.</span><span>substr</span><span>(</span><span>2</span><span>)</span><span>.</span><span>toLocaleLowerCase</span><span>(</span><span>)</span><span>,</span> val<span>)</span>\n    <span>}</span> <span>else</span> <span>{</span>\n      el<span>[</span>key<span>]</span> <span>=</span> val\n    <span>}</span>\n  <span>}</span><span>)</span>\n  <span>if</span> <span>(</span><span>!</span>Array<span>.</span><span>isArray</span><span>(</span>vnode<span>.</span>children<span>)</span><span>)</span> <span>{</span> <span>// 递归的终止点</span>\n    el<span>.</span><span>appendChild</span><span>(</span>document<span>.</span><span>createTextNode</span><span>(</span>vnode<span>.</span>children<span>)</span><span>)</span>\n  <span>}</span> <span>else</span> <span>{</span>\n    <span>mountChildren</span><span>(</span>vnode<span>.</span>children<span>,</span> el<span>,</span> <span>null</span><span>)</span>\n  <span>}</span>\n<span>}</span>\n\n<span>// 对每一个 child 进行 patch</span>\n<span>function</span> <span>mountChildren</span><span>(</span><span>children<span>,</span> container</span><span>)</span> <span>{</span>\n  <span>for</span> <span>(</span><span>let</span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> children<span>.</span>length<span>;</span> i<span>++</span><span>)</span> <span>{</span>\n    <span>const</span> child <span>=</span> children<span>[</span>i<span>]</span>\n    <span>patch</span><span>(</span>\n      <span>null</span><span>,</span>\n      child<span>,</span>\n      container\n    <span>)</span>\n  <span>}</span>\n<span>}</span>\n\n<span>// 乏善可陈（递归的终止点）</span>\n<span>function</span> <span>processText</span><span>(</span><span>n1<span>,</span> n2<span>,</span> container</span><span>)</span> <span>{</span>\n  n2<span>.</span>el <span>=</span> document<span>.</span><span>createTextNode</span><span>(</span>n2<span>.</span>children<span>)</span>\n  container<span>.</span><span>appendChild</span><span>(</span>n2<span>.</span>el<span>)</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br><span>82</span><br><span>83</span><br><span>84</span><br><span>85</span><br><span>86</span><br><span>87</span><br><span>88</span><br><span>89</span><br><span>90</span><br><span>91</span><br><span>92</span><br><span>93</span><br><span>94</span><br><span>95</span><br><span>96</span><br><span>97</span><br><span>98</span><br><span>99</span><br><span>100</span><br><span>101</span><br><span>102</span><br><span>103</span><br><span>104</span><br><span>105</span><br><span>106</span><br><span>107</span><br><span>108</span><br><span>109</span><br><span>110</span><br><span>111</span><br><span>112</span><br><span>113</span><br><span>114</span><br><span>115</span><br><span>116</span><br><span>117</span><br><span>118</span><br><span>119</span><br><span>120</span><br><span>121</span><br><span>122</span><br><span>123</span><br><span>124</span><br><span>125</span><br><span>126</span><br><span>127</span><br><span>128</span><br><span>129</span><br><span>130</span><br><span>131</span><br><span>132</span><br><span>133</span><br><span>134</span><br><span>135</span><br><span>136</span><br><span>137</span><br><span>138</span><br><span>139</span><br><span>140</span><br><span>141</span><br><span>142</span><br><span>143</span><br><span>144</span><br><span>145</span><br><span>146</span><br><span>147</span><br><span>148</span><br><span>149</span><br><span>150</span><br><span>151</span><br><span>152</span><br><span>153</span><br><span>154</span><br><span>155</span><br><span>156</span><br><span>157</span><br><span>158</span><br><span>159</span><br><span>160</span><br><span>161</span><br><span>162</span><br><span>163</span><br><span>164</span><br><span>165</span><br><span>166</span><br><span>167</span><br><span>168</span><br><span>169</span><br><span>170</span><br><span>171</span><br><span>172</span><br><span>173</span><br><span>174</span><br><span>175</span><br><span>176</span><br><span>177</span><br><span>178</span><br><span>179</span><br><span>180</span><br><span>181</span><br><span>182</span><br><span>183</span><br><span>184</span><br><span>185</span><br><span>186</span><br><span>187</span><br><span>188</span><br><span>189</span><br><span>190</span><br><span>191</span><br><span>192</span><br><span>193</span><br><span>194</span><br><span>195</span><br><span>196</span><br><span>197</span><br><span>198</span><br><span>199</span><br><span>200</span><br><span>201</span><br><span>202</span><br><span>203</span><br><span>204</span><br><span>205</span><br><span>206</span><br><span>207</span><br><span>208</span><br><span>209</span><br><span>210</span><br><span>211</span><br><span>212</span><br><span>213</span><br><span>214</span><br><span>215</span><br><span>216</span><br><span>217</span><br><span>218</span><br><span>219</span><br><span>220</span><br><span>221</span><br><span>222</span><br><span>223</span><br><span>224</span><br><span>225</span><br><span>226</span><br><span>227</span><br><span>228</span><br><span>229</span><br><span>230</span><br><span>231</span><br><span>232</span><br><span>233</span><br><span>234</span><br><span>235</span><br><span>236</span><br><span>237</span><br><span>238</span><br><span>239</span><br><span>240</span><br><span>241</span><br><span>242</span><br><span>243</span><br><span>244</span><br><span>245</span><br></div></div><h2 id=\"最后\"> 最后</h2>\n<p>本文旨在厘清 mount 递归挂载 vue3 应用的整个过程。函数名称与 vue-next 源码保持一致，但是隐藏了大量的细节以及与 mount 无关的分支。</p>\n",
      "image": "https://x-vic.gitee.io/code/code/code/images/mount.svg",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "reactive && effect",
      "url": "https://x-vic.gitee.io/code/code/views/owner-vue-next/",
      "id": "https://x-vic.gitee.io/code/code/views/owner-vue-next/",
      "content_html": "<h2 id=\"目标\"> 目标</h2>\n<p>实现 vue-next 响应式模块中的两个 API : <code>reactive</code>、 <code>effect</code></p>\n<div><pre><code><span>var</span> obj <span>=</span> <span>reactive</span><span>(</span><span>{</span>\n  name<span>:</span> <span>'Vic'</span><span>,</span>\n  haha<span>:</span> <span>{</span>\n    num<span>:</span> <span>0</span>\n  <span>}</span>\n<span>}</span><span>)</span>\n\n<span>effect</span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>{</span>\n  console<span>.</span><span>log</span><span>(</span><span>'打印消息：obj.name'</span><span>,</span> obj<span>.</span>name<span>)</span>\n<span>}</span><span>)</span>\n\n<span>effect</span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>{</span>\n  console<span>.</span><span>log</span><span>(</span><span>'打印消息：obj.haha.num'</span><span>,</span> obj<span>.</span>haha<span>.</span>num<span>)</span>\n<span>}</span><span>)</span>\n\nobj<span>.</span>name <span>=</span> <span>'qiu'</span>\nobj<span>.</span>haha<span>.</span>num <span>=</span> <span>9</span>\n\n<span>// output Vic</span>\n<span>// output 0</span>\n<span>// output qiu</span>\n<span>// output 9</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br></div></div><h2 id=\"代码实现\"> 代码实现</h2>\n<div><pre><code><span>const</span> targetMap <span>=</span> <span>new</span> <span>Map</span><span>(</span><span>)</span>\n<span>let</span> activeEffect\n\n<span>const</span> handlers <span>=</span> <span>{</span>\n  <span>get</span><span>:</span> <span>function</span> <span>get</span><span>(</span><span>target<span>,</span> key<span>,</span> receiver</span><span>)</span> <span>{</span>\n    <span>const</span> res <span>=</span> Reflect<span>.</span><span>get</span><span>(</span>target<span>,</span> key<span>,</span> receiver<span>)</span>\n    <span>track</span><span>(</span>target<span>,</span> key<span>)</span>\n    <span>return</span> <span>typeof</span> res <span>===</span> <span>'object'</span>\n      <span>?</span> <span>reactive</span><span>(</span>res<span>)</span>\n      <span>:</span> res\n  <span>}</span><span>,</span>\n  <span>set</span><span>:</span> <span>function</span> <span>set</span><span>(</span><span>target<span>,</span> key<span>,</span> value<span>,</span> receiver</span><span>)</span> <span>{</span>\n    <span>const</span> result <span>=</span> Reflect<span>.</span><span>set</span><span>(</span>target<span>,</span> key<span>,</span> value<span>,</span> receiver<span>)</span>\n    <span>trigger</span><span>(</span>target<span>,</span> key<span>)</span>\n    <span>return</span> result\n  <span>}</span>\n<span>}</span>\n\n<span>function</span> <span>reactive</span><span>(</span><span>target</span><span>)</span> <span>{</span>\n  <span>return</span> <span>new</span> <span>Proxy</span><span>(</span>target<span>,</span> handlers<span>)</span>\n<span>}</span>\n\n<span>function</span> <span>effect</span><span>(</span><span>fn<span>,</span> options <span>=</span> <span>{</span><span>}</span></span><span>)</span> <span>{</span>\n  <span>// 包装原始函数，生成 Effect 对象（实际上就是在 fn 上面个添加一些静态属性）</span>\n  <span>const</span> effect <span>=</span> <span>createReactiveEffect</span><span>(</span>fn<span>,</span> options<span>)</span>\n  <span>effect</span><span>(</span><span>)</span>\n  <span>return</span> effect\n<span>}</span>\n\n<span>function</span> <span>createReactiveEffect</span><span>(</span><span>fn<span>,</span> options</span><span>)</span> <span>{</span>\n  <span>const</span> <span>effect</span> <span>=</span> <span>function</span> <span>reactiveEffect</span><span>(</span><span><span>...</span>args</span><span>)</span> <span>{</span>\n    <span>return</span> <span>run</span><span>(</span>effect<span>,</span> fn<span>,</span> args<span>)</span>\n  <span>}</span>\n  effect<span>.</span>active <span>=</span> <span>true</span>\n  <span>// effect函数中依赖的数据列表（响应数据中也会有一份 effects 的引用。它们是属于多对多的关系）</span>\n  <span>return</span> effect\n<span>}</span>\n\n<span>function</span> <span>run</span><span>(</span><span>effect<span>,</span> fn<span>,</span> args</span><span>)</span> <span>{</span>\n  <span>if</span> <span>(</span><span><span>!</span>effect<span>.</span>active</span><span>)</span> <span>{</span>\n    <span>return</span> <span>fn</span><span>(</span><span>...</span>args<span>)</span>\n  <span>}</span>\n  activeEffect <span>=</span> effect\n  <span>// 在这里触发了 getter，进而开始 track</span>\n  <span>const</span> res <span>=</span> <span>fn</span><span>(</span><span>...</span>args<span>)</span>\n  effect<span>.</span>active <span>=</span> <span>false</span>\n  activeEffect <span>=</span> <span>null</span>\n  <span>return</span> res\n<span>}</span>\n\n<span>function</span> <span>track</span><span>(</span><span>target<span>,</span> key</span><span>)</span> <span>{</span>\n  <span>if</span> <span>(</span><span>activeEffect <span>==</span> <span>null</span></span><span>)</span> <span>{</span>\n    <span>return</span>\n  <span>}</span>\n  <span>let</span> depsMap <span>=</span> targetMap<span>.</span><span>get</span><span>(</span>target<span>)</span>\n  <span>if</span> <span>(</span><span>depsMap <span>==</span> <span>null</span></span><span>)</span> <span>{</span>\n    targetMap<span>.</span><span>set</span><span>(</span>target<span>,</span> <span>(</span>depsMap <span>=</span> <span>new</span> <span>Map</span><span>(</span><span>)</span><span>)</span><span>)</span>\n  <span>}</span>\n  <span>let</span> dep <span>=</span> depsMap<span>.</span><span>get</span><span>(</span>key<span>)</span>\n  <span>if</span> <span>(</span><span>dep <span>==</span> <span>null</span></span><span>)</span> <span>{</span>\n    depsMap<span>.</span><span>set</span><span>(</span>key<span>,</span> <span>(</span>dep <span>=</span> <span>new</span> <span>Set</span><span>(</span><span>)</span><span>)</span><span>)</span>\n  <span>}</span>\n  <span>if</span> <span>(</span><span><span>!</span>dep<span>.</span><span>has</span><span>(</span>activeEffect<span>)</span></span><span>)</span> <span>{</span>\n    <span>// 将 activeEffect 添加进依赖列表</span>\n    dep<span>.</span><span>add</span><span>(</span>activeEffect<span>)</span>\n  <span>}</span>\n<span>}</span>\n\n<span>function</span> <span>trigger</span><span>(</span><span>target<span>,</span> key</span><span>)</span> <span>{</span>\n  <span>const</span> depsMap <span>=</span> targetMap<span>.</span><span>get</span><span>(</span>target<span>)</span>\n  <span>if</span> <span>(</span><span>depsMap <span>==</span> <span>null</span></span><span>)</span> <span>{</span>\n    <span>return</span>\n  <span>}</span>\n  depsMap<span>.</span><span>get</span><span>(</span>key<span>)</span><span>.</span><span>forEach</span><span>(</span><span>effect</span> <span>=></span> <span>effect</span><span>(</span><span>)</span><span>)</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "组件渲染的细节",
      "url": "https://x-vic.gitee.io/code/code/views/vue-next/componentDetail/",
      "id": "https://x-vic.gitee.io/code/code/views/vue-next/componentDetail/",
      "content_html": "<h2 id=\"得到组件的-render-方法\"> 得到组件的 render 方法</h2>\n<blockquote>\n<p>在 mountComponent 的时候（setupRenderEffect 之前），vue 会 setupComponent(instance)</p>\n</blockquote>\n<ol>\n<li>模版编译得到 render</li>\n<li>setup 方法返回的是一个函数，那么该函数自动成为实例的 render 方法</li>\n</ol>\n<h3 id=\"setupcomponent-instance\"> setupComponent(instance)</h3>\n<ol>\n<li>初始化 props</li>\n<li>初始化 slots</li>\n<li>调用 setupStatefulComponent</li>\n</ol>\n<div><pre><code><span>export</span> <span>function</span> <span>setupComponent</span><span>(</span>\n  instance<span>:</span> ComponentInternalInstance<span>,</span>\n  isSSR <span>=</span> <span>false</span>\n<span>)</span> <span>{</span>\n  <span>const</span> <span>{</span> props<span>,</span> children<span>,</span> shapeFlag <span>}</span> <span>=</span> instance<span>.</span>vnode\n  <span>const</span> isStateful <span>=</span> shapeFlag <span>&amp;</span> ShapeFlags<span>.</span><span>STATEFUL_COMPONENT</span>\n  <span>initProps</span><span>(</span>instance<span>,</span> props<span>,</span> isStateful<span>,</span> isSSR<span>)</span>\n  <span>initSlots</span><span>(</span>instance<span>,</span> children<span>)</span>\n\n  <span>const</span> setupResult <span>=</span> isStateful\n    <span>?</span> <span>setupStatefulComponent</span><span>(</span>instance<span>,</span> isSSR<span>)</span>\n    <span>:</span> <span>undefined</span>\n  <span>return</span> setupResult\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br></div></div><h3 id=\"setupstatefulcomponent\"> setupStatefulComponent</h3>\n<div><pre><code><span>function</span> <span>setupStatefulComponent</span><span>(</span>\n  instance<span>:</span> ComponentInternalInstance\n<span>)</span> <span>{</span>\n  <span>const</span> Component <span>=</span> instance<span>.</span><span>type</span> <span><span>as</span></span> ComponentOptions\n  <span>// 0. create render proxy property access cache</span>\n  instance<span>.</span>accessCache <span>=</span> <span>{</span><span>}</span>\n  <span>// 1. create public instance / render proxy</span>\n  <span>// also mark it raw so it's never observed</span>\n  instance<span>.</span>proxy <span>=</span> <span>new</span> <span>Proxy</span><span>(</span>instance<span>.</span>ctx<span>,</span> PublicInstanceProxyHandlers<span>)</span>\n  <span>// 2. call setup()</span>\n  <span>const</span> <span>{</span> setup <span>}</span> <span>=</span> Component\n  <span>if</span> <span>(</span>setup<span>)</span> <span>{</span>\n    <span>const</span> setupContext <span>=</span> <span>(</span>instance<span>.</span>setupContext <span>=</span>\n      setup<span>.</span>length <span>></span> <span>1</span> <span>?</span> <span>createSetupContext</span><span>(</span>instance<span>)</span> <span>:</span> <span>null</span><span>)</span>\n\n    currentInstance <span>=</span> instance\n    <span>const</span> setupResult <span>=</span> <span>callWithErrorHandling</span><span>(</span>\n      setup<span>,</span>\n      instance<span>,</span>\n      ErrorCodes<span>.</span><span>SETUP_FUNCTION</span><span>,</span>\n      <span>// 这里是真正注入到 setup 函数中的参数</span>\n      <span>[</span>__DEV__ <span>?</span> <span>shallowReadonly</span><span>(</span>instance<span>.</span>props<span>)</span> <span>:</span> instance<span>.</span>props<span>,</span> setupContext<span>]</span>\n    <span>)</span>\n    currentInstance <span>=</span> <span>null</span>\n\n    <span>handleSetupResult</span><span>(</span>instance<span>,</span> setupResult<span>,</span> isSSR<span>)</span>\n  <span>}</span> <span>else</span> <span>{</span>\n    <span>finishComponentSetup</span><span>(</span>instance<span>,</span> isSSR<span>)</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br></div></div><h3 id=\"callwitherrorhandling\"> callWithErrorHandling</h3>\n<p>调用 setup，进行错误处理</p>\n<div><pre><code><span>export</span> <span>function</span> <span>callWithErrorHandling</span><span>(</span>\n  fn<span>:</span> <span>Function</span><span>,</span>\n  instance<span>:</span> ComponentInternalInstance <span>|</span> <span>null</span><span>,</span>\n  <span>type</span><span>:</span> ErrorTypes<span>,</span>\n  args<span>?</span><span>:</span> <span>unknown</span><span>[</span><span>]</span>\n<span>)</span> <span>{</span>\n  <span>let</span> res\n  <span>try</span> <span>{</span>\n    res <span>=</span> args <span>?</span> <span>fn</span><span>(</span><span>...</span>args<span>)</span> <span>:</span> <span>fn</span><span>(</span><span>)</span>\n  <span>}</span> <span>catch</span> <span>(</span>err<span>)</span> <span>{</span>\n    <span>handleError</span><span>(</span>err<span>,</span> instance<span>,</span> <span>type</span><span>)</span>\n  <span>}</span>\n  <span>return</span> res\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br></div></div><h3 id=\"handlesetupresult\"> handleSetupResult</h3>\n<ol>\n<li>如果 setup 返回的是一个函数，那么这个函数将成为 instance 的 render 方法</li>\n<li>将 setupResult 包装成 reactive 类型（如果已经是，那就作罢），并将之赋值给 instance.setupState</li>\n<li>得到 render，兼容 2.x 选项组件</li>\n</ol>\n<div><pre><code><span>export</span> <span>function</span> <span>handleSetupResult</span><span>(</span>\n  instance<span>:</span> ComponentInternalInstance<span>,</span>\n  setupResult<span>:</span> <span>unknown</span><span>,</span>\n  isSSR<span>:</span> <span>boolean</span>\n<span>)</span> <span>{</span>\n  <span>// 如果 setup 返回的是一个函数，那么这个函数将成为 instance 的 render 方法</span>\n  <span>if</span> <span>(</span><span>isFunction</span><span>(</span>setupResult<span>)</span><span>)</span> <span>{</span>\n    instance<span>.</span>render <span>=</span> setupResult <span>as</span> InternalRenderFunction\n  <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>isObject</span><span>(</span>setupResult<span>)</span><span>)</span> <span>{</span>\n    <span>// 将 setupResult 包装成 reactive 类型（如果已经是，那就作罢），并将之赋值给 instance.setupState</span>\n    instance<span>.</span>setupState <span>=</span> <span>reactive</span><span>(</span>setupResult<span>)</span>\n  <span>}</span>\n  <span>finishComponentSetup</span><span>(</span>instance<span>,</span> isSSR<span>)</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br></div></div><h3 id=\"finishcomponentsetup\"> finishComponentSetup</h3>\n<ol>\n<li>运行时编译得到 render</li>\n<li>兼容 2.x 版本的 options</li>\n</ol>\n<div><pre><code><span>function</span> <span>finishComponentSetup</span><span>(</span>\n  instance<span>:</span> ComponentInternalInstance<span>,</span>\n  isSSR<span>:</span> <span>boolean</span>\n<span>)</span> <span>{</span>\n  <span>const</span> Component <span>=</span> instance<span>.</span><span>type</span> <span><span>as</span></span> ComponentOptions\n\n  <span>// template / render function normalization</span>\n  <span>if</span> <span>(</span>__NODE_JS__ <span>&amp;&amp;</span> isSSR<span>)</span> <span>{</span>\n    <span>if</span> <span>(</span>Component<span>.</span>render<span>)</span> <span>{</span>\n      instance<span>.</span>render <span>=</span> Component<span>.</span>render <span>as</span> InternalRenderFunction\n    <span>}</span>\n  <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>!</span>instance<span>.</span>render<span>)</span> <span>{</span>\n    <span>if</span> <span>(</span>compile <span>&amp;&amp;</span> Component<span>.</span>template <span>&amp;&amp;</span> <span>!</span>Component<span>.</span>render<span>)</span> <span>{</span>\n      <span>// 在这里，得到运行时编译出来的 render 方法，并且将这个方法缓存起来 compileCache[key] = render 其中，key 是原始模版字符串 </span>\n      Component<span>.</span>render <span>=</span> <span>compile</span><span>(</span>Component<span>.</span>template<span>,</span> <span>{</span>\n        isCustomElement<span>:</span> instance<span>.</span>appContext<span>.</span>config<span>.</span>isCustomElement <span>||</span> <span>NO</span>\n      <span>}</span><span>)</span>\n      <span>// 标记这个 render 方法是一个 runtime compile function</span>\n      <span>;</span><span>(</span>Component<span>.</span>render <span>as</span> InternalRenderFunction<span>)</span><span>.</span>_rc <span>=</span> <span>true</span>\n    <span>}</span>\n\n    instance<span>.</span>render <span>=</span> <span>(</span>Component<span>.</span>render <span>||</span> <span>NOOP</span><span>)</span> <span>as</span> InternalRenderFunction\n\n    <span>// 运行时编译的 render 使用了 with 语句，重新代理...</span>\n    <span>if</span> <span>(</span>instance<span>.</span>render<span>.</span>_rc<span>)</span> <span>{</span>\n      instance<span>.</span>withProxy <span>=</span> <span>new</span> <span>Proxy</span><span>(</span>\n        instance<span>.</span>ctx<span>,</span>\n        RuntimeCompiledPublicInstanceProxyHandlers\n      <span>)</span>\n    <span>}</span>\n  <span>}</span>\n\n  <span>// 兼容 2.x 选项组件</span>\n  <span>if</span> <span>(</span>__FEATURE_OPTIONS__<span>)</span> <span>{</span>\n    currentInstance <span>=</span> instance\n    <span>applyOptions</span><span>(</span>instance<span>,</span> Component<span>)</span>\n    currentInstance <span>=</span> <span>null</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br></div></div><h2 id=\"如何得到组件中真正需要渲染的-vdom\"> 如何得到组件中真正需要渲染的 vdom</h2>\n<blockquote>\n<p>渲染(effect)一个组件的时候，通过 <code>const subTree = (instance.subTree = renderComponentRoot(instance))</code> 调用了 instance 的 render 方法，生成了标签 vnode 以及 自组件 vnode</p>\n</blockquote>\n<h3 id=\"rendercomponentroot\"> renderComponentRoot</h3>\n<p>调用 instance 的 render 方法，返回真实节点的 vnode</p>\n<div><pre><code><span>export</span> <span>function</span> <span>renderComponentRoot</span><span>(</span>\n  instance<span>:</span> ComponentInternalInstance\n<span>)</span><span>:</span> VNode <span>{</span>\n  <span>const</span> <span>{</span>\n    <span>type</span><span>:</span> Component<span>,</span>\n    parent<span>,</span>\n    vnode<span>,</span>\n    proxy<span>,</span>\n    withProxy<span>,</span>\n    props<span>,</span>\n    slots<span>,</span>\n    attrs<span>,</span>\n    emit<span>,</span>\n    renderCache\n  <span>}</span> <span>=</span> instance\n\n  <span>let</span> result\n  currentRenderingInstance <span>=</span> instance\n  \n  <span>let</span> fallthroughAttrs\n  <span>// 选项组件</span>\n  <span>if</span> <span>(</span>vnode<span>.</span>shapeFlag <span>&amp;</span> ShapeFlags<span>.</span><span>STATEFUL_COMPONENT</span><span>)</span> <span>{</span>\n    <span>// 运行时编译出来的 render 使用了 with 语句，这里要判断是不是需要 withProxy （with 语句对 has 操作符是要区别处理的）</span>\n    <span>const</span> proxyToUse <span>=</span> withProxy <span>||</span> proxy\n    <span>// 在这里创建子节点的 vNode</span>\n    result <span>=</span> <span>normalizeVNode</span><span>(</span>\n      instance<span>.</span>render<span>!</span><span>.</span><span>call</span><span>(</span>proxyToUse<span>,</span> proxyToUse<span>!</span><span>,</span> renderCache<span>)</span>\n    <span>)</span>\n    fallthroughAttrs <span>=</span> attrs\n  <span>}</span> <span>else</span> <span>{</span>\n    <span>// 函数式组件</span>\n    <span>const</span> render <span>=</span> Component <span>as</span> FunctionalComponent\n    result <span>=</span> <span>normalizeVNode</span><span>(</span>\n      render<span>.</span>length <span>></span> <span>1</span>\n        <span>// 往函数式组件（即单独一个 setup 函数）注入相关参数</span>\n        <span>?</span> <span>render</span><span>(</span>props<span>,</span> <span>{</span> attrs<span>,</span> slots<span>,</span> emit <span>}</span><span>)</span>\n        <span>:</span> <span>render</span><span>(</span>props<span>,</span> <span>null</span> <span>as</span> <span>any</span> <span>/* we know it doesn't need it */</span><span>)</span>\n    <span>)</span>\n    fallthroughAttrs <span>=</span> Component<span>.</span>props <span>?</span> attrs <span>:</span> <span>getFallthroughAttrs</span><span>(</span>attrs<span>)</span>\n  <span>}</span>\n\n  <span>let</span> root <span>=</span> result  \n  \n  root <span>=</span> <span>cloneVNode</span><span>(</span>root<span>,</span> fallthroughAttrs<span>)</span>\n  \n  result <span>=</span> root\n  currentRenderingInstance <span>=</span> <span>null</span>\n\n  <span>return</span> result\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br></div></div><h3 id=\"内存中创建的-render\"> 内存中创建的 render</h3>\n<div><pre><code><span>(</span><span>function</span> <span>anonymous</span><span>(</span><span>Vue</span>\n<span>)</span> <span>{</span>\n<span>const</span> _Vue <span>=</span> Vue\n\n<span>return</span> <span>function</span> <span>render</span><span>(</span><span>_ctx<span>,</span> _cache</span><span>)</span> <span>{</span>\n  <span>// 通过 with 语句将 vue 组件实例注入到 render 函数的执行上下文中，以便 render 函数直接读取实例中的 data、method...</span>\n  <span>with</span> <span>(</span>_ctx<span>)</span> <span>{</span>\n    <span>const</span> <span>{</span> resolveComponent<span>:</span> _resolveComponent<span>,</span> createVNode<span>:</span> _createVNode<span>,</span> toDisplayString<span>:</span> _toDisplayString<span>,</span> createTextVNode<span>:</span> _createTextVNode<span>,</span> Fragment<span>:</span> _Fragment<span>,</span> openBlock<span>:</span> _openBlock<span>,</span> createBlock<span>:</span> _createBlock <span>}</span> <span>=</span> _Vue\n\n    <span>const</span> _component_Hehe <span>=</span> <span>_resolveComponent</span><span>(</span><span>\"Hehe\"</span><span>)</span>\n\n    <span>return</span> <span>(</span><span>_openBlock</span><span>(</span><span>)</span><span>,</span> <span>_createBlock</span><span>(</span>_Fragment<span>,</span> <span>null</span><span>,</span> <span>[</span>\n      <span>_createVNode</span><span>(</span>_component_Hehe<span>)</span><span>,</span>\n      <span>// count 直接从 _ctx 中读取</span>\n      <span>_createTextVNode</span><span>(</span><span>_toDisplayString</span><span>(</span>count<span>)</span><span>,</span> <span>1</span> <span>/* TEXT */</span><span>)</span>\n    <span>]</span><span>,</span> <span>64</span> <span>/* STABLE_FRAGMENT */</span><span>)</span><span>)</span>\n  <span>}</span>\n<span>}</span>\n<span>}</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "createApp && mount",
      "url": "https://x-vic.gitee.io/code/code/views/vue-next/createApp&mount/",
      "id": "https://x-vic.gitee.io/code/code/views/vue-next/createApp&mount/",
      "content_html": "<p><img src=\"/code/images/patch.svg\" alt=\"patch\"></p>\n<h2 id=\"createapp\"> createApp</h2>\n<ol>\n<li>根据不同的宿主环境创建不同的 app</li>\n<li>初始化 app 的各种方法</li>\n</ol>\n<blockquote>\n<p>在 createApp 传入的参数被当作闭包存起来，之后在调用 app 的各种方法时，都可以直接取到这些入参。</p>\n</blockquote>\n<div><pre><code><span>const</span> <span>createApp</span> <span>=</span> <span>(</span>rootComponent<span>,</span> rootProps <span>=</span> <span>null</span><span>)</span> <span>=></span> <span>{</span>\n  <span>/**\n   * context 包含 components、config、directives、mixins、provides\n  */</span>\n  <span>const</span> context <span>=</span> <span>createAppContext</span><span>(</span><span>)</span>\n  <span>const</span> app<span>:</span> App <span>=</span> <span>{</span>\n    _component<span>:</span> rootComponent <span>as</span> Component<span>,</span>\n    _props<span>:</span> rootProps<span>,</span>\n    _container<span>:</span> <span>null</span><span>,</span>\n    _context<span>:</span> context<span>,</span>\n\n    <span>get</span> <span>config</span><span>(</span><span>)</span> <span>{</span><span>}</span><span>,</span>\n    <span>set</span> <span>config</span><span>(</span>v<span>)</span> <span>{</span><span>}</span><span>,</span>\n\n    <span>use</span><span>(</span>plugin<span>:</span> Plugin<span>,</span> <span>...</span>options<span>:</span> <span>any</span><span>[</span><span>]</span><span>)</span> <span>{</span><span>}</span><span>,</span>\n    <span>mixin</span><span>(</span>mixin<span>:</span> ComponentOptions<span>)</span> <span>{</span><span>}</span><span>,</span>\n    <span>component</span><span>(</span>name<span>:</span> <span>string</span><span>,</span> component<span>?</span><span>:</span> PublicAPIComponent<span>)</span><span>:</span> <span>any</span> <span>{</span><span>}</span><span>,</span>\n    <span>directive</span><span>(</span>name<span>:</span> <span>string</span><span>,</span> directive<span>?</span><span>:</span> Directive<span>)</span> <span>{</span><span>}</span><span>,</span>\n    <span>mount</span><span>(</span>rootContainer<span>:</span> HostElement<span>,</span> isHydrate<span>?</span><span>:</span> <span>boolean</span><span>)</span><span>:</span> <span>any</span> <span>{</span><span>}</span><span>,</span>\n    <span>unmount</span><span>(</span><span>)</span> <span>{</span><span>}</span><span>,</span>\n    <span>provide</span><span>(</span>key<span>,</span> value<span>)</span> <span>{</span><span>}</span>\n  <span>}</span>\n\n  <span>return</span> app\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br></div></div><h2 id=\"mount\"> mount</h2>\n<div><pre><code><span>mount</span><span>(</span>rootContainer<span>:</span> HostElement<span>,</span> isHydrate<span>?</span><span>:</span> <span>boolean</span><span>)</span><span>:</span> <span>any</span> <span>{</span>\n  <span>// rootComponent 从 createApp 中的闭包中拿到</span>\n  <span>/**\n   * 1. 确定 shapeFlag （shapeFlag 用来分辨这个 vnode 是什么类型，如 string、element、statefulComponent、FunctionalComponent...）\n  */</span>\n  <span>const</span> vnode <span>=</span> <span>createVNode</span><span>(</span>rootComponent <span>as</span> Component<span>,</span> rootProps<span>)</span>\n  <span>render</span><span>(</span>vnode<span>,</span> rootContainer<span>)</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div><h3 id=\"根-render\"> 根 render</h3>\n<div><pre><code><span>const</span> render<span>:</span> <span>RootRenderFunction</span> <span>=</span> <span>(</span>vnode<span>,</span> container<span>)</span> <span>=></span> <span>{</span>\n  <span>patch</span><span>(</span>container<span>.</span>_vnode <span>||</span> <span>null</span><span>,</span> vnode<span>,</span> container<span>)</span>\n  <span>flushPostFlushCbs</span><span>(</span><span>)</span>\n  container<span>.</span>_vnode <span>=</span> vnode\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></div></div><h3 id=\"patch\"> patch</h3>\n<div><pre><code><span>const</span> patch<span>:</span> <span>PatchFn</span> <span>=</span> <span>(</span>\n  n1<span>,</span>\n  n2<span>,</span>\n  container<span>,</span>\n  anchor <span>=</span> <span>null</span><span>,</span>\n  parentComponent <span>=</span> <span>null</span><span>,</span>\n  parentSuspense <span>=</span> <span>null</span><span>,</span>\n  isSVG <span>=</span> <span>false</span><span>,</span>\n  optimized <span>=</span> <span>false</span>\n<span>)</span> <span>=></span> <span>{</span>\n  <span>// 对比 n1 n2 类型是否相同，如果不想同，就卸载旧的 vnode</span>\n  <span>if</span> <span>(</span>n1 <span>&amp;&amp;</span> <span>!</span><span>isSameVNodeType</span><span>(</span>n1<span>,</span> n2<span>)</span><span>)</span> <span>{</span>\n    anchor <span>=</span> <span>getNextHostNode</span><span>(</span>n1<span>)</span>\n    <span>unmount</span><span>(</span>n1<span>,</span> parentComponent<span>,</span> parentSuspense<span>,</span> <span>true</span><span>)</span>\n    n1 <span>=</span> <span>null</span>\n  <span>}</span>\n\n  <span>const</span> <span>{</span> <span>type</span><span>,</span> ref<span>,</span> shapeFlag <span>}</span> <span>=</span> n2\n  <span>switch</span> <span>(</span><span>type</span><span>)</span> <span>{</span>\n    <span>case</span> Text<span>:</span>\n      <span>processText</span><span>(</span>n1<span>,</span> n2<span>,</span> container<span>,</span> anchor<span>)</span>\n      <span>break</span>\n    <span>case</span> Comment<span>:</span>\n      <span>processCommentNode</span><span>(</span>n1<span>,</span> n2<span>,</span> container<span>,</span> anchor<span>)</span>\n      <span>break</span>\n    <span>case</span> Static<span>:</span>\n      <span>if</span> <span>(</span>n1 <span>==</span> <span>null</span><span>)</span> <span>{</span>\n        <span>mountStaticNode</span><span>(</span>n2<span>,</span> container<span>,</span> anchor<span>,</span> isSVG<span>)</span>\n      <span>}</span> <span>else</span> <span>if</span> <span>(</span>__DEV__<span>)</span> <span>{</span>\n        <span>patchStaticNode</span><span>(</span>n1<span>,</span> n2<span>,</span> container<span>,</span> isSVG<span>)</span>\n      <span>}</span>\n      <span>break</span>\n    <span>case</span> Fragment<span>:</span>\n      <span>processFragment</span><span>(</span>\n        n1<span>,</span>\n        n2<span>,</span>\n        container\n      <span>)</span>\n      <span>break</span>\n    <span>default</span><span>:</span>\n      <span>if</span> <span>(</span>shapeFlag <span>&amp;</span> ShapeFlags<span>.</span><span>ELEMENT</span><span>)</span> <span>{</span>\n        <span>processElement</span><span>(</span>\n          n1<span>,</span>\n          n2<span>,</span>\n          container\n        <span>)</span>\n      <span>}</span> <span>else</span> <span>if</span> <span>(</span>shapeFlag <span>&amp;</span> ShapeFlags<span>.</span><span>COMPONENT</span><span>)</span> <span>{</span>\n        <span>// 首次 mount 走的就是这个分支</span>\n        <span>processComponent</span><span>(</span>\n          n1<span>,</span>\n          n2<span>,</span>\n          container\n        <span>)</span>\n      <span>}</span> <span>else</span> <span>if</span> <span>(</span>shapeFlag <span>&amp;</span> ShapeFlags<span>.</span><span>TELEPORT</span><span>)</span> <span>{</span>\n        <span>;</span><span>(</span><span>type</span> <span><span>as</span></span> <span>typeof</span> TeleportImpl<span>)</span><span>.</span><span>process</span><span>(</span>\n          n1<span>,</span>\n          n2<span>,</span>\n          container\n        <span>)</span>\n      <span>}</span> <span>else</span> <span>if</span> <span>(</span>__FEATURE_SUSPENSE__ <span>&amp;&amp;</span> shapeFlag <span>&amp;</span> ShapeFlags<span>.</span><span>SUSPENSE</span><span>)</span> <span>{</span>\n        <span>;</span><span>(</span><span>type</span> <span><span>as</span></span> <span>typeof</span> SuspenseImpl<span>)</span><span>.</span><span>process</span><span>(</span>\n          n1<span>,</span>\n          n2<span>,</span>\n          container\n        <span>)</span>\n      <span>}</span> <span>else</span> <span>if</span> <span>(</span>__DEV__<span>)</span> <span>{</span>\n        <span>warn</span><span>(</span><span>'Invalid VNode type:'</span><span>,</span> <span>type</span><span>,</span> <span><span>`</span><span>(</span><span><span>${</span><span>typeof</span> <span>type</span><span>}</span></span><span>)</span><span>`</span></span><span>)</span>\n      <span>}</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br></div></div><h3 id=\"processcomponent\"> processComponent</h3>\n<ol>\n<li>判断 n1 是否存在来执行</li>\n</ol>\n<div><pre><code><span>const</span> <span>processComponent</span> <span>=</span> <span>(</span>\n  n1<span>:</span> VNode <span>|</span> <span>null</span><span>,</span>\n  n2<span>:</span> VNode<span>,</span>\n  container<span>:</span> RendererElement<span>,</span>\n  anchor<span>:</span> RendererNode <span>|</span> <span>null</span><span>,</span>\n  parentComponent<span>:</span> ComponentInternalInstance <span>|</span> <span>null</span><span>,</span>\n  parentSuspense<span>:</span> SuspenseBoundary <span>|</span> <span>null</span><span>,</span>\n  isSVG<span>:</span> <span>boolean</span><span>,</span>\n  optimized<span>:</span> <span>boolean</span>\n<span>)</span> <span>=></span> <span>{</span>\n  <span>if</span> <span>(</span>n1 <span>==</span> <span>null</span><span>)</span> <span>{</span>\n    <span>mountComponent</span><span>(</span>\n      n2<span>,</span>\n      container<span>,</span>\n      anchor<span>,</span>\n      parentComponent<span>,</span>\n      parentSuspense<span>,</span>\n      isSVG<span>,</span>\n      optimized\n    <span>)</span>\n  <span>}</span> <span>else</span> <span>{</span>\n    <span>updateComponent</span><span>(</span>n1<span>,</span> n2<span>,</span> parentComponent<span>,</span> optimized<span>)</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br></div></div><h3 id=\"mountcomponent\"> mountComponent</h3>\n<ol>\n<li>创建组件实例</li>\n<li>执行 setup 函数</li>\n<li>调用 setupRenderEffect</li>\n</ol>\n<div><pre><code><span>const</span> mountComponent<span>:</span> <span>MountComponentFn</span> <span>=</span> <span>(</span>\n  initialVNode<span>,</span>\n  container<span>,</span>\n  anchor<span>,</span>\n  parentComponent<span>,</span>\n  parentSuspense<span>,</span>\n  isSVG<span>,</span>\n  optimized\n<span>)</span> <span>=></span> <span>{</span>\n  <span>/**\n   * 创建组件实例，该实例主要包含：各钩子函数、ctx（$data、$emit...）、\n  */</span>\n  <span>const</span> instance<span>:</span> ComponentInternalInstance <span>=</span> <span>(</span>initialVNode<span>.</span>component <span>=</span> <span>createComponentInstance</span><span>(</span>\n    initialVNode<span>,</span>\n    parentComponent<span>,</span>\n    parentSuspense\n  <span>)</span><span>)</span>\n\n  <span>/**\n   * 初始化 props、slots\n   * 执行 setup 函数，返回结果\n  */</span>\n  <span>setupComponent</span><span>(</span>instance<span>)</span>\n\n  <span>setupRenderEffect</span><span>(</span>\n    instance<span>,</span>\n    initialVNode<span>,</span>\n    container<span>,</span>\n    anchor<span>,</span>\n    parentSuspense<span>,</span>\n    isSVG<span>,</span>\n    optimized\n  <span>)</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br></div></div><h3 id=\"setuprendereffect\"> setupRenderEffect</h3>\n<p>创建子节点的 vnode</p>\n<div><pre><code><span>const</span> setupRenderEffect<span>:</span> <span>SetupRenderEffectFn</span> <span>=</span> <span>(</span>\n  instance<span>,</span>\n  initialVNode<span>,</span>\n  container<span>,</span>\n  anchor<span>,</span>\n  parentSuspense<span>,</span>\n  isSVG<span>,</span>\n  optimized\n<span>)</span> <span>=></span> <span>{</span>\n  <span>// Vic 创建更新函数</span>\n  instance<span>.</span>update <span>=</span> <span>effect</span><span>(</span><span>function</span> <span>componentEffect</span><span>(</span><span>)</span> <span>{</span>\n    <span>if</span> <span>(</span><span>!</span>instance<span>.</span>isMounted<span>)</span> <span>{</span>\n      <span>let</span> vnodeHook<span>:</span> VNodeHook <span>|</span> <span>null</span> <span>|</span> <span>undefined</span>\n      <span>const</span> <span>{</span> el<span>,</span> props <span>}</span> <span>=</span> initialVNode\n      <span>const</span> <span>{</span> bm<span>,</span> m<span>,</span> a<span>,</span> parent <span>}</span> <span>=</span> instance\n      \n      <span>// 得到组件中根节点的 vnode (这个节点的 vnode 就是 dom 的 vnode)</span>\n      <span>// 将 render 函数依赖收集了（这里的 render 是 vue 生成的 render，不同于上面提到的 render）</span>\n      <span>/**\n       * renderComponentRoot 里面会创建 child 的 vnode\n      */</span>\n      <span>const</span> subTree <span>=</span>  <span>(</span>instance<span>.</span>subTree <span>=</span> <span>renderComponentRoot</span><span>(</span>instance<span>)</span><span>)</span>\n      \n      <span>// 调用 beforeMount hook</span>\n      <span>if</span> <span>(</span>bm<span>)</span> <span>{</span>\n        <span>invokeArrayFns</span><span>(</span>bm<span>)</span>\n      <span>}</span>\n      \n      <span>// 递归调用 patch，与第一次不同的是 n2 已经不是之前的根组件 vnode，而是根组件里面根元素的 vnode （这一次的 patch 是可以真正执行 appendChild 操作）</span>\n      <span>patch</span><span>(</span>\n        <span>null</span><span>,</span>\n        subTree<span>,</span>\n        container<span>,</span>\n        anchor<span>,</span>\n        instance<span>,</span>\n        parentSuspense<span>,</span>\n        isSVG\n      <span>)</span>\n      initialVNode<span>.</span>el <span>=</span> subTree<span>.</span>el\n\n      <span>// 调用 mounted hook</span>\n      <span>if</span> <span>(</span>m<span>)</span> <span>{</span>\n        <span>queuePostRenderEffect</span><span>(</span>m<span>,</span> parentSuspense<span>)</span>\n      <span>}</span>\n      instance<span>.</span>isMounted <span>=</span> <span>true</span>\n    <span>}</span> <span>else</span> <span>{</span>\n      <span>// 更新逻辑</span>\n    <span>}</span>\n  <span>}</span><span>,</span> __DEV__ <span>?</span> <span>createDevEffectOptions</span><span>(</span>instance<span>)</span> <span>:</span> prodEffectOptions<span>)</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br></div></div><h3 id=\"effect-调用-patch\"> effect 调用 patch</h3>\n<h3 id=\"processelement-n2-为-article-这个节点的-vnode\"> processElement (n2 为 article 这个节点的 vnode)</h3>\n<div><pre><code><span>const</span> <span>processElement</span> <span>=</span> <span>(</span>\n  n1<span>:</span> VNode <span>|</span> <span>null</span><span>,</span>\n  n2<span>:</span> VNode<span>,</span>\n  container<span>:</span> RendererElement<span>,</span>\n  anchor<span>:</span> RendererNode <span>|</span> <span>null</span><span>,</span>\n  parentComponent<span>:</span> ComponentInternalInstance <span>|</span> <span>null</span><span>,</span>\n  parentSuspense<span>:</span> SuspenseBoundary <span>|</span> <span>null</span><span>,</span>\n  isSVG<span>:</span> <span>boolean</span><span>,</span>\n  optimized<span>:</span> <span>boolean</span>\n<span>)</span> <span>=></span> <span>{</span>\n  isSVG <span>=</span> isSVG <span>||</span> <span>(</span>n2<span>.</span><span>type</span> <span><span>as</span></span> <span>string</span><span>)</span> <span>===</span> <span>'svg'</span>\n  <span>if</span> <span>(</span>n1 <span>==</span> <span>null</span><span>)</span> <span>{</span>\n    <span>mountElement</span><span>(</span>\n      n2<span>,</span>\n      container<span>,</span>\n      anchor<span>,</span>\n      parentComponent<span>,</span>\n      parentSuspense<span>,</span>\n      isSVG<span>,</span>\n      optimized\n    <span>)</span>\n  <span>}</span> <span>else</span> <span>{</span>\n    <span>patchElement</span><span>(</span>n1<span>,</span> n2<span>,</span> parentComponent<span>,</span> parentSuspense<span>,</span> isSVG<span>,</span> optimized<span>)</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br></div></div><h3 id=\"mountelement\"> mountElement</h3>\n<p>这里包含递归终止条件，即这个 vnode 的 children 是 text，那就终止。</p>\n<ol>\n<li>重用静态 dom 节点</li>\n<li>根据 vnode 创建 dom</li>\n<li>插入 dom 属性</li>\n<li>调用指令的钩子(beforeMount)</li>\n<li>给 dom 添加 scopeId</li>\n<li>处理 children</li>\n<li>将创建好的 dom 插入到 container</li>\n</ol>\n<div><pre><code><span>const</span> <span>mountElement</span> <span>=</span> <span>(</span>\n  vnode<span>:</span> VNode<span>,</span>\n  container<span>:</span> RendererElement<span>,</span>\n  anchor<span>:</span> RendererNode <span>|</span> <span>null</span><span>,</span>\n  parentComponent<span>:</span> ComponentInternalInstance <span>|</span> <span>null</span><span>,</span>\n  parentSuspense<span>:</span> SuspenseBoundary <span>|</span> <span>null</span><span>,</span>\n  isSVG<span>:</span> <span>boolean</span><span>,</span>\n  optimized<span>:</span> <span>boolean</span>\n<span>)</span> <span>=></span> <span>{</span>\n  <span>let</span> el<span>:</span> RendererElement\n  <span>let</span> vnodeHook<span>:</span> VNodeHook <span>|</span> <span>undefined</span> <span>|</span> <span>null</span>\n  <span>const</span> <span>{</span>\n    <span>type</span><span>,</span>\n    props<span>,</span>\n    shapeFlag<span>,</span>\n    transition<span>,</span>\n    scopeId<span>,</span>\n    patchFlag<span>,</span>\n    dirs\n  <span>}</span> <span>=</span> vnode\n  <span>if</span> <span>(</span>\n    vnode<span>.</span>el <span>&amp;&amp;</span>\n    hostCloneNode <span>!==</span> <span>undefined</span> <span>&amp;&amp;</span>\n    patchFlag <span>===</span> PatchFlags<span>.</span><span>HOISTED</span>\n  <span>)</span> <span>{</span>\n    <span>// 如果是静态节点，那就重用</span>\n    el <span>=</span> vnode<span>.</span>el <span>=</span> <span>hostCloneNode</span><span>(</span>vnode<span>.</span>el<span>)</span>\n  <span>}</span> <span>else</span> <span>{</span>\n    <span>// 这里创建了真实的 dom</span>\n    el <span>=</span> vnode<span>.</span>el <span>=</span> <span>hostCreateElement</span><span>(</span>\n      vnode<span>.</span><span>type</span> <span><span>as</span></span> <span>string</span><span>,</span>\n      isSVG<span>,</span>\n      props <span>&amp;&amp;</span> props<span>.</span><span>is</span>\n    <span>)</span>\n    <span>// props</span>\n    <span>if</span> <span>(</span>props<span>)</span> <span>{</span>\n      <span>for</span> <span>(</span><span>const</span> key <span>in</span> props<span>)</span> <span>{</span>\n        <span>if</span> <span>(</span><span>!</span><span>isReservedProp</span><span>(</span>key<span>)</span><span>)</span> <span>{</span>\n          <span>hostPatchProp</span><span>(</span>el<span>,</span> key<span>,</span> <span>null</span><span>,</span> props<span>[</span>key<span>]</span><span>,</span> isSVG<span>)</span>\n        <span>}</span>\n      <span>}</span>\n      <span>if</span> <span>(</span><span>(</span>vnodeHook <span>=</span> props<span>.</span>onVnodeBeforeMount<span>)</span><span>)</span> <span>{</span>\n        <span>invokeVNodeHook</span><span>(</span>vnodeHook<span>,</span> parentComponent<span>,</span> vnode<span>)</span>\n      <span>}</span>\n    <span>}</span>\n    <span>if</span> <span>(</span>dirs<span>)</span> <span>{</span>\n      <span>invokeDirectiveHook</span><span>(</span>vnode<span>,</span> <span>null</span><span>,</span> parentComponent<span>,</span> <span>'beforeMount'</span><span>)</span>\n    <span>}</span>\n\n    <span>// scopeId</span>\n    <span>if</span> <span>(</span>scopeId<span>)</span> <span>{</span>\n      <span>hostSetScopeId</span><span>(</span>el<span>,</span> scopeId<span>)</span>\n    <span>}</span>\n\n    <span>// 处理 children （container 变成了新创建的 container，这里一定是先把所有的 children 全部挂载之后，最后一次挂载到 mount 中的 container 上）</span>\n    <span>if</span> <span>(</span>shapeFlag <span>&amp;</span> ShapeFlags<span>.</span><span>TEXT_CHILDREN</span><span>)</span> <span>{</span>\n      <span>hostSetElementText</span><span>(</span>el<span>,</span> vnode<span>.</span>children <span>as</span> <span>string</span><span>)</span>\n    <span>}</span> <span>else</span> <span>if</span> <span>(</span>shapeFlag <span>&amp;</span> ShapeFlags<span>.</span><span>ARRAY_CHILDREN</span><span>)</span> <span>{</span>\n      <span>// 这里执行完之后，就在内存中创建了一棵大大的 dom 树</span>\n      <span>mountChildren</span><span>(</span>\n        vnode<span>.</span>children <span>as</span> VNodeArrayChildren<span>,</span>\n        el<span>,</span>\n        <span>null</span><span>,</span>\n        parentComponent<span>,</span>\n        parentSuspense<span>,</span>\n        isSVG <span>&amp;&amp;</span> <span>type</span> <span>!==</span> <span>'foreignObject'</span><span>,</span>\n        optimized <span>||</span> <span>!</span><span>!</span>vnode<span>.</span>dynamicChildren\n      <span>)</span>\n    <span>}</span>\n  <span>}</span>\n  <span>// 这里开始作dom插入</span>\n  <span>hostInsert</span><span>(</span>el<span>,</span> container<span>,</span> anchor<span>)</span>\n  <span>if</span> <span>(</span>\n    <span>(</span>vnodeHook <span>=</span> props <span>&amp;&amp;</span> props<span>.</span>onVnodeMounted<span>)</span> <span>||</span> dirs\n  <span>)</span> <span>{</span>\n    <span>queuePostRenderEffect</span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>{</span>\n      vnodeHook <span>&amp;&amp;</span> <span>invokeVNodeHook</span><span>(</span>vnodeHook<span>,</span> parentComponent<span>,</span> vnode<span>)</span>\n      dirs <span>&amp;&amp;</span> <span>invokeDirectiveHook</span><span>(</span>vnode<span>,</span> <span>null</span><span>,</span> parentComponent<span>,</span> <span>'mounted'</span><span>)</span>\n    <span>}</span><span>,</span> parentSuspense<span>)</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br></div></div><h4 id=\"mountchildren\"> mountChildren</h4>\n<p>递归调用 patch</p>\n<div><pre><code><span>const</span> mountChildren<span>:</span> <span>MountChildrenFn</span> <span>=</span> <span>(</span>\n  children<span>,</span>\n  container<span>,</span>\n  start <span>=</span> <span>0</span>\n<span>)</span> <span>=></span> <span>{</span>\n  <span>for</span> <span>(</span><span>let</span> i <span>=</span> start<span>;</span> i <span>&lt;</span> children<span>.</span>length<span>;</span> i<span>++</span><span>)</span> <span>{</span>\n    <span>const</span> child <span>=</span> <span>(</span>children<span>[</span>i<span>]</span> <span>=</span> optimized\n      <span>?</span> <span>cloneIfMounted</span><span>(</span>children<span>[</span>i<span>]</span> <span>as</span> VNode<span>)</span>\n      <span>:</span> <span>normalizeVNode</span><span>(</span>children<span>[</span>i<span>]</span><span>)</span><span>)</span>\n    <span>patch</span><span>(</span>\n      <span>null</span><span>,</span>\n      child<span>,</span>\n      container<span>,</span>\n    <span>)</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div>",
      "image": "https://x-vic.gitee.io/code/code/code/images/patch.svg",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "effect",
      "url": "https://x-vic.gitee.io/code/code/views/vue-next/effect/",
      "id": "https://x-vic.gitee.io/code/code/views/vue-next/effect/",
      "content_html": "<p>vue-next 中的依赖收集通过显式调用它提供的<code>effect</code>方法来启动。</p>\n<h2 id=\"usage\"> usage</h2>\n<div><pre><code><span>const</span> <span>{</span> reactive<span>,</span> effect <span>}</span> <span>from</span> 'vue\n\n<span>const</span> obj <span>=</span> <span>reactive</span><span>(</span><span>{</span> foo<span>:</span> <span>0</span> <span>}</span><span>)</span>\n<span>effect</span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>{</span>\n  <span>console</span><span>.</span><span>log</span><span>(</span>obj<span>.</span>foo<span>)</span>\n<span>}</span><span>)</span>\n<span>// output 0</span>\nobj<span>.</span>foo<span>++</span>\n<span>// output 1</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br></div></div><h2 id=\"effect-函数\"> effect 函数</h2>\n<p>主要做两件事：1. 包装 fn 生成 Effect；2. 调用 Effect 的 run 方法</p>\n<div><div><br><br><br><br><br><br><br><br><br><div>&nbsp;</div><br><br><div>&nbsp;</div><br><br><br><br></div><pre><code><span>function</span> <span><span>effect</span><span><span>&lt;</span><span>T</span> <span>=</span> <span>any</span><span>></span></span></span><span>(</span>\n  <span>fn</span><span>:</span> <span>(</span><span>)</span> <span>=></span> <span>T</span><span>,</span>\n  options<span>:</span> ReactiveEffectOptions <span>=</span> <span>EMPTY_OBJ</span>\n<span>)</span><span>:</span> ReactiveEffect<span>&lt;</span><span>T</span><span>></span> <span>{</span>\n  <span>// 如果传入的函数已经是一个 Effect 对象</span>\n  <span>if</span> <span>(</span><span>isEffect</span><span>(</span>fn<span>)</span><span>)</span> <span>{</span>\n    fn <span>=</span> fn<span>.</span>raw\n  <span>}</span>\n  <span>// 包装原始函数，生成 Effect 对象（实际上就是在 fn 上面个添加一些静态属性）</span>\n  <span>const</span> effect <span>=</span> <span>createReactiveEffect</span><span>(</span>fn<span>,</span> options<span>)</span>\n  <span>if</span> <span>(</span><span>!</span>options<span>.</span>lazy<span>)</span> <span>{</span>\n    <span>// 这一步真正调用传入的函数，触发了 getter</span>\n    <span>effect</span><span>(</span><span>)</span>\n  <span>}</span>\n  <span>return</span> effect\n<span>}</span>\n</code></pre><div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><h2 id=\"createreactiveeffect\"> createReactiveEffect</h2>\n<p>创建 <code>effect</code> 函数，往 <code>effect</code> 上面加上一些静态属性</p>\n<div><pre><code><span>function</span> <span><span>createReactiveEffect</span><span><span>&lt;</span><span>T</span> <span>=</span> <span>any</span><span>></span></span></span><span>(</span>\n  <span>fn</span><span>:</span> <span>(</span><span>)</span> <span>=></span> <span>T</span><span>,</span>\n  options<span>:</span> ReactiveEffectOptions\n<span>)</span><span>:</span> ReactiveEffect<span>&lt;</span><span>T</span><span>></span> <span>{</span>\n  <span>// 依赖收集过程中 args 是没有的</span>\n  <span>// 但是用户是可以拿到返回出去的 effect 进而手动调用，传入参数</span>\n  <span>const</span> <span>effect</span> <span>=</span> <span>function</span> <span>reactiveEffect</span><span>(</span><span>...</span>args<span>:</span> <span>unknown</span><span>[</span><span>]</span><span>)</span><span>:</span> <span>unknown</span> <span>{</span>\n    <span>return</span> <span>run</span><span>(</span>effect<span>,</span> fn<span>,</span> args<span>)</span>\n  <span>}</span> <span>as</span> ReactiveEffect\n  effect<span>.</span>_isEffect <span>=</span> <span>true</span>\n  effect<span>.</span>active <span>=</span> <span>true</span>\n  effect<span>.</span>raw <span>=</span> fn\n  <span>// effect函数中依赖的数据列表（响应数据中也会有一份 effects 的引用。它们是属于多对多的关系）</span>\n  effect<span>.</span>deps <span>=</span> <span>[</span><span>]</span>\n  effect<span>.</span>options <span>=</span> options\n  <span>return</span> effect\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br></div></div><h2 id=\"run\"> run</h2>\n<ol>\n<li>只有当 <code>effect</code> 中调用的 <code>fn</code> 才会触发依赖追踪（手动调用 <code>effect</code> 返回的函数以及 <code>setter</code> 触发的调用都不进行依赖收集）</li>\n<li>保存 <code>effect</code> <code>引用（track</code> 是需要用到）</li>\n<li>调用 <code>fn</code> 触发 <code>getter</code></li>\n</ol>\n<div><div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div>&nbsp;</div><br><div>&nbsp;</div><br><br><br><br><br><br><br><br></div><pre><code><span>function</span> <span>run</span><span>(</span>effect<span>:</span> ReactiveEffect<span>,</span> fn<span>:</span> <span>Function</span><span>,</span> args<span>:</span> <span>unknown</span><span>[</span><span>]</span><span>)</span><span>:</span> <span>unknown</span> <span>{</span>\n  <span>// 使用 effect(Function) 收集依赖时（effect.active === true）才会继续</span>\n  <span>// 下面条件在 fn = effect(Function); fn() 下会为真</span>\n  <span>if</span> <span>(</span><span>!</span>effect<span>.</span>active<span>)</span> <span>{</span>\n    <span>return</span> <span>fn</span><span>(</span><span>...</span>args<span>)</span>\n  <span>}</span>\n  <span>if</span> <span>(</span><span>!</span>effectStack<span>.</span><span>includes</span><span>(</span>effect<span>)</span><span>)</span> <span>{</span>\n    <span>// 清空 effect.deps 中的响应式数据</span>\n    <span>cleanup</span><span>(</span>effect<span>)</span>\n    <span>try</span> <span>{</span>\n      <span>enableTracking</span><span>(</span><span>)</span>\n      effectStack<span>.</span><span>push</span><span>(</span>effect<span>)</span>\n      <span>// 这一步引用指向很重要，因为在真正进行 track 的时候，</span>\n      <span>// 需要将 activeEffect 添加到响应式数据的 effects 列表中，</span>\n      <span>// 最后在 setter 被触发之后，挨个儿调用 effect</span>\n      activeEffect <span>=</span> effect\n      <span>// 在这里触发了 getter，进而开始 track</span>\n      <span>return</span> <span>fn</span><span>(</span><span>...</span>args<span>)</span>\n    <span>}</span> <span>finally</span> <span>{</span>\n      effectStack<span>.</span><span>pop</span><span>(</span><span>)</span>\n      <span>resetTracking</span><span>(</span><span>)</span>\n      activeEffect <span>=</span> effectStack<span>[</span>effectStack<span>.</span>length <span>-</span> <span>1</span><span>]</span>\n    <span>}</span>\n  <span>}</span>\n<span>}</span>\n</code></pre><div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br></div></div><h2 id=\"track-依赖追踪\"> track 依赖追踪</h2>\n<ol>\n<li>找依赖的响应对象</li>\n<li>找响应对象的键对应的依赖列表</li>\n<li><code>activeEffect.deps</code> 中添加 <code>Set&lt;Effect&gt;</code></li>\n</ol>\n<div><div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div>&nbsp;</div><div>&nbsp;</div><br><br><br><br><br><br><br><br><br><br><br><br></div><pre><code><span>function</span> <span>track</span><span>(</span>target<span>:</span> object<span>,</span> <span>type</span><span>:</span> TrackOpTypes<span>,</span> key<span>:</span> <span>unknown</span><span>)</span> <span>{</span>\n  <span>if</span> <span>(</span><span>!</span>shouldTrack <span>||</span> activeEffect <span>===</span> <span>undefined</span><span>)</span> <span>{</span>\n    <span>return</span>\n  <span>}</span>\n  <span>let</span> depsMap <span>=</span> targetMap<span>.</span><span>get</span><span>(</span>target<span>)</span>\n  <span>if</span> <span>(</span>depsMap <span>===</span> <span>void</span> <span>0</span><span>)</span> <span>{</span>\n    targetMap<span>.</span><span>set</span><span>(</span>target<span>,</span> <span>(</span>depsMap <span>=</span> <span>new</span> <span>Map</span><span>(</span><span>)</span><span>)</span><span>)</span>\n  <span>}</span>\n  <span>let</span> dep <span>=</span> depsMap<span>.</span><span>get</span><span>(</span>key<span>)</span>\n  <span>if</span> <span>(</span>dep <span>===</span> <span>void</span> <span>0</span><span>)</span> <span>{</span>\n    depsMap<span>.</span><span>set</span><span>(</span>key<span>,</span> <span>(</span>dep <span>=</span> <span>new</span> <span>Set</span><span>(</span><span>)</span><span>)</span><span>)</span>\n  <span>}</span>\n  <span>if</span> <span>(</span><span>!</span>dep<span>.</span><span>has</span><span>(</span>activeEffect<span>)</span><span>)</span> <span>{</span>\n    <span>// 将 activeEffect 添加进依赖列表</span>\n    dep<span>.</span><span>add</span><span>(</span>activeEffect<span>)</span>\n    activeEffect<span>.</span>deps<span>.</span><span>push</span><span>(</span>dep<span>)</span>\n    <span>if</span> <span>(</span>__DEV__ <span>&amp;&amp;</span> activeEffect<span>.</span>options<span>.</span>onTrack<span>)</span> <span>{</span>\n      <span>// 触发 onTrack 钩子函数</span>\n      activeEffect<span>.</span>options<span>.</span><span>onTrack</span><span>(</span><span>{</span>\n        effect<span>:</span> activeEffect<span>,</span>\n        target<span>,</span>\n        <span>type</span><span>,</span>\n        key\n      <span>}</span><span>)</span>\n    <span>}</span>\n  <span>}</span>\n<span>}</span>\n</code></pre><div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br></div></div><h2 id=\"响应式数据改变后-通知-effect\"> 响应式数据改变后，通知 effect</h2>\n<p><a href=\"./handler.html#createSetter\">setter 解析</a></p>\n<h2 id=\"trigger\"> trigger</h2>\n<ol>\n<li>根据 <code>target</code> 从 <code>targetMap</code> 中获取 <code>depsMap</code></li>\n<li>根据 <code>key</code> 从 <code>depsMap</code> 中得到 <code>effects</code></li>\n<li>将 <code>effects</code> 分发到内部的 <code>effects</code> 和 <code>computedRunners</code> 中</li>\n<li>遍历调用内部 <code>effects</code> 和 <code>computedRunners</code> 中的 <code>effect</code></li>\n</ol>\n<div><pre><code><span>export</span> <span>function</span> <span>trigger</span><span>(</span>\n  target<span>:</span> object<span>,</span>\n  <span>type</span><span>:</span> TriggerOpTypes<span>,</span>\n  key<span>?</span><span>:</span> <span>unknown</span><span>,</span>\n  newValue<span>?</span><span>:</span> <span>unknown</span><span>,</span>\n  oldValue<span>?</span><span>:</span> <span>unknown</span><span>,</span>\n  oldTarget<span>?</span><span>:</span> Map<span>&lt;</span><span>unknown</span><span>,</span> <span>unknown</span><span>></span> <span>|</span> Set<span>&lt;</span><span>unknown</span><span>></span>\n<span>)</span> <span>{</span>\n  <span>const</span> depsMap <span>=</span> targetMap<span>.</span><span>get</span><span>(</span>target<span>)</span>\n  <span>if</span> <span>(</span>depsMap <span>===</span> <span>void</span> <span>0</span><span>)</span> <span>{</span>\n    <span>// never been tracked</span>\n    <span>return</span>\n  <span>}</span>\n  <span>const</span> effects <span>=</span> <span>new</span> <span>Set<span>&lt;</span>ReactiveEffect<span>></span></span><span>(</span><span>)</span>\n  <span>const</span> computedRunners <span>=</span> <span>new</span> <span>Set<span>&lt;</span>ReactiveEffect<span>></span></span><span>(</span><span>)</span>\n  <span>if</span> <span>(</span><span>type</span> <span>===</span> TriggerOpTypes<span>.</span><span>CLEAR</span><span>)</span> <span>{</span>\n    <span>// collection being cleared</span>\n    <span>// trigger all effects for target</span>\n    <span>// Map 对象是由 forEach 方法的 map.forEach((value, key, map) => { ... })</span>\n    depsMap<span>.</span><span>forEach</span><span>(</span>dep <span>=></span> <span>{</span>\n      <span>addRunners</span><span>(</span>effects<span>,</span> computedRunners<span>,</span> dep<span>)</span>\n    <span>}</span><span>)</span>\n  <span>}</span> <span>else</span> <span>if</span> <span>(</span>key <span>===</span> <span>'length'</span> <span>&amp;&amp;</span> <span>isArray</span><span>(</span>target<span>)</span><span>)</span> <span>{</span>\n    depsMap<span>.</span><span>forEach</span><span>(</span><span>(</span>dep<span>,</span> key<span>)</span> <span>=></span> <span>{</span>\n      <span>if</span> <span>(</span>key <span>===</span> <span>'length'</span> <span>||</span> key <span>>=</span> <span>(</span>newValue <span>as</span> <span>number</span><span>)</span><span>)</span> <span>{</span>\n        <span>addRunners</span><span>(</span>effects<span>,</span> computedRunners<span>,</span> dep<span>)</span>\n      <span>}</span>\n    <span>}</span><span>)</span>\n  <span>}</span> <span>else</span> <span>{</span>\n    <span>// schedule runs for SET | ADD | DELETE</span>\n    <span>if</span> <span>(</span>key <span>!==</span> <span>void</span> <span>0</span><span>)</span> <span>{</span>\n      <span>addRunners</span><span>(</span>effects<span>,</span> computedRunners<span>,</span> depsMap<span>.</span><span>get</span><span>(</span>key<span>)</span><span>)</span>\n    <span>}</span>\n    <span>// also run for iteration key on ADD | DELETE | Map.SET</span>\n    <span>if</span> <span>(</span>\n      <span>type</span> <span>===</span> TriggerOpTypes<span>.</span><span>ADD</span> <span>||</span>\n      <span>type</span> <span>===</span> TriggerOpTypes<span>.</span><span>DELETE</span> <span>||</span>\n      <span>(</span><span>type</span> <span>===</span> TriggerOpTypes<span>.</span><span>SET</span> <span>&amp;&amp;</span> target <span>instanceof</span> <span>Map</span><span>)</span>\n    <span>)</span> <span>{</span>\n      <span>const</span> iterationKey <span>=</span> <span>isArray</span><span>(</span>target<span>)</span> <span>?</span> <span>'length'</span> <span>:</span> <span>ITERATE_KEY</span>\n      <span>addRunners</span><span>(</span>effects<span>,</span> computedRunners<span>,</span> depsMap<span>.</span><span>get</span><span>(</span>iterationKey<span>)</span><span>)</span>\n    <span>}</span>\n  <span>}</span>\n  <span>const</span> <span>run</span> <span>=</span> <span>(</span>effect<span>:</span> ReactiveEffect<span>)</span> <span>=></span> <span>{</span>\n    <span>scheduleRun</span><span>(</span>\n      effect<span>,</span>\n      target<span>,</span>\n      <span>type</span><span>,</span>\n      key<span>,</span>\n      __DEV__\n        <span>?</span> <span>{</span>\n            newValue<span>,</span>\n            oldValue<span>,</span>\n            oldTarget\n          <span>}</span>\n        <span>:</span> <span>undefined</span>\n    <span>)</span>\n  <span>}</span>\n  <span>// Important: computed effects must be run first so that computed getters</span>\n  <span>// can be invalidated before any normal effects that depend on them are run.</span>\n  computedRunners<span>.</span><span>forEach</span><span>(</span>run<span>)</span>\n  effects<span>.</span><span>forEach</span><span>(</span>run<span>)</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br></div></div><details><summary>查看addRunners函数细节</summary>\n<p>一个在 <code>effect</code> 中使用的对象可能既是响应式对象，又是某计算属性依赖的对象。\n此时要将这二者对应的 <code>effect</code> 区分开来（触发时，先触发计算 <code>effect</code>）</p>\n<div><pre><code><span>function</span> <span>addRunners</span><span>(</span>\n  effects<span>:</span> Set<span>&lt;</span>ReactiveEffect<span>></span><span>,</span>\n  computedRunners<span>:</span> Set<span>&lt;</span>ReactiveEffect<span>></span><span>,</span>\n  effectsToAdd<span>:</span> Set<span>&lt;</span>ReactiveEffect<span>></span> <span>|</span> <span>undefined</span>\n<span>)</span> <span>{</span>\n  <span>if</span> <span>(</span>effectsToAdd <span>!==</span> <span>void</span> <span>0</span><span>)</span> <span>{</span>\n    effectsToAdd<span>.</span><span>forEach</span><span>(</span>effect <span>=></span> <span>{</span>\n      <span>if</span> <span>(</span>effect <span>!==</span> activeEffect<span>)</span> <span>{</span>\n        <span>if</span> <span>(</span>effect<span>.</span>options<span>.</span>computed<span>)</span> <span>{</span>\n          computedRunners<span>.</span><span>add</span><span>(</span>effect<span>)</span>\n        <span>}</span> <span>else</span> <span>{</span>\n          effects<span>.</span><span>add</span><span>(</span>effect<span>)</span>\n        <span>}</span>\n      <span>}</span> <span>else</span> <span>{</span>\n        <span>// the effect mutated its own dependency during its execution.</span>\n        <span>// this can be caused by operations like foo.value++</span>\n        <span>// do not trigger or we end in an infinite loop</span>\n      <span>}</span>\n    <span>}</span><span>)</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br></div></div></details>\n<h2 id=\"schedulerun\"> scheduleRun</h2>\n<p>最终调用 <code>effect</code> 的逻辑</p>\n<div><pre><code><span>function</span> <span>scheduleRun</span><span>(</span>\n  effect<span>:</span> ReactiveEffect<span>,</span>\n  target<span>:</span> object<span>,</span>\n  <span>type</span><span>:</span> TriggerOpTypes<span>,</span>\n  key<span>:</span> <span>unknown</span><span>,</span>\n  extraInfo<span>?</span><span>:</span> DebuggerEventExtraInfo\n<span>)</span> <span>{</span>\n  <span>if</span> <span>(</span>effect<span>.</span>options<span>.</span>scheduler <span>!==</span> <span>void</span> <span>0</span><span>)</span> <span>{</span>\n    effect<span>.</span>options<span>.</span><span>scheduler</span><span>(</span>effect<span>)</span>\n  <span>}</span> <span>else</span> <span>{</span>\n    <span>effect</span><span>(</span><span>)</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "handlers",
      "url": "https://x-vic.gitee.io/code/code/views/vue-next/handler/",
      "id": "https://x-vic.gitee.io/code/code/views/vue-next/handler/",
      "content_html": "<h2 id=\"mutablehandlers-常规对象使用的-handler\"> mutableHandlers 常规对象使用的 handler</h2>\n<h3 id=\"creategetter\"> createGetter</h3>\n<p><code>Reflect</code>将一些明显属于语言内部的方法(Object.defineProperty)，放到 Reflect 中，作为它的静态方法。</p>\n<ol>\n<li>target 是数组，并且有调用的数组的<code>includes</code>, <code>indexOf</code>, <code>lastIndexOf</code>方法时，提前返回结果</li>\n<li>通过<code>Reflect</code>回到将要返回的值</li>\n<li>判断键是否为<code>Symbol</code>，如果是，提前返回结果</li>\n<li>判断是否浅包装（只代理第一层属性）</li>\n<li>判断是否为<code>Ref</code>对象，如果是，返回<code>ref.value</code></li>\n<li><code>track</code>依赖追踪（收集）</li>\n<li>递归进行响应式代理</li>\n</ol>\n<div><pre><code><span>function</span> <span>createGetter</span><span>(</span>isReadonly <span>=</span> <span>false</span><span>,</span> shallow <span>=</span> <span>false</span><span>)</span> <span>{</span>\n  <span>return</span> <span>function</span> <span>get</span><span>(</span>target<span>:</span> object<span>,</span> key<span>:</span> <span>string</span> <span>|</span> <span>symbol</span><span>,</span> receiver<span>:</span> object<span>)</span> <span>{</span>\n    <span>if</span> <span>(</span><span>isArray</span><span>(</span>target<span>)</span> <span>&amp;&amp;</span> <span>hasOwn</span><span>(</span>arrayInstrumentations<span>,</span> key<span>)</span><span>)</span> <span>{</span>\n      <span>return</span> Reflect<span>.</span><span>get</span><span>(</span>arrayInstrumentations<span>,</span> key<span>,</span> receiver<span>)</span>\n    <span>}</span>\n    <span>// receiver： 在读取属性中遇到 this 的访问，则将 this 指向 传入的 receiver</span>\n    <span>const</span> res <span>=</span> Reflect<span>.</span><span>get</span><span>(</span>target<span>,</span> key<span>,</span> receiver<span>)</span>\n    <span>if</span> <span>(</span><span>isSymbol</span><span>(</span>key<span>)</span> <span>&amp;&amp;</span> builtInSymbols<span>.</span><span>has</span><span>(</span>key<span>)</span><span>)</span> <span>{</span>\n      <span>return</span> res\n    <span>}</span>\n    <span>if</span> <span>(</span>shallow<span>)</span> <span>{</span>\n      <span>track</span><span>(</span>target<span>,</span> TrackOpTypes<span>.</span><span>GET</span><span>,</span> key<span>)</span>\n      <span>return</span> res\n    <span>}</span>\n    <span>if</span> <span>(</span><span>isRef</span><span>(</span>res<span>)</span> <span>&amp;&amp;</span> <span>!</span><span>isArray</span><span>(</span>target<span>)</span><span>)</span> <span>{</span>\n      <span>return</span> res<span>.</span>value\n    <span>}</span>\n    <span>track</span><span>(</span>target<span>,</span> TrackOpTypes<span>.</span><span>GET</span><span>,</span> key<span>)</span>\n    <span>return</span> <span>isObject</span><span>(</span>res<span>)</span>\n      <span>?</span> isReadonly\n        <span>?</span> <span>readonly</span><span>(</span>res<span>)</span>\n        <span>:</span> <span>reactive</span><span>(</span>res<span>)</span>\n      <span>:</span> res\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br></div></div><h3 id=\"createsetter\"> createSetter</h3>\n<ol>\n<li>通过 <code>Reflect.set</code> 修改属性值</li>\n<li>调用 <code>trigger</code></li>\n</ol>\n<div><div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div>&nbsp;</div><br><div>&nbsp;</div><br><br><br><br><br><br></div><pre><code><span>function</span> <span>createSetter</span><span>(</span>isReadonly <span>=</span> <span>false</span><span>,</span> shallow <span>=</span> <span>false</span><span>)</span> <span>{</span>\n  <span>return</span> <span>function</span> <span>set</span><span>(</span>\n    target<span>:</span> object<span>,</span>\n    key<span>:</span> <span>string</span> <span>|</span> <span>symbol</span><span>,</span>\n    value<span>:</span> <span>unknown</span><span>,</span>\n    receiver<span>:</span> object\n  <span>)</span><span>:</span> <span>boolean</span> <span>{</span>\n    <span>// ...开发环境下警告不允许修改 readOnly 数据</span>\n\n    <span>const</span> oldValue <span>=</span> <span>(</span>target <span>as</span> <span>any</span><span>)</span><span>[</span>key<span>]</span>\n    <span>if</span> <span>(</span><span>!</span>shallow<span>)</span> <span>{</span>\n      value <span>=</span> <span>toRaw</span><span>(</span>value<span>)</span>\n      <span>// 如果修改的属性是一个 Ref 对象，则自动展开 ref 的 value 属性，修改其 value 值</span>\n      <span>if</span> <span>(</span><span>!</span><span>isArray</span><span>(</span>target<span>)</span> <span>&amp;&amp;</span> <span>isRef</span><span>(</span>oldValue<span>)</span> <span>&amp;&amp;</span> <span>!</span><span>isRef</span><span>(</span>value<span>)</span><span>)</span> <span>{</span>\n        oldValue<span>.</span>value <span>=</span> value\n        <span>return</span> <span>true</span>\n      <span>}</span>\n    <span>}</span> <span>else</span> <span>{</span>\n      <span>// in shallow mode, objects are set as-is regardless of reactive or not</span>\n    <span>}</span>\n\n    <span>const</span> hadKey <span>=</span> <span>hasOwn</span><span>(</span>target<span>,</span> key<span>)</span>\n    <span>const</span> result <span>=</span> Reflect<span>.</span><span>set</span><span>(</span>target<span>,</span> key<span>,</span> value<span>,</span> receiver<span>)</span>\n    <span>// don't trigger if target is something up in the prototype chain of original</span>\n    <span>if</span> <span>(</span>target <span>===</span> <span>toRaw</span><span>(</span>receiver<span>)</span><span>)</span> <span>{</span>\n      <span>if</span> <span>(</span><span>!</span>hadKey<span>)</span> <span>{</span>\n        <span>trigger</span><span>(</span>target<span>,</span> TriggerOpTypes<span>.</span><span>ADD</span><span>,</span> key<span>,</span> value<span>)</span>\n      <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>hasChanged</span><span>(</span>value<span>,</span> oldValue<span>)</span><span>)</span> <span>{</span>\n        <span>trigger</span><span>(</span>target<span>,</span> TriggerOpTypes<span>.</span><span>SET</span><span>,</span> key<span>,</span> value<span>,</span> oldValue<span>)</span>\n      <span>}</span>\n    <span>}</span>\n    <span>return</span> result\n  <span>}</span>\n<span>}</span>\n</code></pre><div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br></div></div>",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    },
    {
      "title": "reactive",
      "url": "https://x-vic.gitee.io/code/code/views/vue-next/reactive/",
      "id": "https://x-vic.gitee.io/code/code/views/vue-next/reactive/",
      "content_html": "<h2 id=\"usage\"> usage</h2>\n<div><pre><code><span>import</span> <span>{</span> reactive <span>}</span> <span>from</span> <span>'vue'</span>\n\n<span>const</span> obj <span>=</span> <span>reactive</span><span>(</span><span>{</span> foo<span>:</span> <span>0</span> <span>}</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br></div></div><h2 id=\"reactive-函数\"> reactive 函数</h2>\n<p>该函数主要做一些对参数的判断，主要逻辑交由<code>createReactiveObject</code>函数来做</p>\n<div><pre><code><span>export</span> <span>function</span> <span><span>reactive</span><span><span>&lt;</span><span>T</span> <span>extends</span> object<span>></span></span></span><span>(</span>target<span>:</span> <span>T</span><span>)</span><span>:</span> UnwrapNestedRefs<span>&lt;</span><span>T</span><span>></span>\n<span>export</span> <span>function</span> <span>reactive</span><span>(</span>target<span>:</span> object<span>)</span> <span>{</span>\n  <span>// ... 判断是否为 readonly、 ref，如果是则提前返回  </span>\n  <span>return</span> <span>createReactiveObject</span><span>(</span>\n    target<span>,</span>\n    rawToReactive<span>,</span>\n    reactiveToRaw<span>,</span>\n    mutableHandlers<span>,</span>\n    mutableCollectionHandlers\n  <span>)</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><h2 id=\"createreactiveobject\"> createReactiveObject</h2>\n<ol>\n<li>判断 target 是否已被代理、已经是一个 Proxy 对象、是否在被代理的白名单中（如：VNode...）</li>\n<li>判断是普通对象还是 Set, Map, WeakMap, WeakSet，从而选择不同的 handler</li>\n<li>保存 target -&gt; observed</li>\n<li>保存 observed -&gt; target</li>\n</ol>\n<div><pre><code><span>function</span> <span>createReactiveObject</span><span>(</span>\n  target<span>:</span> <span>unknown</span><span>,</span>\n  toProxy<span>:</span> WeakMap<span>&lt;</span><span>any</span><span>,</span> <span>any</span><span>></span><span>,</span>\n  toRaw<span>:</span> WeakMap<span>&lt;</span><span>any</span><span>,</span> <span>any</span><span>></span><span>,</span>\n  baseHandlers<span>:</span> ProxyHandler<span>&lt;</span><span>any</span><span>></span><span>,</span>\n  collectionHandlers<span>:</span> ProxyHandler<span>&lt;</span><span>any</span><span>></span>\n<span>)</span> <span>{</span>\n  <span>// ...判断 target 是否已被代理、已经是一个 Proxy 对象、是否在被代理的白名单中（如：VNode...）</span>\n  <span>const</span> handlers <span>=</span> collectionTypes<span>.</span><span>has</span><span>(</span>target<span>.</span><span>constructor</span><span>)</span>\n    <span>?</span> collectionHandlers\n    <span>:</span> baseHandlers\n  observed <span>=</span> <span>new</span> <span>Proxy</span><span>(</span>target<span>,</span> handlers<span>)</span>\n  toProxy<span>.</span><span>set</span><span>(</span>target<span>,</span> observed<span>)</span>\n  toRaw<span>.</span><span>set</span><span>(</span>observed<span>,</span> target<span>)</span>\n  <span>return</span> observed\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><h2 id=\"推荐阅读\"> 推荐阅读</h2>\n<p><a href=\"./handler.html#createGetter\">getter 解析</a> </p>\n",
      "date_published": "2021-05-17T07:24:02.000Z",
      "date_modified": "2021-05-17T07:24:02.000Z",
      "authors": [
        {
          "name": "Vic"
        }
      ],
      "tags": []
    }
  ]
}